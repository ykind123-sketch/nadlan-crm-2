<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×“×œ"×Ÿ PRO 21.0 - ×”×’×¨×¡×” ×”×¢×•×‘×“×ª</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1e293b; --accent: #2563eb; --bg: #f8fafc; --surface: #ffffff; 
            --border: #e2e8f0; --text: #0f172a; --danger: #dc2626; --success: #16a34a;
        }
        * { box-sizing: border-box; font-family: 'Rubik', sans-serif; outline: none; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Login */
        #loginOverlay { position: fixed; inset: 0; background: linear-gradient(135deg, var(--primary), #000); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 100%; max-width: 350px; text-align: center; }
        .inp { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border); border-radius: 6px; }
        .btn-login { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* Layout */
        .layout { display: flex; height: 100%; }
        aside { width: 250px; background: var(--primary); color: white; display: flex; flex-direction: column; }
        .brand { padding: 20px; text-align: center; background: rgba(255,255,255,0.05); font-size: 20px; font-weight: bold; }
        .nav { flex: 1; padding: 20px; }
        .nav-item { padding: 12px; cursor: pointer; display: flex; gap: 10px; align-items: center; color: #cbd5e1; border-radius: 6px; margin-bottom: 5px; }
        .nav-item:hover, .nav-item.active { background: var(--accent); color: white; }
        .user-panel { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }

        main { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        .page { display: none; }
        .active-page { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* Components */
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid var(--border); margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-white { background: white; border: 1px solid var(--border); color: var(--text); }
        
        /* Table */
        .table-wrap { background: white; border-radius: 10px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; height: calc(100vh - 150px); }
        .toolbar { padding: 15px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; background: #f8fafc; align-items: center; }
        .table-scroll { overflow: auto; flex: 1; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { text-align: right; padding: 12px; background: #f1f5f9; position: sticky; top: 0; font-size: 13px; color: #64748b; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 13px; }
        tr:hover { background: #f8fafc; }
        .blocked { background: #fee2e2 !important; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: white; width: 90%; max-width: 1000px; border-radius: 12px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .modal-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-foot { padding: 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: #f8fafc; border-radius: 0 0 12px 12px; }

        /* Tabs */
        .tabs { display: flex; gap: 15px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .tab { padding: 10px 15px; cursor: pointer; border-bottom: 3px solid transparent; color: #64748b; }
        .tab.active { border-color: var(--accent); color: var(--accent); font-weight: bold; background: #eff6ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Helpers */
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 10px; font-size: 14px; }
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; }
        .admin-only { display: none !important; }
        .col-menu { position: absolute; top: 60px; left: 20px; background: white; border: 1px solid var(--border); padding: 10px; z-index: 50; display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2>ğŸ¢ ×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
            <input id="txtEmail" class="inp" placeholder="××™××™×™×œ">
            <input id="txtPass" type="password" class="inp" placeholder="×¡×™×¡××”">
            <button class="btn-login" onclick="login()">×”×ª×—×‘×¨</button>
            <div id="loginError" style="color:red; margin-top:10px;"></div>
        </div>
    </div>

    <div id="mainApp" style="display:none;">
        <div class="layout">
            <aside>
                <div class="brand">× ×“×œ"×Ÿ PRO V21</div>
                <div class="nav">
                    <div class="nav-item active" onclick="nav('dashboard')"><i class="fa-solid fa-chart-pie"></i> ×“×©×‘×•×¨×“</div>
                    <div class="nav-item" onclick="nav('crm')"><i class="fa-solid fa-users"></i> ×œ×§×•×—×•×ª</div>
                    <div class="nav-item" onclick="nav('calendar')"><i class="fa-solid fa-calendar"></i> ×™×•××Ÿ</div>
                    <div class="nav-item" onclick="nav('projects')"><i class="fa-solid fa-building"></i> ×¤×¨×•×™×§×˜×™×</div>
                    <div class="nav-item" onclick="nav('settings')"><i class="fa-solid fa-cog"></i> ×”×’×“×¨×•×ª</div>
                </div>
                <div class="user-panel">
                    <span id="lblUser">××•×¨×—</span>
                    <i class="fa-solid fa-power-off" style="cursor:pointer" onclick="logout()"></i>
                </div>
            </aside>

            <main>
                <div id="dashboard" class="page active-page">
                    <h1>×“×©×‘×•×¨×“ ×× ×”×œ×™×</h1>
                    <div class="grid-3">
                        <div class="card">
                            <h2 id="stTotal">0</h2>
                            <small>×œ×§×•×—×•×ª ×‘×××’×¨</small>
                        </div>
                        <div class="card">
                            <h2 id="stActive">0</h2>
                            <small>×‘×˜×™×¤×•×œ ×¤×¢×™×œ</small>
                        </div>
                        <div class="card">
                            <h2 id="stDeals">0</h2>
                            <small>×—×•×–×™× ×”×—×•×“×©</small>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div class="card">
                            <h3>××§×•×¨×•×ª ×”×’×¢×” (×™×©×™×‘×•×ª)</h3>
                            <canvas id="chartSources"></canvas>
                        </div>
                        <div class="card">
                            <h3>×¢×¨×™× ××•×‘×™×œ×•×ª</h3>
                            <canvas id="chartCities"></canvas>
                        </div>
                    </div>
                </div>

                <div id="crm" class="page">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <h1>×××’×¨ ×”×œ×§×•×—×•×ª</h1>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-white" onclick="document.getElementById('excelIn').click()">ğŸ“¥ ×™×™×‘×•× ××§×¡×œ</button>
                            <input type="file" id="excelIn" hidden>
                            <button class="btn btn-white admin-only" onclick="exportExcel()">ğŸ“¤ ×™×™×¦×•×</button>
                            <button class="btn btn-primary" onclick="openClientModal()">+ ×—×“×©</button>
                        </div>
                    </div>

                    <div class="table-wrap">
                        <div class="toolbar">
                            <input id="searchBox" onkeyup="renderTable()" placeholder="×—×™×¤×•×© ×—×›× (×©×, ×˜×œ×¤×•×Ÿ, ×”×¢×¨×•×ª...)" style="width:300px; margin:0;">
                            <select id="filterStat" onchange="renderTable()" style="width:150px; margin:0;">
                                <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                                <option>×—×“×©</option>
                                <option>×‘×˜×™×¤×•×œ</option>
                                <option>××•"×</option>
                                <option>×—×•×–×”</option>
                                <option>×—×¡×•×</option>
                            </select>
                            <button class="btn btn-white" onclick="toggleCols()">×¢××•×“×•×ª</button>
                            <div id="colMenu" class="col-menu"></div>
                            <button class="btn btn-danger admin-only" onclick="deleteBulk()" id="btnBulk" style="display:none;">××—×§ ××¡×•×× ×™×</button>
                        </div>
                        <div class="table-scroll">
                            <table id="mainTable">
                                <thead id="tHead"></thead>
                                <tbody id="tBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="calendar" class="page">
                    <div style="display:flex; justify-content:space-between;">
                        <h1>×™×•××Ÿ ××©×™××•×ª</h1>
                        <button class="btn btn-primary" onclick="openTaskModal()">+ ××©×™××”</button>
                    </div>
                    <div id="calGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:20px; margin-top:20px;"></div>
                </div>

                <div id="projects" class="page">
                    <div class="card" style="text-align:center; padding:50px;">
                        <h2>ğŸš§ ××•×“×•×œ ×¤×¨×•×™×§×˜×™×</h2>
                        <p>×›××Ÿ ×™× ×•×”×œ ××œ××™ ×”×“×™×¨×•×ª ×‘×’×¨×¡×” ×”×‘××”.</p>
                    </div>
                </div>

                <div id="settings" class="page">
                    <h1>×”×’×“×¨×•×ª</h1>
                    <div class="grid-3">
                        <div class="card">
                            <h3>×›×œ×œ×™</h3>
                            <label>×¨×™×‘×™×ª ×¤×¨×™×™×</label>
                            <input type="number" id="setPrime" value="6.0">
                            <button class="btn btn-primary" onclick="saveSettings()">×©××•×¨</button>
                        </div>
                        <div class="card admin-only">
                            <h3>××©×ª××©×™×</h3>
                            <input id="newEmail" placeholder="××™××™×™×œ">
                            <select id="newRole"><option value="agent">×¡×•×›×Ÿ</option><option value="admin">×× ×”×œ</option></select>
                            <button class="btn btn-primary" onclick="addUser()">×”×•×¡×£ ××©×ª××©</button>
                            <div id="usersList" style="margin-top:10px;"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="clientModal" class="modal">
        <div class="modal-box">
            <div class="modal-head">
                <h3>×›×¨×˜×™×¡ ×œ×§×•×—</h3>
                <button onclick="closeModal()" class="btn btn-white">X</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <div id="blockedMsg" style="display:none; background:#fee2e2; color:#991b1b; padding:10px; margin-bottom:10px; text-align:center; font-weight:bold;">âš ï¸ ×œ×§×•×— ×—×¡×•× (×‘×™×§×© ×œ×”×™××—×§)</div>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchTab(this, 't1')">×¤×¨×˜×™×</div>
                    <div class="tab" onclick="switchTab(this, 't2')">××©×¤×—×”</div>
                    <div class="tab" onclick="switchTab(this, 't3')">×¡×˜×˜×•×¡</div>
                    <div class="tab" onclick="switchTab(this, 't4')">×›×œ×™×</div>
                </div>

                <div id="t1" class="tab-content active">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div>
                            <label>×©× ××œ×</label><input id="inpName">
                            <label>×˜×œ×¤×•×Ÿ</label><input id="inpPhone">
                            <label>××™××™×™×œ</label><input id="inpEmail">
                            <label>×¢×™×¨</label><input id="inpCity">
                        </div>
                        <div>
                            <label>×‘×Ÿ/×‘×ª ×–×•×’</label><input id="inpSpouse">
                            <label>×˜×œ×¤×•×Ÿ × ×•×¡×£</label><input id="inpPhone2">
                            <label>×ª.×–</label><input id="inpId">
                        </div>
                    </div>
                    <hr>
                    <h4>××™×“×¢ × ×•×¡×£ (××§×¡×œ)</h4>
                    <div id="customFields" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;"></div>
                </div>

                <div id="t2" class="tab-content">
                    <div id="kidsList"></div>
                    <button class="btn btn-white" onclick="addKid()">+ ×”×•×¡×£ ×™×œ×“</button>
                </div>

                <div id="t3" class="tab-content">
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1"><label>×¡×˜×˜×•×¡</label><select id="inpStatus"><option>×—×“×©</option><option>×‘×˜×™×¤×•×œ</option><option>××•"×</option><option>×—×•×–×”</option><option>×—×¡×•×</option></select></div>
                        <div style="flex:1"><label>×ª×§×¦×™×‘</label><input id="inpBudget" type="number"></div>
                        <div style="flex:1"><label>×¡×•×›×Ÿ</label><input id="inpAgent" readonly style="background:#eee;"></div>
                    </div>
                    <label>×”×¢×¨×•×ª</label>
                    <textarea id="inpNotes" rows="10"></textarea>
                    <button class="btn btn-white" onclick="addNoteTime()">×”×•×¡×£ ×–××Ÿ</button>
                </div>

                <div id="t4" class="tab-content">
                    <h4>××—×©×‘×•×Ÿ ××©×›× ×ª×</h4>
                    <input type="number" id="calcLoan" placeholder="×¡×›×•× ×”×œ×•×•××”">
                    <h2 id="calcRes">0 â‚ª</h2>
                    <button class="btn btn-primary" onclick="calc()">×—×©×‘</button>
                    <hr>
                    <button class="btn btn-white" onclick="sendWa()">×•×•××˜×¡××¤</button>
                    <button class="btn btn-white" onclick="sendMail()">××™×™×œ</button>
                    <button class="btn btn-white" onclick="makePdf()">PDF</button>
                </div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-danger admin-only" onclick="deleteClient()">××—×§</button>
                <button class="btn btn-primary" onclick="saveClient()">×©××•×¨</button>
            </div>
        </div>
    </div>

    <div id="dupeModal" class="modal">
        <div class="modal-box" style="width:500px;">
            <div class="modal-head"><h3>âš ï¸ ×›×¤×™×œ×•×™×•×ª ×‘×™×™×‘×•×</h3></div>
            <div class="modal-body">
                <p>× ××¦××• ×œ×§×•×—×•×ª ×§×™×™××™× ×‘×§×•×‘×¥. ××” ×œ×¢×©×•×ª?</p>
                <div id="dupeList" style="max-height:200px; overflow:auto; background:#f8fafc; padding:10px; font-size:12px;"></div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-white" onclick="resDupes('skip')">×“×œ×’ ×¢×œ×™×”×</button>
                <button class="btn btn-primary" onclick="resDupes('merge')">××—×“ × ×ª×•× ×™×</button>
                <button class="btn btn-danger" onclick="resDupes('create')">×¦×•×¨ ×‘×›×œ ×–××ª</button>
            </div>
        </div>
    </div>

    <div id="taskModal" class="modal">
        <div class="modal-box" style="width:400px; height:auto;">
            <div class="modal-head"><h3>××©×™××” ×—×“×©×”</h3></div>
            <div class="modal-body">
                <input id="taskTitle" placeholder="××” ×”××©×™××”?">
                <input type="date" id="taskDate">
                <input type="time" id="taskTime">
            </div>
            <div class="modal-foot">
                <button class="btn btn-white" onclick="document.getElementById('taskModal').style.display='none'">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveTask()">×©××•×¨</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCJvUDVuccEZSuTsUSs7o-hnpME2WaTWio", 
            authDomain: "nadlan-pro.firebaseapp.com",
            projectId: "nadlan-pro",
            storageBucket: "nadlan-pro.firebasestorage.app",
            messagingSenderId: "435010903224",
            appId: "1:435010903224:web:53cc66ba40fa3d4198e84d",
            measurementId: "G-VRX35WJ2PE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // STATE
        let currentUser = null;
        let role = 'agent';
        let clients = {};
        let meetings = {};
        let settings = {prime:6.0};
        let users = {};
        let customKeys = new Set(['×™×©×™×‘×”','××§×•×¨','×¨×—×•×‘','××¡×¤×¨']);
        let showCols = ['checkbox','name','phone','status','city','agent'];
        let selected = new Set();
        let pendingDupes = [];
        let chart1, chart2;

        // --- AUTH ---
        window.login = () => {
            signInWithEmailAndPassword(auth, document.getElementById('txtEmail').value, document.getElementById('txtPass').value)
            .catch(e => document.getElementById('loginError').innerText = e.message);
        }
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, u => {
            if(u) {
                currentUser = u;
                document.getElementById('loginOverlay').style.display='none';
                document.getElementById('mainApp').style.display='block';
                document.getElementById('lblUser').innerText = u.email;
                init();
            } else {
                document.getElementById('loginOverlay').style.display='flex';
                document.getElementById('mainApp').style.display='none';
            }
        });

        function init() {
            onValue(ref(db, 'users'), s => {
                users = s.val() || {};
                const me = Object.values(users).find(x => x.email === currentUser.email);
                role = (!Object.keys(users).length) ? 'admin' : (me ? me.role : 'agent');
                if(!Object.keys(users).length) push(ref(db,'users'), {email:currentUser.email, role:'admin'});
                
                document.querySelectorAll('.admin-only').forEach(e => e.style.display = role==='admin'?'inline-flex':'none');
                renderUsers();
            });

            onValue(ref(db, 'clients'), s => {
                clients = s.val() || {};
                Object.values(clients).forEach(c => {
                    if(c.customData) Object.keys(c.customData).forEach(k => customKeys.add(k));
                });
                renderTable();
                updateStats();
                updateCharts();
            });

            onValue(ref(db, 'meetings'), s => {
                meetings = s.val() || {};
                renderCalendar();
            });
        }

        // --- EXCEL IMPORT ---
        document.getElementById('excelIn').onchange = (e) => {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = ex => {
                const wb = XLSX.read(new Uint8Array(ex.target.result), {type:'array'});
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                let batch = [];
                pendingDupes = [];
                const isBlk = f.name.includes('×—×¡×•×') || f.name.includes('×œ××—×•×§');

                const getVal = (row, words) => {
                    const key = Object.keys(row).find(k => words.some(w => k.includes(w)));
                    return key ? row[key] : '';
                }

                data.forEach(row => {
                    const phone = String(getVal(row, ['× ×™×™×“','×˜×œ×¤×•×Ÿ'])||'').replace(/\D/g,'');
                    const idn = String(getVal(row, ['×ª.×–','×–×”×•×ª'])||'');
                    const exists = Object.values(clients).find(c => (c.phone===phone && phone.length>6) || (c.idNum===idn && idn.length>6));

                    const c = {
                        name: (getVal(row, ['××©×¤×—×”','×©×'])||'×œ×œ×') + ' ' + (getVal(row, ['×¤×¨×˜×™'])||''),
                        spouse: getVal(row, ['××©×”','×–×•×’'])||'',
                        phone: phone,
                        phone2: String(getVal(row, ['× ×•×¡×£'])||'').replace(/\D/g,''),
                        email: getVal(row, ['××™×™×œ'])||'',
                        city: getVal(row, ['×¢×™×¨','×›×ª×•×‘×ª'])||'',
                        idNum: idn,
                        status: isBlk ? '×—×¡×•×' : '×—×“×©',
                        notes: `--- ×™×™×‘×•× ${f.name} ---\n`,
                        agent: currentUser.email,
                        lastUpdate: Date.now(),
                        children: [],
                        customData: {}
                    };

                    for(let [k,v] of Object.entries(row)) {
                        if(v) {
                            c.notes += `${k}: ${v}\n`;
                            if(!['×©×','×˜×œ×¤×•×Ÿ','××™×™×œ'].some(x=>k.includes(x))) {
                                c.customData[k] = v;
                                customKeys.add(k);
                            }
                        }
                    }

                    for(let i=1; i<15; i++) {
                        const n = getVal(row, [`×™×œ×“ ${i}`, `×©× ×”×™×œ×“${i}`]);
                        if(n) c.children.push({name:n, id: getVal(row, [`×–×”×•×ª ${i}`])||''});
                    }

                    if(exists) pendingDupes.push({new:c, old:exists});
                    else if(phone) batch.push(c);
                });

                batch.forEach(c => push(ref(db, 'clients'), c));
                
                if(pendingDupes.length > 0) {
                    document.getElementById('dupeList').innerHTML = pendingDupes.map(d => `<div>${d.new.name} (${d.new.phone}) ×§×™×™× ×›×‘×¨</div>`).join('');
                    document.getElementById('dupeModal').style.display = 'flex';
                } else {
                    alert('×”×™×™×‘×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!');
                }
            };
            r.readAsArrayBuffer(f);
        }

        window.resDupes = (act) => {
            if(act === 'create') pendingDupes.forEach(d => push(ref(db, 'clients'), d.new));
            if(act === 'merge') {
                pendingDupes.forEach(d => {
                    const k = Object.keys(clients).find(key => clients[key] === d.old);
                    if(k) update(ref(db, `clients/${k}`), { notes: (d.old.notes||'')+'\n'+d.new.notes });
                });
            }
            document.getElementById('dupeModal').style.display='none';
            alert('×‘×•×¦×¢');
        }

        // --- TABLE ---
        window.renderTable = () => {
            const txt = document.getElementById('searchBox').value.toLowerCase();
            const flt = document.getElementById('filterStat').value;
            const th = document.getElementById('tHead');
            const tb = document.getElementById('tBody');
            
            // HEADERS
            let cols = ['checkbox','name','phone','status','city','agent'];
            showCols.forEach(c => { if(!cols.includes(c) && c!=='checkbox') cols.push(c); });
            
            let h = `<tr><th style="width:30px"><input type="checkbox" onchange="toggleAll(this)"></th>`;
            cols.filter(c=>c!=='checkbox').forEach(c => h+=`<th>${loc(c)}</th>`);
            h+=`<th></th></tr>`;
            th.innerHTML = h;
            tb.innerHTML = '';

            Object.entries(clients).forEach(([k, c]) => {
                if(role!=='admin' && c.agent!==currentUser.email) return;
                if(flt && c.status!==flt) return;
                
                const str = JSON.stringify(c).toLowerCase();
                if(txt && !str.includes(txt)) return;

                const tr = document.createElement('tr');
                if(c.status==='×—×¡×•×') tr.className = 'blocked';
                
                let html = `<td><input type="checkbox" class="cb" value="${k}" onchange="chk()"></td>`;
                cols.filter(c=>c!=='checkbox').forEach(col => {
                    let v = '-';
                    if(col==='name') v = `<b>${c.name}</b><br><small>${c.spouse||''}</small>`;
                    else if(col==='status') v = `<select onchange="updStat('${k}',this.value)" style="padding:2px; height:auto; margin:0; font-size:12px;"><option>${c.status}</option><option>×—×“×©</option><option>×‘×˜×™×¤×•×œ</option><option>××•"×</option><option>×—×•×–×”</option><option>×—×¡×•×</option></select>`;
                    else if(col==='agent') v = c.agent ? c.agent.split('@')[0] : '-';
                    else v = c[col] || (c.customData?c.customData[col]:'') || '-';
                    html += `<td>${v}</td>`;
                });
                html += `<td><button class="btn-icon" onclick="edit('${k}')">âœï¸</button></td>`;
                tr.innerHTML = html;
                tb.appendChild(tr);
            });
        }

        window.updStat = (id, s) => update(ref(db, `clients/${id}`), {status:s});
        window.toggleAll = (e) => { document.querySelectorAll('.cb').forEach(c=>c.checked=e.checked); chk(); };
        window.chk = () => {
            selected.clear();
            document.querySelectorAll('.cb:checked').forEach(c=>selected.add(c.value));
            document.getElementById('btnBulk').style.display = selected.size ? 'inline-flex' : 'none';
            document.getElementById('btnBulk').innerText = `××—×§ ${selected.size}`;
        }
        window.deleteBulk = () => {
            if(confirm('×œ××—×•×§?')) { selected.forEach(id=>remove(ref(db, `clients/${id}`))); selected.clear(); chk(); }
        }

        // --- EDIT ---
        window.edit = (id) => {
            const c = clients[id];
            document.getElementById('editId').value = id;
            document.getElementById('inpName').value = c.name;
            document.getElementById('inpPhone').value = c.phone;
            document.getElementById('inpPhone2').value = c.phone2||'';
            document.getElementById('inpSpouse').value = c.spouse||'';
            document.getElementById('inpEmail').value = c.email||'';
            document.getElementById('inpCity').value = c.city||'';
            document.getElementById('inpId').value = c.idNum||'';
            document.getElementById('inpStatus').value = c.status;
            document.getElementById('inpBudget').value = c.budget||'';
            document.getElementById('inpAgent').value = c.agent||'';
            document.getElementById('inpNotes').value = c.notes||'';
            
            document.getElementById('blockedMsg').style.display = c.status==='×—×¡×•×'?'block':'none';

            // KIDS
            const kl = document.getElementById('kidsList');
            kl.innerHTML = '';
            if(c.children) c.children.forEach(k => addKid(k.name, k.id));

            // CUSTOM FIELDS
            const cf = document.getElementById('customFields');
            cf.innerHTML = '';
            const all = new Set([...customKeys, ...Object.keys(c.customData||{})]);
            all.forEach(k => {
                const val = (c.customData && c.customData[k]) ? c.customData[k] : '';
                cf.innerHTML += `<div><label style="font-size:11px">${k}</label><input class="cf-inp" data-key="${k}" value="${val}"></div>`;
            });

            document.getElementById('clientModal').style.display = 'flex';
        }

        window.saveClient = () => {
            const id = document.getElementById('editId').value;
            const c = {
                name: document.getElementById('inpName').value,
                phone: document.getElementById('inpPhone').value,
                phone2: document.getElementById('inpPhone2').value,
                spouse: document.getElementById('inpSpouse').value,
                email: document.getElementById('inpEmail').value,
                city: document.getElementById('inpCity').value,
                idNum: document.getElementById('inpId').value,
                status: document.getElementById('inpStatus').value,
                budget: document.getElementById('inpBudget').value,
                notes: document.getElementById('inpNotes').value,
                agent: id ? document.getElementById('inpAgent').value : currentUser.email,
                lastUpdate: Date.now(),
                children: [],
                customData: {}
            };

            document.querySelectorAll('.k-row').forEach(r => c.children.push({name:r.children[0].value, id:r.children[1].value}));
            document.querySelectorAll('.cf-inp').forEach(i => { if(i.value) c.customData[i.dataset.key]=i.value; });

            if(id) update(ref(db, `clients/${id}`), c);
            else push(ref(db, 'clients'), c);
            
            if(c.status==='×—×•×–×”') confetti();
            closeModal();
        }

        // --- DASHBOARD ---
        window.updateCharts = () => {
            const src = {}; const cit = {};
            Object.values(clients).forEach(c => {
                const s = c.customData ? (c.customData['×™×©×™×‘×”']||c.customData['××§×•×¨']||'××—×¨') : '××—×¨';
                src[s] = (src[s]||0)+1;
                const city = c.city || '×œ× ×™×“×•×¢';
                cit[city] = (cit[city]||0)+1;
            });
            drawChart('chartSources', src, '××§×•×¨×•×ª');
            drawChart('chartCities', cit, '×¢×¨×™×');
        }

        function drawChart(id, data, label) {
            if(window[id] instanceof Chart) window[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            const keys = Object.keys(data).sort((a,b)=>data[b]-data[a]).slice(0,5);
            window[id] = new Chart(ctx, {
                type: 'bar',
                data: { labels: keys, datasets: [{ label: label, data: keys.map(k=>data[k]), backgroundColor: '#2563eb' }] }
            });
        }

        // --- HELPERS (Global Exposure) ---
        window.nav = (p) => { document.querySelectorAll('.page').forEach(x=>x.classList.remove('active-page')); document.getElementById(p).classList.add('active-page'); document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); if(event) event.currentTarget.classList.add('active'); }
        window.openClientModal = () => { document.getElementById('editId').value=''; document.getElementById('clientModal').style.display='flex'; document.getElementById('kidsList').innerHTML=''; document.getElementById('customFields').innerHTML=''; }
        window.closeModal = () => document.getElementById('clientModal').style.display='none';
        window.switchTab = (el, id) => { document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); el.classList.add('active'); document.getElementById(id).classList.add('active'); }
        window.addKid = (n='', i='') => document.getElementById('kidsList').insertAdjacentHTML('beforeend', `<div class="k-row" style="display:flex; gap:5px; margin-bottom:5px;"><input value="${n}" placeholder="×©×"><input value="${i}" placeholder="×ª.×–"><button onclick="this.parentElement.remove()">-</button></div>`);
        window.addNoteTime = () => document.getElementById('inpNotes').value = `[${new Date().toLocaleString()}] ` + document.getElementById('inpNotes').value;
        window.deleteClient = () => { if(confirm('×œ××—×•×§?')) { remove(ref(db, `clients/${document.getElementById('editId').value}`)); closeModal(); } }
        window.calc = () => { const p=Number(document.getElementById('calcLoan').value); document.getElementById('calcRes').innerText = Math.round(p*(0.065/12)*Math.pow(1.0054,300)/(Math.pow(1.0054,300)-1)).toLocaleString(); }
        window.sendWa = () => window.open(`https://wa.me/972${document.getElementById('inpPhone').value.replace('0','')}`);
        window.makePdf = () => html2pdf(document.getElementById('t1'));
        window.updateStats = () => { const a=Object.values(clients); document.getElementById('stTotal').innerText=a.length; document.getElementById('stActive').innerText=a.filter(c=>['×‘×˜×™×¤×•×œ','××•"×'].includes(c.status)).length; document.getElementById('stDeals').innerText=a.filter(c=>c.status==='×—×•×–×”').length; }
        window.loc = (k) => ({name:'×©×', phone:'×˜×œ×¤×•×Ÿ', status:'×¡×˜×˜×•×¡', city:'×¢×™×¨', agent:'×¡×•×›×Ÿ'}[k]||k);
        window.toggleCols = () => { 
            const m = document.getElementById('colMenu'); m.style.display = m.style.display==='block'?'none':'block'; 
            m.innerHTML = ''; [...showCols, ...customKeys].forEach(k => { if(k!=='checkbox') m.innerHTML += `<div><label><input type="checkbox" onchange="tCol('${k}')" ${showCols.includes(k)?'checked':''}> ${k}</label></div>`; });
        }
        window.tCol = (k) => { const i=showCols.indexOf(k); if(i>-1)showCols.splice(i,1); else showCols.push(k); renderTable(); }
        
        // Users & Settings
        window.addUser = () => push(ref(db,'users'), {email:document.getElementById('newEmail').value, role:document.getElementById('newRole').value});
        window.renderUsers = () => { document.getElementById('usersList').innerHTML = Object.values(users).map(u=>`<div>${u.email} - ${u.role}</div>`).join(''); }
        window.saveSettings = () => update(ref(db, 'settings'), {prime: document.getElementById('setPrime').value}).then(()=>alert('× ×©××¨'));

        // Calendar
        window.openTaskModal = () => document.getElementById('taskModal').style.display='flex';
        window.saveTask = () => { push(ref(db,'meetings'), {clientId:'gen', clientName:'××©×™××”', date:document.getElementById('taskDate').value, time:document.getElementById('taskTime').value, note:document.getElementById('taskTitle').value, agent:currentUser.email}); document.getElementById('taskModal').style.display='none'; }
        window.renderCalendar = () => {
            const g = document.getElementById('calGrid'); g.innerHTML='';
            const dates = {};
            Object.values(meetings).sort((a,b)=>a.date.localeCompare(b.date)).forEach(m => { if(!dates[m.date]) dates[m.date]=[]; dates[m.date].push(m); });
            Object.keys(dates).forEach(d => {
                let h = `<div style="background:white; padding:15px; border-radius:10px; border:1px solid #eee;"><h4>${d}</h4>`;
                dates[d].forEach(m => h+=`<div style="font-size:13px; margin-bottom:5px; border-right:3px solid ${m.clientId==='gen'?'green':'blue'}; padding-right:5px;"><b>${m.time}</b> ${m.note}</div>`);
                h+='</div>'; g.innerHTML+=h;
            });
        }
    </script>
</body>
</html>
