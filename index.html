<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×“×œ"×Ÿ PRO V22 - ×”××¢×¨×›×ª ×”××œ××” (Heavy Duty)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* ========================================== */
        /* ×¢×™×¦×•×‘ ×”××¢×¨×›×ª (CSS Styles)                  */
        /* ========================================== */
        
        :root {
            /* ×¦×‘×¢×™× ×¨××©×™×™× */
            --primary-dark: #0f172a;
            --primary: #1e293b;
            --primary-light: #334155;
            
            /* ×¦×‘×¢×™ ×¤×¢×•×œ×” */
            --accent: #2563eb;
            --accent-hover: #1d4ed8;
            
            /* ×¨×§×¢×™× ×•×’×‘×•×œ×•×ª */
            --bg-color: #f1f5f9;
            --surface-color: #ffffff; 
            --border-color: #cbd5e1;
            
            /* ×˜×§×¡×˜ */
            --text-main: #0f172a;
            --text-muted: #64748b;
            
            /* ×¡×˜×˜×•×¡×™× */
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            
            /* ×›×œ×œ×™ */
            --radius: 10px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Rubik', sans-serif; 
            outline: none; 
            transition: background-color 0.2s, transform 0.1s; 
        }

        body { 
            background: var(--bg-color); 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* --- ××¡×š ×”×ª×—×‘×¨×•×ª --- */
        #loginOverlay { 
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, var(--primary-dark) 0%, #000 100%); 
            z-index: 10000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        
        .login-box { 
            background: white; 
            padding: 50px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 450px; 
            text-align: center; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); 
        }
        
        .login-input { 
            width: 100%; 
            padding: 15px; 
            margin-bottom: 20px; 
            border: 2px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 16px; 
            background: #f8fafc; 
        }
        
        .login-btn { 
            width: 100%; 
            padding: 15px; 
            background: var(--accent); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 18px; 
            font-weight: bold; 
            cursor: pointer; 
        }
        .login-btn:hover { background: var(--accent-hover); }

        /* --- ××‘× ×” ×¨××©×™ (Layout) --- */
        #mainApp { display: none; height: 100%; width: 100%; }
        .layout-container { display: flex; height: 100%; }

        /* ×¡×¨×’×œ ×¦×“ (Sidebar) */
        aside { 
            width: 280px; 
            background: var(--primary); 
            color: white; 
            display: flex; 
            flex-direction: column; 
            z-index: 50; 
            box-shadow: 5px 0 25px rgba(0,0,0,0.15); 
        }
        
        .brand { 
            padding: 30px; 
            text-align: center; 
            background: rgba(255,255,255,0.03); 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
        }
        
        .nav-list { flex: 1; padding: 20px; overflow-y: auto; }
        
        .nav-item { 
            padding: 15px 20px; 
            border-radius: var(--radius); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            color: #94a3b8; 
            margin-bottom: 10px; 
            font-weight: 500; 
            font-size: 15px; 
        }
        
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; transform: translateX(5px); }
        .nav-item.active { background: var(--accent); color: white; font-weight: 700; box-shadow: 0 0 20px rgba(37, 99, 235, 0.4); }
        
        .user-panel { 
            padding: 20px; 
            background: rgba(0,0,0,0.2); 
            border-top: 1px solid rgba(255,255,255,0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        /* ×ª×•×›×Ÿ (Main Content) */
        main { 
            flex: 1; 
            padding: 30px; 
            overflow-y: auto; 
            position: relative; 
            background: var(--bg-color); 
        }
        
        .page { display: none; animation: fadeIn 0.4s ease-out; }
        .page.active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 32px; font-weight: 800; color: var(--primary); }

        /* ×›×¨×˜×™×¡×™× ×•×¡×˜×˜×™×¡×˜×™×§×” */
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 30px; }
        
        .card { 
            background: var(--surface-color); 
            padding: 25px; 
            border-radius: var(--radius); 
            border: 1px solid var(--border-color); 
            box-shadow: var(--shadow); 
        }
        
        .stat-val { font-size: 48px; font-weight: 900; color: var(--text-main); line-height: 1; margin-bottom: 5px; }
        .stat-label { font-size: 14px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }

        /* ×˜×‘×œ×” ××ª×§×“××ª */
        .table-wrapper { 
            background: var(--surface-color); 
            border-radius: var(--radius); 
            border: 1px solid var(--border-color); 
            box-shadow: var(--shadow); 
            display: flex; 
            flex-direction: column; 
            height: calc(100vh - 200px); 
            overflow: hidden; 
        }
        
        .table-toolbar { 
            padding: 20px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            background: #f8fafc; 
        }
        
        .table-scroll { overflow: auto; flex: 1; }
        
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        
        th { 
            background: #f1f5f9; 
            text-align: right; 
            padding: 15px; 
            font-weight: 700; 
            color: var(--text-muted); 
            font-size: 13px; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            border-bottom: 2px solid var(--border-color); 
        }
        
        td { 
            padding: 12px 15px; 
            border-bottom: 1px solid var(--border-color); 
            font-size: 14px; 
            vertical-align: middle; 
            color: var(--text-main); 
        }
        
        tr:hover { background: #eff6ff; cursor: pointer; }
        tr.blocked-row { background: #fee2e2 !important; }
        tr.blocked-row td { color: #991b1b; }

        /* ××œ×× ×˜×™× UI */
        .btn { 
            padding: 10px 20px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 14px; 
            transition: 0.2s; 
        }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(37,99,235,0.3); }
        .btn-white { background: white; border: 1px solid var(--border-color); color: var(--text-main); }
        .btn-danger { background: var(--danger); color: white; }
        .btn:hover { transform: translateY(-2px); }
        
        .btn-icon { padding: 8px; background: transparent; border: none; cursor: pointer; color: #64748b; font-size: 16px; border-radius: 6px; }
        .btn-icon:hover { background: #e2e8f0; color: var(--accent); }

        input, select, textarea { 
            background: white; 
            border: 1px solid var(--border-color); 
            color: var(--text-main); 
            padding: 12px; 
            border-radius: 8px; 
            width: 100%; 
            font-size: 14px; 
            margin-bottom: 10px; 
        }
        input:focus { border-color: var(--accent); outline: 3px solid rgba(37,99,235,0.1); }

        /* ××•×“××œ×™× */
        .modal { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.6); 
            z-index: 2000; 
            display: none; 
            justify-content: center; 
            align-items: center; 
            backdrop-filter: blur(5px); 
        }
        
        .modal-box { 
            background: var(--surface-color); 
            width: 95%; 
            max-width: 1200px; 
            border-radius: 16px; 
            max-height: 95vh; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.4); 
        }
        
        .modal-head { padding: 20px 30px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: 16px 16px 0 0; }
        .modal-content { padding: 30px; overflow-y: auto; flex: 1; }
        .modal-foot { padding: 20px 30px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 15px; background: #f8fafc; border-radius: 0 0 16px 16px; }

        /* ×˜××‘×™× */
        .tabs { display: flex; gap: 20px; border-bottom: 1px solid var(--border-color); margin-bottom: 30px; }
        .tab { padding: 12px 20px; cursor: pointer; color: var(--text-muted); font-weight: 500; border-bottom: 3px solid transparent; font-size: 15px; }
        .tab.active { color: var(--accent); border-color: var(--accent); font-weight: 700; background: #eff6ff; border-radius: 8px 8px 0 0; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; animation: fadeIn 0.3s; }

        /* ×™×•××Ÿ */
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .day-column { background: white; border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; box-shadow: var(--shadow); }
        .day-head { font-weight: bold; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f1f5f9; color: var(--accent); display: flex; justify-content: space-between; }
        .cal-event { background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-right: 4px solid var(--accent); position: relative; font-size: 13px; }

        /* ×¢×–×¨×™× */
        .admin-only { display: none !important; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .cols-menu { position: absolute; top: 70px; left: 20px; background: white; border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); z-index: 100; display: none; min-width: 250px; max-height: 400px; overflow-y: auto; }
        
        /* ×”×ª×¨××ª ×›×¤×™×œ×•×™×•×ª */
        .dupe-list { max-height: 250px; overflow-y: auto; background: #fff7ed; border: 1px solid #ffedd5; padding: 15px; margin-bottom: 20px; font-size: 13px; color: #9a3412; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <div style="font-size: 60px; margin-bottom: 15px;">ğŸ™ï¸</div>
            <h1>× ×“×œ"×Ÿ PRO</h1>
            <p style="color:#64748b; margin-bottom: 30px;">×’×¨×¡×” 22.0 Enterprise (Heavy Duty)</p>
            <input type="email" id="txtEmail" class="login-input" placeholder="×›×ª×•×‘×ª ××™××™×™×œ">
            <input type="password" id="txtPass" class="login-input" placeholder="×¡×™×¡××”">
            <button class="login-btn" onclick="appLogin()">×”×ª×—×‘×¨ ×œ××¢×¨×›×ª</button>
            <div id="loginError" style="color:var(--danger); margin-top:20px; font-weight:bold;"></div>
        </div>
    </div>

    <div id="mainApp">
        <div class="layout-container">
            <aside>
                <div class="brand">
                    <div style="font-size: 24px; font-weight: 900;">× ×“×œ"×Ÿ PRO</div>
                    <div style="opacity: 0.6; font-size: 12px;">××¢×¨×›×ª × ×™×”×•×œ ××œ××”</div>
                </div>
                <div class="nav-list">
                    <div class="nav-item active" onclick="nav('dashboard')"><i class="fa-solid fa-chart-line"></i> ×“×©×‘×•×¨×“ ×× ×”×œ×™×</div>
                    <div class="nav-item" onclick="nav('crm')"><i class="fa-solid fa-users"></i> ×××’×¨ ×œ×§×•×—×•×ª</div>
                    <div class="nav-item" onclick="nav('calendar')"><i class="fa-solid fa-calendar-days"></i> ×™×•××Ÿ ×•××©×™××•×ª</div>
                    <div class="nav-item" onclick="nav('projects')"><i class="fa-solid fa-building"></i> ×¤×¨×•×™×§×˜×™×</div>
                    <div class="nav-item" onclick="nav('settings')"><i class="fa-solid fa-sliders"></i> ×”×’×“×¨×•×ª ×•×”×¨×©××•×ª</div>
                </div>
                <div class="user-panel">
                    <div>
                        <div id="lblUser" style="font-weight:bold;">××•×¨×—</div>
                        <div id="lblRole" style="font-size:11px; color:var(--accent);">×˜×•×¢×Ÿ...</div>
                    </div>
                    <button class="btn-icon" onclick="appLogout()" title="×”×ª× ×ª×§"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </aside>

            <main>
                
                <div id="dashboard" class="page active-page">
                    <div class="header">
                        <div class="page-title">×“×©×‘×•×¨×“ ×× ×”×œ×™×</div>
                        <div id="dateDisplay" style="font-weight:bold; font-size:18px; color:var(--accent);"></div>
                    </div>

                    <div class="grid-3">
                        <div class="card" onclick="nav('crm')" style="cursor:pointer;">
                            <div class="stat-val" id="stTotal">0</div>
                            <div class="stat-label">×¡×”"×› ×œ×§×•×—×•×ª ×‘×××’×¨</div>
                        </div>
                        <div class="card">
                            <div class="stat-val" id="stActive" style="color:var(--warning);">0</div>
                            <div class="stat-label">×œ×§×•×—×•×ª ×‘×˜×™×¤×•×œ ×¤×¢×™×œ</div>
                        </div>
                        <div class="card">
                            <div class="stat-val" id="stDeals" style="color:var(--success);">0</div>
                            <div class="stat-label">×—×•×–×™× ×”×—×•×“×©</div>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="card">
                            <h3>ğŸ“ ×¤×™×œ×•×— ××§×•×¨×•×ª (×™×©×™×‘×•×ª/××•×¡×“×•×ª)</h3>
                            <canvas id="chartSources" height="250"></canvas>
                        </div>
                        <div class="card">
                            <h3>ğŸ˜ï¸ ×¤×™×œ×•×— ×¢×¨×™× ××•×‘×™×œ×•×ª</h3>
                            <canvas id="chartCities" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <div id="crm" class="page">
                    <div class="header">
                        <div class="page-title">×××’×¨ ×”×œ×§×•×—×•×ª</div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-white" onclick="document.getElementById('excelIn').click()"><i class="fa-solid fa-file-excel"></i> ×™×™×‘×•× ××§×¡×œ ××œ×</button>
                            <input type="file" id="excelIn" hidden>
                            <button class="btn btn-white admin-only" onclick="exportData()"><i class="fa-solid fa-file-export"></i> ×™×™×¦×•× ×œ×’×™×‘×•×™</button>
                            <button class="btn btn-primary" onclick="openClientModal()"><i class="fa-solid fa-plus"></i> ×œ×§×•×— ×—×“×©</button>
                        </div>
                    </div>

                    <div class="table-wrapper">
                        <div class="table-toolbar">
                            <div style="flex:1; position:relative;">
                                <i class="fa-solid fa-search" style="position:absolute; right:15px; top:12px; color:#94a3b8;"></i>
                                <input id="searchBox" onkeyup="renderTable()" placeholder="×—×™×¤×•×© ×¢××•×§ (×©×, ×˜×œ×¤×•×Ÿ, ×™×œ×“×™×, ×”×¢×¨×•×ª, ×™×©×™×‘×”...)" style="padding-right:40px; margin:0;">
                            </div>
                            
                            <select id="filterStat" onchange="renderTable()" style="width:160px; margin:0; font-weight:bold;">
                                <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                                <option>×—×“×©</option>
                                <option>×‘×˜×™×¤×•×œ</option>
                                <option>××•"×</option>
                                <option>×—×•×–×”</option>
                                <option value="×—×¡×•×">â›” ×¨×©×™××” ×©×—×•×¨×”</option>
                            </select>
                            
                            <button class="btn btn-white" onclick="toggleColsMenu()"><i class="fa-solid fa-columns"></i> ×¢××•×“×•×ª</button>
                            
                            <div id="bulkActions" style="display:none; gap:10px; border-right:1px solid #ddd; padding-right:15px;">
                                <button class="btn btn-danger admin-only" onclick="deleteBulk()"><i class="fa-solid fa-trash"></i> ××—×§ ××¡×•×× ×™×</button>
                                <span id="selCount" style="font-weight:bold; font-size:13px;">0 × ×‘×—×¨×•</span>
                            </div>
                        </div>
                        
                        <div id="colsMenu" class="cols-menu"></div>

                        <div class="table-scroll">
                            <table id="mainTable">
                                <thead id="tHead"></thead>
                                <tbody id="tBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="calendar" class="page">
                    <div class="header">
                        <div class="page-title">×™×•××Ÿ ××©×™××•×ª</div>
                        <button class="btn btn-primary" onclick="openTaskModal()"><i class="fa-solid fa-plus"></i> ××©×™××” ××™×©×™×ª</button>
                    </div>
                    
                    <div id="quickTask" class="card" style="display:none; background:#eff6ff; border-color:#bfdbfe; margin-bottom:20px;">
                        <h4 style="color:var(--accent);">×”×•×¡×¤×ª ××©×™××” ×œ×™×•××Ÿ (×œ×œ× ×©×™×•×š ×œ×œ×§×•×—)</h4>
                        <div style="display:flex; gap:15px; margin-top:15px;">
                            <input id="gtTitle" placeholder="×ª×™××•×¨ ×”××©×™××”..." style="flex:2">
                            <input type="date" id="gtDate" style="flex:1">
                            <input type="time" id="gtTime" value="09:00" style="flex:1">
                            <button class="btn btn-primary" onclick="addGenTask()">×©××•×¨ ×‘×™×•××Ÿ</button>
                            <button class="btn btn-white" onclick="document.getElementById('quickTask').style.display='none'">×‘×™×˜×•×œ</button>
                        </div>
                    </div>

                    <div id="calGrid" class="calendar-grid"></div>
                </div>

                <div id="projects" class="page">
                    <div class="header"><div class="page-title">×¤×¨×•×™×§×˜×™×</div></div>
                    <div class="card" style="text-align:center; padding:80px;">
                        <i class="fa-solid fa-person-digging" style="font-size:60px; color:var(--text-muted); margin-bottom:20px;"></i>
                        <h2>××•×“×•×œ ×¤×¨×•×™×§×˜×™× ×•××œ××™</h2>
                        <p>××•×“×•×œ ×–×” × ××¦× ×›×¢×ª ×‘×¤×™×ª×•×— ×•×™×›×œ×•×œ × ×™×”×•×œ ×‘× ×™×™× ×™×, ×“×™×¨×•×ª ×•××—×™×¨×•× ×™×.</p>
                    </div>
                </div>

                <div id="settings" class="page">
                    <div class="header"><div class="page-title">×”×’×“×¨×•×ª ××¢×¨×›×ª</div></div>
                    
                    <div class="grid-2">
                        <div class="card">
                            <h3>âš™ï¸ ×”×’×“×¨×•×ª ×›×œ×œ×™×•×ª</h3>
                            <label>×¨×™×‘×™×ª ×¤×¨×™×™× (%) - ×œ×—×™×©×•×‘×™ ××©×›× ×ª×</label>
                            <input type="number" id="setPrime" value="6.0">
                            <button class="btn btn-primary" onclick="saveSettings()">×©××•×¨ ×”×’×“×¨×•×ª</button>
                        </div>
                        
                        <div class="card admin-only">
                            <h3>ğŸ‘¥ × ×™×”×•×œ ××©×ª××©×™× ×•×”×¨×©××•×ª</h3>
                            <p style="font-size:12px; margin-bottom:15px;">×”×’×“×¨×ª ×’×™×©×” ×œ××¢×¨×›×ª. '×× ×”×œ' ×¨×•××” ×”×›×œ, '×¡×•×›×Ÿ' ××•×’×‘×œ.</p>
                            <div id="usersList" style="height:150px; overflow-y:auto; border:1px solid #eee; margin-bottom:15px; padding:10px; border-radius:6px;"></div>
                            <div style="display:flex; gap:10px;">
                                <input id="newUEmail" placeholder="××™××™×™×œ ×”×¢×•×‘×“">
                                <select id="newURole" style="width:120px;"><option value="agent">×¡×•×›×Ÿ</option><option value="admin">×× ×”×œ</option></select>
                                <button class="btn btn-primary" onclick="addUser()">×”×•×¡×£</button>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <div id="clientModal" class="modal">
        <div class="modal-box">
            <div class="modal-head">
                <h2 style="font-size:22px;">×›×¨×˜×™×¡ ×œ×§×•×—</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn-icon" onclick="printClient()" title="×”×“×¤×¡×”"><i class="fa-solid fa-print"></i></button>
                    <button class="btn-icon" onclick="closeModal()" title="×¡×’×•×¨"><i class="fa-solid fa-times"></i></button>
                </div>
            </div>
            <div class="modal-content">
                <input type="hidden" id="editId">
                
                <div id="blockedMsg" style="display:none; background:#fee2e2; color:#991b1b; padding:15px; border-radius:8px; margin-bottom:20px; text-align:center; font-weight:bold; border:1px solid #fecaca;">
                    â›” ×œ×§×•×— ×–×” × ××¦× ×‘×¨×©×™××” ×”×©×—×•×¨×” (×‘×™×§×© ×œ×”×™××—×§). ××™×Ÿ ×œ×™×¦×•×¨ ×§×©×¨!
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchTab(this, 't1')"><i class="fa-solid fa-user"></i> ×¤×¨×˜×™×</div>
                    <div class="tab" onclick="switchTab(this, 't2')"><i class="fa-solid fa-users"></i> ××©×¤×—×”</div>
                    <div class="tab" onclick="switchTab(this, 't3')"><i class="fa-solid fa-tag"></i> ×¡×˜×˜×•×¡</div>
                    <div class="tab" onclick="switchTab(this, 't5')"><i class="fa-solid fa-calendar"></i> ×™×•××Ÿ</div>
                    <div class="tab" onclick="switchTab(this, 't4')"><i class="fa-solid fa-calculator"></i> ×›×œ×™×</div>
                </div>

                <div id="t1" class="tab-panel active">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px;">
                        <div>
                            <label>×©× ×œ×§×•×— ×¨××©×™</label><input id="inpName">
                            <label>×˜×œ×¤×•×Ÿ ×¨××©×™ (×—×•×‘×”)</label><input id="inpPhone">
                            <label>××™××™×™×œ</label><input id="inpEmail">
                            <label>×¢×™×¨ ××’×•×¨×™×</label><input id="inpCity">
                        </div>
                        <div>
                            <label>×‘×Ÿ/×‘×ª ×–×•×’</label><input id="inpSpouse">
                            <label>×˜×œ×¤×•×Ÿ × ×•×¡×£</label><input id="inpPhone2">
                            <label>×ª×¢×•×“×ª ×–×”×•×ª</label><input id="inpId">
                        </div>
                    </div>
                    <hr style="margin:25px 0; border:0; border-top:1px solid #eee;">
                    <h4 style="color:var(--accent); margin-bottom:15px;">××™×“×¢ × ×•×¡×£ (× ×§×œ×˜ ×××§×¡×œ)</h4>
                    <div id="customFields" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px;"></div>
                </div>

                <div id="t2" class="tab-panel">
                    <div id="kidsList"></div>
                    <button class="btn btn-white" onclick="addKid()" style="width:100%; margin-top:15px;">+ ×”×•×¡×£ ×™×œ×“ ×œ×¨×©×™××”</button>
                </div>

                <div id="t3" class="tab-panel">
                    <div style="display:flex; gap:20px; margin-bottom:20px;">
                        <div style="flex:1"><label>×¡×˜×˜×•×¡ ×˜×™×¤×•×œ</label><select id="inpStatus" style="font-weight:bold;"><option>×—×“×©</option><option>×‘×˜×™×¤×•×œ</option><option>××•"×</option><option>×—×•×–×”</option><option>×—×¡×•×</option></select></div>
                        <div style="flex:1"><label>×ª×§×¦×™×‘ (â‚ª)</label><input id="inpBudget" type="number"></div>
                        <div style="flex:1"><label>×¡×•×›×Ÿ ××˜×¤×œ</label><input id="inpAgent" readonly style="background:#f1f5f9;"></div>
                    </div>
                    <label>×”×¢×¨×•×ª, ×¡×™×›×•××™ ×©×™×—×” ×•×”×™×¡×˜×•×¨×™×” (×›×•×œ×œ ××™×“×¢ ×’×•×œ××™)</label>
                    <textarea id="inpNotes" rows="12" style="font-family:monospace; line-height:1.5; font-size:13px;"></textarea>
                    <button class="btn btn-white" onclick="addNoteTime()">×”×•×¡×£ ×—×•×ª××ª ×–××Ÿ</button>
                </div>

                <div id="t5" class="tab-panel">
                    <div class="card" style="background:#eff6ff; border:1px solid #bfdbfe; margin-bottom:20px;">
                        <h4 style="color:var(--accent); margin-bottom:10px;">×§×‘×¢ ×¤×’×™×©×” ×—×“×©×” ×œ×œ×§×•×— ×–×”</h4>
                        <div style="display:flex; gap:15px;">
                            <input type="date" id="mDate" style="flex:1">
                            <input type="time" id="mTime" style="flex:1">
                            <input id="mNote" placeholder="× ×•×©× ×”×¤×’×™×©×”..." style="flex:2">
                            <button class="btn btn-primary" onclick="addMeeting()">×©×‘×¥ ×‘×™×•××Ÿ</button>
                        </div>
                    </div>
                    <div id="clientMeetings"></div>
                </div>

                <div id="t4" class="tab-panel">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                        <div class="card" style="margin:0;">
                            <h4>××—×©×‘×•×Ÿ ××©×›× ×ª×</h4>
                            <input type="number" id="calcLoan" placeholder="×¡×›×•× ×”×œ×•×•××”">
                            <div style="text-align:center; padding:15px; background:#f8fafc; border-radius:8px; margin-top:10px;">
                                <div style="font-size:12px; color:#64748b;">×”×—×–×¨ ×—×•×“×©×™ ××©×•×¢×¨</div>
                                <div id="calcRes" style="font-size:32px; font-weight:900; color:var(--primary);">0 â‚ª</div>
                            </div>
                            <button class="btn btn-primary" onclick="calc()" style="width:100%; margin-top:10px;">×‘×¦×¢ ×—×™×©×•×‘</button>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:15px;">
                            <button class="btn btn-white comms" style="height:60px; font-size:16px;" onclick="sendWa()"><i class="fa-brands fa-whatsapp" style="color:#25d366; font-size:24px;"></i> ×•×•××˜×¡××¤</button>
                            <button class="btn btn-white comms" style="height:60px; font-size:16px;" onclick="sendMail()"><i class="fa-solid fa-envelope" style="color:#ef4444; font-size:24px;"></i> ××™××™×™×œ</button>
                            <button class="btn btn-white" style="height:60px; font-size:16px;" onclick="makePdf()"><i class="fa-solid fa-file-pdf" style="color:#f59e0b; font-size:24px;"></i> ×”×¤×§ PDF</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-danger admin-only" onclick="deleteClient()"><i class="fa-solid fa-trash"></i> ××—×§ ×œ×§×•×—</button>
                <div style="flex:1"></div>
                <button class="btn btn-white" onclick="closeModal()">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveClient()"><i class="fa-solid fa-save"></i> ×©××•×¨ ×©×™× ×•×™×™×</button>
            </div>
        </div>
    </div>

    <div id="dupeModal" class="modal">
        <div class="modal-box" style="width:600px;">
            <div class="modal-head" style="background:#fff7ed; color:#c2410c;">
                <h3>âš ï¸ ×”×ª×’×œ×• ×›×¤×™×œ×•×™×•×ª ×‘×™×™×‘×•×</h3>
            </div>
            <div class="modal-body">
                <p>×”××¢×¨×›×ª ×–×™×”×ª×” ×©×œ×§×•×—×•×ª ××œ×• ×›×‘×¨ ×§×™×™××™× ×‘×××’×¨ (×œ×¤×™ ×˜×œ×¤×•×Ÿ ××• ×ª.×–). ××” ×ª×¨×¦×” ×œ×¢×©×•×ª?</p>
                <div id="dupeList" class="dupe-list"></div>
            </div>
            <div class="modal-foot" style="justify-content:center;">
                <button class="btn btn-white" onclick="resDupes('skip')">×“×œ×’ ×¢×œ ×›×•×œ×</button>
                <button class="btn btn-primary" onclick="resDupes('merge')">××—×“ × ×ª×•× ×™× (×œ×”×¢×¨×•×ª)</button>
                <button class="btn btn-danger" onclick="resDupes('create')">×¦×•×¨ ×‘×›×œ ×–××ª (×›×¤×•×œ×™×)</button>
            </div>
        </div>
    </div>

    <div id="taskModal" class="modal">
        <div class="modal-box" style="width:400px; height:auto;">
            <div class="modal-head"><h3>××©×™××” ×—×“×©×”</h3></div>
            <div class="modal-body">
                <input id="taskTitle" placeholder="×ª×™××•×¨ ×”××©×™××”...">
                <input type="date" id="taskDate">
                <input type="time" id="taskTime" value="09:00">
            </div>
            <div class="modal-foot">
                <button class="btn btn-white" onclick="document.getElementById('taskModal').style.display='none'">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveTask()">×©××•×¨ ×‘×™×•××Ÿ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- ×”×’×“×¨×•×ª Firebase ---
        // ×©×™× ×œ×‘: ×”××¤×ª×— ×©×œ×š ×›×‘×¨ ×‘×¤× ×™×. ××™×Ÿ ×¦×•×¨×š ×œ×©× ×•×ª ×›×œ×•×.
        const firebaseConfig = {
            apiKey: "AIzaSyCJvUDVuccEZSuTsUSs7o-hnpME2WaTWio", 
            authDomain: "nadlan-pro.firebaseapp.com",
            projectId: "nadlan-pro",
            storageBucket: "nadlan-pro.firebasestorage.app",
            messagingSenderId: "435010903224",
            appId: "1:435010903224:web:53cc66ba40fa3d4198e84d",
            measurementId: "G-VRX35WJ2PE"
        };

        // ××ª×—×•×œ
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        let currentUser = null;
        let role = 'agent';
        let clients = {};
        let meetings = {};
        let settings = {prime:6.0};
        let users = {};
        // ×©×“×•×ª ××™×•×—×“×™× ×©×–×•×”×• ××•×˜×•××˜×™×ª ×××§×¡×œ
        let customKeys = new Set(['×™×©×™×‘×”','××§×•×¨','×¨×—×•×‘','××¡×¤×¨','×¢×™×¡×•×§']);
        let showCols = ['checkbox','name','phone','status','city','agent'];
        let selected = new Set();
        let pendingDupes = [];
        let chartSourcesInstance, chartCitiesInstance;

        // --- ×—×©×™×¤×ª ×¤×•× ×§×¦×™×•×ª ×œ-Window (×§×¨×™×˜×™ ×œ×›×¤×ª×•×¨×™×!) ---
        // ×–×” ××” ×©×’×¨× ×œ×‘×¢×™×” ×‘×’×¨×¡×” ×”×§×•×“××ª - ×¢×›×©×™×• ×–×” ××ª×•×§×Ÿ.
        window.appLogin = () => {
            signInWithEmailAndPassword(auth, document.getElementById('txtEmail').value, document.getElementById('txtPass').value)
            .catch(e => document.getElementById('loginError').innerText = "×©×’×™××”: " + e.message);
        }
        window.appLogout = () => signOut(auth);
        
        // --- × ×™×”×•×œ ××©×ª××©×™× ×•×”×¨×©××•×ª ---
        onAuthStateChanged(auth, u => {
            if(u) {
                currentUser = u;
                document.getElementById('loginOverlay').style.display='none';
                document.getElementById('mainApp').style.display='block';
                document.getElementById('lblUser').innerText = u.email;
                document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('he-IL', {weekday:'long', day:'numeric', month:'long'});
                initSystem();
            } else {
                document.getElementById('loginOverlay').style.display='flex';
                document.getElementById('mainApp').style.display='none';
            }
        });

        function initSystem() {
            // ×˜×¢×™× ×ª ××©×ª××©×™× ×•×”×¨×©××•×ª
            onValue(ref(db, 'users'), s => {
                users = s.val() || {};
                const me = Object.values(users).find(x => x.email === currentUser.email);
                // ×× ××™×Ÿ ××©×ª××©×™× ×‘×›×œ×œ - ×”×¨××©×•×Ÿ ×”×•× ×× ×”×œ
                role = (!Object.keys(users).length) ? 'admin' : (me ? me.role : 'agent');
                if(!Object.keys(users).length) push(ref(db,'users'), {email:currentUser.email, role:'admin'});
                
                document.getElementById('lblRole').innerText = role==='admin' ? '×× ×”×œ ××¢×¨×›×ª' : '×¡×•×›×Ÿ ××›×™×¨×•×ª';
                // ×”×¡×ª×¨×ª ×›×¤×ª×•×¨×™ × ×™×”×•×œ ×œ×¡×•×›× ×™×
                document.querySelectorAll('.admin-only').forEach(e => e.style.display = role==='admin'?'inline-flex':'none');
                renderUsersList();
            });

            // ×˜×¢×™× ×ª ×œ×§×•×—×•×ª
            onValue(ref(db, 'clients'), s => {
                clients = s.val() || {};
                // ×¢×“×›×•×Ÿ ×“×™× ××™ ×©×œ ×©×“×•×ª ××™×•×—×“×™× ×©× ××¦××• ×‘×œ×§×•×—×•×ª
                Object.values(clients).forEach(c => {
                    if(c.customData) Object.keys(c.customData).forEach(k => customKeys.add(k));
                });
                renderTable();
                updateStats();
                updateCharts();
            });

            // ×˜×¢×™× ×ª ×™×•××Ÿ
            onValue(ref(db, 'meetings'), s => {
                meetings = s.val() || {};
                renderCalendar();
            });
            
            // ×˜×¢×™× ×ª ×”×’×“×¨×•×ª
            onValue(ref(db, 'settings'), s => {
                if(s.val()) settings = s.val();
                if(document.getElementById('setPrime')) document.getElementById('setPrime').value = settings.prime || 6.0;
            });
        }

        // --- ×™×™×‘×•× ××§×¡×œ (×”×× ×’× ×•×Ÿ ×”××œ× ×•×”×›×‘×“) ---
        // ×›×•×œ×œ: ×–×™×”×•×™ ×¢××•×“×•×ª ×—×›×, ×”×•×¨×™×, ×™×œ×“×™×, ×›×ª×•×‘×•×ª, ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª
        document.getElementById('excelIn').onchange = (e) => {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = ex => {
                const wb = XLSX.read(new Uint8Array(ex.target.result), {type:'array'});
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                
                let batch = [];
                pendingDupes = [];
                // ×–×™×”×•×™ ×× ×”×§×•×‘×¥ ×”×•× ×¨×©×™××” ×©×—×•×¨×” ×œ×¤×™ ×”×©×
                const isBlacklist = f.name.includes('×—×¡×•×') || f.name.includes('×œ××—×•×§');

                // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ××¦×™××ª ×¢×¨×š ×‘×¢××•×“×” (×’× ×× ×”×©× ×§×¦×ª ×©×•× ×”)
                const getVal = (row, words) => {
                    const key = Object.keys(row).find(k => words.some(w => k.includes(w)));
                    return key ? row[key] : '';
                }

                data.forEach(row => {
                    // × ×™×§×•×™ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×•×ª×¢×•×“×ª ×–×”×•×ª
                    const phone = String(getVal(row, ['× ×™×™×“','×˜×œ×¤×•×Ÿ','×¤×œ××¤×•×Ÿ'])||'').replace(/\D/g,'');
                    const idn = String(getVal(row, ['×ª.×–','×–×”×•×ª'])||'');
                    
                    // ×‘×“×™×§×” ×”×× ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª
                    const exists = Object.values(clients).find(c => (c.phone===phone && phone.length>6) || (c.idNum===idn && idn.length>6));

                    // ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ ×”×œ×§×•×—
                    const c = {
                        name: (getVal(row, ['××©×¤×—×”','×©×'])||'×œ×œ× ×©×') + ' ' + (getVal(row, ['×¤×¨×˜×™'])||''),
                        spouse: getVal(row, ['××©×”','×–×•×’','××™×©×”'])||'',
                        phone: phone,
                        phone2: String(getVal(row, ['× ×•×¡×£','2','××™×©×”'])||'').replace(/\D/g,''),
                        email: getVal(row, ['××™×™×œ','×“×•×'])||'',
                        city: getVal(row, ['×¢×™×¨','×›×ª×•×‘×ª'])||'',
                        idNum: idn,
                        status: isBlacklist ? '×—×¡×•×' : '×—×“×©', // ×¡×˜×˜×•×¡ ××•×˜×•××˜×™
                        notes: `--- × ×ª×•× ×™× ××§×•×‘×¥ ${f.name} ---\n`, // ×œ×•×’ ×”×™×¡×˜×•×¨×™
                        agent: currentUser.email,
                        lastUpdate: Date.now(),
                        children: [],
                        customData: {}
                    };

                    // ×œ×•×œ××” ×—×›××”: ×©×•××‘×ª ××ª ×›×œ ×”××™×“×¢ ×©×œ× ×–×•×”×” ×œ×”×¢×¨×•×ª ×•×œ×©×“×•×ª ××™×•×—×“×™×
                    for(let [k,v] of Object.entries(row)) {
                        if(v) {
                            c.notes += `${k}: ${v}\n`; // ×’×™×‘×•×™ ××œ× ×‘×”×¢×¨×•×ª
                            // ×–×™×”×•×™ ×©×“×•×ª ××™×•×—×“×™× (×™×©×™×‘×”, ×¨×—×•×‘, ××§×•×¨)
                            if(!['×©×','×˜×œ×¤×•×Ÿ','××™×™×œ','×ª.×–'].some(x=>k.includes(x))) {
                                c.customData[k] = v;
                                customKeys.add(k); // ×”×•×¡×¤×” ×œ×¨×©×™××ª ×”×¢××•×“×•×ª ×”××¤×©×¨×™×•×ª
                            }
                        }
                    }

                    // ×–×™×”×•×™ ×™×œ×“×™× (×¢×“ 15 ×™×œ×“×™×)
                    for(let i=1; i<=15; i++) {
                        const n = getVal(row, [`×™×œ×“ ${i}`, `×©× ×”×™×œ×“${i}`, `×™×œ×“${i}`]);
                        if(n) {
                            c.children.push({
                                name: n, 
                                id: getVal(row, [`×–×”×•×ª ${i}`, `×ª.×– ${i}`])||''
                            });
                        }
                    }

                    if(exists) {
                        pendingDupes.push({new:c, old:exists});
                    } else if(phone.length > 0) {
                        batch.push(c);
                    }
                });

                // ×©××™×¨×ª ×”×—×“×©×™× ××™×“
                batch.forEach(c => push(ref(db, 'clients'), c));
                
                // ×× ×™×© ×›×¤×•×œ×™× - ×”×¦×’×ª ××•×“××œ ×”×—×œ×˜×”
                if(pendingDupes.length > 0) {
                    const list = document.getElementById('dupeList');
                    list.innerHTML = pendingDupes.map(d => `<div style="border-bottom:1px solid #eee; padding:5px;"><b>${d.new.name}</b> (${d.new.phone}) <span style="color:red">×›×‘×¨ ×§×™×™× ×›-${d.old.name}</span></div>`).join('');
                    document.getElementById('dupeModal').style.display = 'flex';
                } else {
                    alert(`×”×™×™×‘×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”! × ×•×¡×¤×• ${batch.length} ×œ×§×•×—×•×ª.`);
                }
            };
            r.readAsArrayBuffer(f);
        }

        // ×˜×™×¤×•×œ ×‘×›×¤×•×œ×™× (Window func)
        window.resDupes = (act) => {
            if(act === 'create') {
                pendingDupes.forEach(d => push(ref(db, 'clients'), d.new));
                alert(`${pendingDupes.length} ×œ×§×•×—×•×ª ×›×¤×•×œ×™× × ×•×¦×¨×•.`);
            } else if(act === 'merge') {
                pendingDupes.forEach(d => {
                    const k = Object.keys(clients).find(key => clients[key] === d.old);
                    if(k) update(ref(db, `clients/${k}`), { 
                        notes: (d.old.notes||'')+'\n'+d.new.notes,
                        status: d.new.status === '×—×¡×•×' ? '×—×¡×•×' : d.old.status // ×× ×”×—×“×© ×—×¡×•× - × ×—×¡×•× ××ª ×”×™×©×Ÿ
                    });
                });
                alert('×”××™×“×¢ ××•×—×“ ×œ×ª×•×š ×”×”×¢×¨×•×ª ×©×œ ×”×œ×§×•×—×•×ª ×”×§×™×™××™×.');
            }
            document.getElementById('dupeModal').style.display='none';
        }

        // --- ×˜×‘×œ×” ×•×—×™×¤×•×© ××ª×§×“× ---
        window.renderTable = () => {
            const txt = document.getElementById('searchBox').value.toLowerCase();
            const flt = document.getElementById('filterStat').value;
            const th = document.getElementById('tHead');
            const tb = document.getElementById('tBody');
            
            // ×‘× ×™×™×ª ×›×•×ª×¨×•×ª ×“×™× ××™×ª
            let cols = ['checkbox','name','phone','status','city','agent'];
            showCols.forEach(c => { if(!cols.includes(c) && c!=='checkbox') cols.push(c); });
            
            let h = `<tr><th style="width:40px"><input type="checkbox" onchange="toggleAll(this)"></th>`;
            cols.filter(c=>c!=='checkbox').forEach(c => h+=`<th>${colName(c)}</th>`);
            h+=`<th>×¤×¢×•×œ×•×ª</th></tr>`;
            th.innerHTML = h;
            tb.innerHTML = '';

            Object.entries(clients).forEach(([k, c]) => {
                // ×¡×™× ×•×Ÿ ×”×¨×©××•×ª
                if(role!=='admin' && c.agent!==currentUser.email) return;
                // ×¡×™× ×•×Ÿ ×¡×˜×˜×•×¡
                if(flt && c.status!==flt) return;
                
                // ×—×™×¤×•×© ×¢××•×§ (×›×•×œ×œ ×™×œ×“×™× ×•×”×¢×¨×•×ª)
                const str = (JSON.stringify(c) + (c.children?JSON.stringify(c.children):'')).toLowerCase();
                if(txt && !str.includes(txt)) return;

                const tr = document.createElement('tr');
                if(c.status==='×—×¡×•×') tr.className = 'blocked-row';
                
                // ×ª× ×‘×—×™×¨×”
                let html = `<td><input type="checkbox" class="cb" value="${k}" onchange="chk()"></td>`;
                
                cols.filter(c=>c!=='checkbox').forEach(col => {
                    let v = '-';
                    if(col==='name') v = `<b>${c.name}</b><br><small style="color:#64748b">${c.spouse||''}</small>`;
                    else if(col==='status') {
                        // ×¢×¨×™×›×ª ×¡×˜×˜×•×¡ ××”×™×¨×”
                        v = `<select onchange="updStat('${k}',this.value)" style="padding:2px; height:auto; margin:0; font-size:12px; border:none; background:transparent; font-weight:bold;">
                            <option>${c.status}</option><option>×—×“×©</option><option>×‘×˜×™×¤×•×œ</option><option>××•"×</option><option>×—×•×–×”</option><option>×—×¡×•×</option>
                            </select>`;
                    }
                    else if(col==='agent') v = c.agent ? c.agent.split('@')[0] : '-';
                    else v = c[col] || (c.customData?c.customData[col]:'') || '-';
                    html += `<td>${v}</td>`;
                });
                
                // ×›×¤×ª×•×¨ ×¢×¨×™×›×”
                html += `<td><button class="btn-icon" onclick="edit('${k}')"><i class="fa-solid fa-pen"></i></button></td>`;
                tr.innerHTML = html;
                tb.appendChild(tr);
            });
        }

        window.colName = (k) => {
            const map = {name:'×œ×§×•×—', phone:'×˜×œ×¤×•×Ÿ', status:'×¡×˜×˜×•×¡', city:'×¢×™×¨', agent:'×¡×•×›×Ÿ', email:'××™×™×œ'};
            return map[k] || k;
        }

        window.updStat = (id, s) => update(ref(db, `clients/${id}`), {status:s, lastUpdate: Date.now()});
        
        window.toggleAll = (e) => { document.querySelectorAll('.cb').forEach(c=>c.checked=e.checked); chk(); };
        window.chk = () => {
            selected.clear();
            document.querySelectorAll('.cb:checked').forEach(c=>selected.add(c.value));
            document.getElementById('bulkActions').style.display = selected.size ? 'flex' : 'none';
            document.getElementById('selCount').innerText = selected.size + ' × ×‘×—×¨×•';
        }
        window.deleteBulk = () => {
            if(confirm(`×œ××—×•×§ ${selected.size} ×œ×§×•×—×•×ª ×œ×¦××™×ª×•×ª?`)) { 
                selected.forEach(id=>remove(ref(db, `clients/${id}`))); 
                selected.clear(); 
                chk(); 
            }
        }

        // --- ×¢×¨×™×›×” ×•× ×™×”×•×œ ×œ×§×•×— (×”×œ×‘ ×©×œ ×”××¢×¨×›×ª) ---
        window.edit = (id) => {
            const c = clients[id];
            document.getElementById('editId').value = id;
            document.getElementById('inpName').value = c.name;
            document.getElementById('inpPhone').value = c.phone;
            document.getElementById('inpPhone2').value = c.phone2||'';
            document.getElementById('inpSpouse').value = c.spouse||'';
            document.getElementById('inpEmail').value = c.email||'';
            document.getElementById('inpCity').value = c.city||'';
            document.getElementById('inpId').value = c.idNum||'';
            document.getElementById('inpStatus').value = c.status;
            document.getElementById('inpBudget').value = c.budget||'';
            document.getElementById('inpAgent').value = c.agent||'';
            document.getElementById('inpNotes').value = c.notes||'';
            
            // ×”×ª×¨××ª ×—×¡×™××”
            document.getElementById('blockedMsg').style.display = c.status==='×—×¡×•×'?'block':'none';
            // ×—×¡×™××ª ×ª×§×©×•×¨×ª ×œ×—×¡×•××™×
            document.querySelectorAll('.comms').forEach(b => b.disabled = (c.status==='×—×¡×•×'));

            // ×˜×¢×™× ×ª ×™×œ×“×™×
            const kl = document.getElementById('kidsList');
            kl.innerHTML = '';
            if(c.children) c.children.forEach(k => addKid(k.name, k.id));

            // ×˜×¢×™× ×ª ×©×“×•×ª ××™×•×—×“×™× (××§×¡×œ)
            const cf = document.getElementById('customFields');
            cf.innerHTML = '';
            const allFields = new Set([...customKeys, ...Object.keys(c.customData||{})]);
            allFields.forEach(k => {
                const val = (c.customData && c.customData[k]) ? c.customData[k] : '';
                cf.innerHTML += `<div><label style="font-size:11px; font-weight:bold;">${k}</label><input class="cf-inp" data-key="${k}" value="${val}" style="margin:0;"></div>`;
            });

            // ×”×¦×’×ª ×¤×’×™×©×•×ª ×”×œ×§×•×—
            renderClientMeetings(id);

            // ×›×¤×ª×•×¨ ××—×™×§×” ×¨×§ ×œ×× ×”×œ
            document.querySelector('.admin-only').style.display = role==='admin'?'inline-flex':'none';
            
            document.getElementById('clientModal').style.display = 'flex';
        }

        window.openClientModal = () => { 
            document.getElementById('editId').value=''; 
            document.getElementById('clientModal').style.display='flex'; 
            document.getElementById('kidsList').innerHTML=''; 
            document.getElementById('customFields').innerHTML='';
            // ×™×¦×™×¨×ª ×©×“×•×ª ×¨×™×§×™× ×œ×—×“×©
            customKeys.forEach(k => {
                document.getElementById('customFields').innerHTML += `<div><label style="font-size:11px; font-weight:bold;">${k}</label><input class="cf-inp" data-key="${k}" style="margin:0;"></div>`;
            });
        }

        window.closeModal = () => document.getElementById('clientModal').style.display='none';

        window.saveClient = () => {
            const id = document.getElementById('editId').value;
            const c = {
                name: document.getElementById('inpName').value,
                phone: document.getElementById('inpPhone').value,
                phone2: document.getElementById('inpPhone2').value,
                spouse: document.getElementById('inpSpouse').value,
                email: document.getElementById('inpEmail').value,
                city: document.getElementById('inpCity').value,
                idNum: document.getElementById('inpId').value,
                status: document.getElementById('inpStatus').value,
                budget: document.getElementById('inpBudget').value,
                notes: document.getElementById('inpNotes').value,
                agent: id ? document.getElementById('inpAgent').value : currentUser.email,
                lastUpdate: Date.now(),
                children: [],
                customData: {}
            };

            // ×©××™×¨×ª ×™×œ×“×™×
            document.querySelectorAll('.k-row').forEach(r => c.children.push({name:r.children[0].value, id:r.children[1].value}));
            // ×©××™×¨×ª ×©×“×•×ª ××™×•×—×“×™×
            document.querySelectorAll('.cf-inp').forEach(i => { if(i.value) c.customData[i.dataset.key]=i.value; });

            if(id) update(ref(db, `clients/${id}`), c);
            else push(ref(db, 'clients'), c);
            
            if(c.status==='×—×•×–×”') confetti({particleCount: 150, spread: 70});
            closeModal();
        }

        // --- ×’×¨×¤×™× ×•×“×©×‘×•×¨×“ ---
        window.updateCharts = () => {
            const src = {}; const cit = {};
            Object.values(clients).forEach(c => {
                const s = c.customData ? (c.customData['×™×©×™×‘×”']||c.customData['××§×•×¨']||c.customData['×™×©×™×‘×” ×‘×” ×œ××“']||'××—×¨') : '××—×¨';
                src[s] = (src[s]||0)+1;
                const city = c.city || '×œ× ×™×“×•×¢';
                cit[city] = (cit[city]||0)+1;
            });
            drawChart('chartSources', src, chartSourcesInstance, (i)=>chartSourcesInstance=i);
            drawChart('chartCities', cit, chartCitiesInstance, (i)=>chartCitiesInstance=i);
        }

        function drawChart(id, data, instance, setInstance) {
            if(instance) instance.destroy();
            const ctx = document.getElementById(id).getContext('2d');
            const keys = Object.keys(data).sort((a,b)=>data[b]-data[a]).slice(0,6); // Top 6
            setInstance(new Chart(ctx, {
                type: 'bar',
                data: { labels: keys, datasets: [{ label: '×›××•×ª', data: keys.map(k=>data[k]), backgroundColor: '#2563eb', borderRadius: 5 }] },
                options: { plugins: { legend: {display:false} }, scales: { y: {beginAtZero:true} } }
            }));
        }

        // --- ×©×•× ×•×ª (Helpers) ---
        window.nav = (p) => { document.querySelectorAll('.page').forEach(x=>x.classList.remove('active-page')); document.getElementById(p).classList.add('active-page'); document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); if(event) event.currentTarget.classList.add('active'); if(p==='calendar') renderCalendar(); }
        window.switchTab = (el, id) => { document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.tab-panel').forEach(c=>c.classList.remove('active')); el.classList.add('active'); document.getElementById(id).classList.add('active'); }
        window.addKid = (n='', i='') => document.getElementById('kidsList').insertAdjacentHTML('beforeend', `<div class="k-row" style="display:flex; gap:10px; margin-bottom:10px;"><input value="${n}" placeholder="×©× ×”×™×œ×“" style="margin:0;"><input value="${i}" placeholder="×ª.×–" style="margin:0;"><button class="btn-icon" onclick="this.parentElement.remove()" style="color:red;"><i class="fa-solid fa-minus"></i></button></div>`);
        window.addNoteTime = () => document.getElementById('inpNotes').value = `[${new Date().toLocaleString()} - ${currentUser.email.split('@')[0]}]\n` + document.getElementById('inpNotes').value;
        window.deleteClient = () => { if(confirm('×œ××—×•×§ ×œ×¦××™×ª×•×ª?')) { remove(ref(db, `clients/${document.getElementById('editId').value}`)); closeModal(); } }
        window.calc = () => { const p=Number(document.getElementById('calcLoan').value); const r=(settings.prime+0.5)/100/12; const n=300; document.getElementById('calcRes').innerText = Math.round(p*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1)).toLocaleString() + ' â‚ª'; }
        
        // ×›×¤×ª×•×¨×™ ×ª×§×©×•×¨×ª
        window.sendWa = () => window.open(`https://wa.me/972${document.getElementById('inpPhone').value.replace('0','')}`);
        window.sendMail = () => window.location.href=`mailto:${document.getElementById('inpEmail').value}`;
        window.makePdf = () => html2pdf(document.getElementById('t1'));
        
        // ×¡×˜×˜×™×¡×˜×™×§×•×ª
        window.updateStats = () => { const a=Object.values(clients); document.getElementById('stTotal').innerText=a.length; document.getElementById('stActive').innerText=a.filter(c=>['×‘×˜×™×¤×•×œ','××•"×'].includes(c.status)).length; document.getElementById('stDeals').innerText=a.filter(c=>c.status==='×—×•×–×”').length; }
        
        // ×ª×¤×¨×™×˜ ×¢××•×“×•×ª
        window.toggleColsMenu = () => { 
            const m = document.getElementById('colsMenu'); m.style.display = m.style.display==='block'?'none':'block'; 
            m.innerHTML = ''; [...showCols, ...customKeys].forEach(k => { if(k!=='checkbox') m.innerHTML += `<div><label><input type="checkbox" onchange="tCol('${k}')" ${showCols.includes(k)?'checked':''}> ${k}</label></div>`; });
        }
        window.tCol = (k) => { const i=showCols.indexOf(k); if(i>-1)showCols.splice(i,1); else showCols.push(k); renderTable(); }
        
        // ××©×ª××©×™× ×•×”×’×“×¨×•×ª
        window.addUser = () => push(ref(db,'users'), {email:document.getElementById('newUEmail').value, role:document.getElementById('newURole').value});
        window.renderUsersList = () => { document.getElementById('usersList').innerHTML = Object.values(users).map(u=>`<div style="border-bottom:1px solid #eee; padding:5px; display:flex; justify-content:space-between;"><span>${u.email}</span> <b>${u.role}</b></div>`).join(''); }
        window.saveSettings = () => update(ref(db, 'settings'), {prime: Number(document.getElementById('setPrime').value)}).then(()=>alert('×”×’×“×¨×•×ª × ×©××¨×•'));
        
        // ×™×™×¦×•× × ×ª×•× ×™×
        window.exportData = () => {
            const ws = XLSX.utils.json_to_sheet(Object.values(clients).map(c=>({...c, children:JSON.stringify(c.children), customData:JSON.stringify(c.customData)})));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Clients");
            XLSX.writeFile(wb, "Nadlan_Backup.xlsx");
        }

        // --- ×™×•××Ÿ ×•××©×™××•×ª (Calendar) ---
        window.openTaskModal = () => document.getElementById('taskModal').style.display='flex';
        window.openGeneralTask = () => { document.getElementById('quickTask').style.display='block'; };
        
        window.saveTask = () => { 
            push(ref(db,'meetings'), {clientId:'gen', clientName:'××©×™××” ××™×©×™×ª', date:document.getElementById('taskDate').value, time:document.getElementById('taskTime').value, note:document.getElementById('taskTitle').value, agent:currentUser.email}); 
            document.getElementById('taskModal').style.display='none'; 
        }
        
        window.addGenTask = () => {
            push(ref(db, 'meetings'), { clientId: 'gen', clientName: '××©×™××”', date: document.getElementById('gtDate').value, time: document.getElementById('gtTime').value, note: document.getElementById('gtTitle').value, agent: currentUser.email });
            document.getElementById('quickTask').style.display='none';
        };

        window.renderCalendar = () => {
            const g = document.getElementById('calGrid'); g.innerHTML='';
            const dates = {};
            // ××™×•×Ÿ ×•×§×™×‘×•×¥ ×¤×’×™×©×•×ª
            Object.values(meetings).sort((a,b)=>a.date.localeCompare(b.date)).forEach(m => { 
                if((role==='admin' || m.agent===currentUser.email) && !dates[m.date]) dates[m.date]=[]; 
                if(role==='admin' || m.agent===currentUser.email) dates[m.date].push(m); 
            });
            
            Object.keys(dates).forEach(d => {
                let h = `<div class="day-column"><div class="day-head"><span>${new Date(d).toLocaleDateString('he-IL',{weekday:'long'})}</span> <small>${d}</small></div>`;
                dates[d].forEach(m => h+=`<div class="cal-event" style="border-color:${m.clientId==='gen'?'var(--success)':'var(--accent)'}"><b>${m.time}</b> ${m.note}<br><span style="opacity:0.7">${m.clientName}</span></div>`);
                h+='</div>'; g.innerHTML+=h;
            });
        }
        
        // ×¤×’×™×©×•×ª ×‘×ª×•×š ×œ×§×•×—
        window.addMeeting = () => {
            const cid = document.getElementById('editId').value;
            if(!cid) return;
            push(ref(db, 'meetings'), {
                clientId: cid, clientName: document.getElementById('inpName').value,
                date: document.getElementById('mDate').value, time: document.getElementById('mTime').value,
                note: document.getElementById('mNote').value, agent: currentUser.email
            });
            renderClientMeetings(cid);
        };
        
        window.renderClientMeetings = (cid) => {
            const d = document.getElementById('clientMeetings');
            d.innerHTML = '';
            Object.values(meetings).filter(m => m.clientId === cid).sort((a,b)=>a.date.localeCompare(b.date)).forEach(m => {
                d.innerHTML += `<div style="background:white; padding:10px; margin-bottom:5px; border-radius:6px; border:1px solid #eee; display:flex; justify-content:space-between;">
                    <span><b>${m.date} ${m.time}</b>: ${m.note}</span>
                </div>`;
            });
        }

    </script>
</body>
</html>
