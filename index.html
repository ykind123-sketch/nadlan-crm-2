<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×“×œ"×Ÿ PRO 20.0 - ××¢×¨×›×ª ××œ××” (×œ×œ× ×§×™×¦×•×¨×™ ×“×¨×š)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- ×¢×™×¦×•×‘ ××ª×§×“× ×•××œ× --- */
        :root {
            --primary: #1e293b; --primary-light: #334155;
            --accent: #2563eb; --accent-hover: #1d4ed8;
            --bg: #f1f5f9; --surface: #ffffff; 
            --border: #cbd5e1; --text: #0f172a; --text-muted: #64748b;
            --danger: #dc2626; --success: #16a34a; --warning: #ca8a04;
            --radius: 8px; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Rubik', sans-serif; outline: none; transition: all 0.2s; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* ××¡×š ×›× ×™×¡×” */
        #loginOverlay { position: fixed; inset: 0; background: linear-gradient(135deg, var(--primary) 0%, #000 100%); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 16px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .login-inp { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 6px; font-size: 16px; }
        .login-btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px; }

        /* ×¡×¨×’×œ ×¦×“ */
        .layout { display: flex; height: 100%; width: 100%; }
        aside { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; box-shadow: 4px 0 10px rgba(0,0,0,0.1); z-index: 20; }
        .brand { padding: 25px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); }
        .nav { flex: 1; padding: 15px; overflow-y: auto; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; cursor: pointer; border-radius: 6px; color: #94a3b8; display: flex; align-items: center; gap: 10px; font-weight: 500; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: var(--accent); color: white; font-weight: 700; }
        .user-area { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); }

        /* ×ª×•×›×Ÿ ×¨××©×™ */
        main { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg); position: relative; }
        .page { display: none; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .title { font-size: 28px; font-weight: 800; color: var(--primary); }

        /* ×›×¨×˜×™×¡×™× ×•×’×¨×™×“ */
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 25px; }
        .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px; }
        .card { background: var(--surface); padding: 25px; border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow); height: 100%; }
        
        .stat-val { font-size: 42px; font-weight: 800; color: var(--text); line-height: 1; }
        .stat-lbl { font-size: 14px; color: var(--text-muted); margin-top: 5px; font-weight: 500; }

        /* ×˜×‘×œ×” */
        .table-container { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow); display: flex; flex-direction: column; height: calc(100vh - 180px); overflow: hidden; }
        .toolbar { padding: 15px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; background: #f8fafc; }
        .table-scroll { overflow: auto; flex: 1; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th { background: #f1f5f9; padding: 14px; text-align: right; font-weight: 700; color: #475569; position: sticky; top: 0; border-bottom: 2px solid var(--border); font-size: 13px; z-index: 5; }
        td { padding: 12px 14px; border-bottom: 1px solid var(--border); vertical-align: middle; color: #334155; font-size: 13px; }
        tr:hover { background: #eff6ff; }
        tr.blocked { background: #fef2f2 !important; }
        tr.blocked td { color: #991b1b; }

        /* ×›×¤×ª×•×¨×™× ×•××™× ×¤×•×˜×™× */
        .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-white { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-icon { padding: 8px; background: transparent; border: none; cursor: pointer; color: #64748b; font-size: 16px; border-radius: 4px; }
        .btn-icon:hover { background: #e2e8f0; color: var(--accent); }
        
        input, select, textarea { padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; width: 100%; background: white; }
        input:focus { border-color: var(--accent); outline: 2px solid #bfdbfe; }
        
        /* ×‘×—×™×¨×” ××”×™×¨×” ×‘×˜×‘×œ×” */
        .quick-select { border: none; background: transparent; font-weight: bold; cursor: pointer; padding: 4px; border-radius: 4px; }
        .quick-select:hover { background: rgba(0,0,0,0.05); }

        /* ××•×“××œ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; width: 95%; max-width: 1100px; border-radius: 16px; max-height: 95vh; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .modal-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: 16px 16px 0 0; }
        .modal-body { padding: 25px; overflow-y: auto; flex: 1; }
        .modal-foot { padding: 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: #f8fafc; border-radius: 0 0 16px 16px; }

        /* ×˜××‘×™× ×‘××•×“××œ */
        .tabs { display: flex; gap: 20px; border-bottom: 1px solid var(--border); margin-bottom: 25px; }
        .tab { padding: 10px 15px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; color: #64748b; }
        .tab.active { border-color: var(--accent); color: var(--accent); font-weight: 700; background: #eff6ff; border-radius: 6px 6px 0 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.2s; }

        /* ×ª×¤×¨×™×˜ ×¢××•×“×•×ª */
        .col-menu { position: absolute; top: 60px; left: 15px; background: white; border: 1px solid var(--border); padding: 15px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: none; z-index: 100; min-width: 200px; max-height: 400px; overflow-y: auto; }

        /* ×”×ª×¨××ª ×›×¤×™×œ×•×™×•×ª */
        .dupe-alert { background: #fff7ed; border: 1px solid #fed7aa; padding: 15px; border-radius: 8px; margin-bottom: 15px; color: #9a3412; }
        .dupe-list { max-height: 200px; overflow-y: auto; background: white; border: 1px solid var(--border); padding: 10px; margin-top: 10px; font-size: 13px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h1>ğŸ¢ × ×“×œ"×Ÿ PRO</h1>
            <p style="color:#64748b; margin-bottom:20px;">××¢×¨×›×ª × ×™×”×•×œ - ×’×¨×¡×” ××œ××” V20.0</p>
            <input type="email" id="txtEmail" class="login-inp" placeholder="××™××™×™×œ">
            <input type="password" id="txtPass" class="login-inp" placeholder="×¡×™×¡××”">
            <button class="login-btn" id="btnLogin">×”×ª×—×‘×¨ ×œ××¢×¨×›×ª</button>
            <div id="loginError" style="color:var(--danger); margin-top:10px;"></div>
        </div>
    </div>

    <div id="mainApp" style="display:none; height:100%;">
        <div class="layout">
            <aside>
                <div class="brand"><h3>× ×“×œ"×Ÿ PRO</h3><small>V20.0 Enterprise</small></div>
                <div class="nav">
                    <div class="nav-item active" onclick="nav('dashboard')"><i class="fa-solid fa-chart-pie"></i> ×“×©×‘×•×¨×“</div>
                    <div class="nav-item" onclick="nav('crm')"><i class="fa-solid fa-users"></i> ×××’×¨ ×œ×§×•×—×•×ª</div>
                    <div class="nav-item" onclick="nav('calendar')"><i class="fa-solid fa-calendar-days"></i> ×™×•××Ÿ ×•××©×™××•×ª</div>
                    <div class="nav-item" onclick="nav('projects')"><i class="fa-solid fa-building"></i> ×¤×¨×•×™×§×˜×™×</div>
                    <div class="nav-item" onclick="nav('settings')"><i class="fa-solid fa-cog"></i> ×”×’×“×¨×•×ª</div>
                </div>
                <div class="user-area">
                    <div><div id="lblUser">User</div><div id="lblRole" style="font-size:11px; opacity:0.7;">Role</div></div>
                    <i class="fa-solid fa-power-off" style="cursor:pointer;" onclick="doLogout()"></i>
                </div>
            </aside>

            <main>
                <section id="dashboard" class="page" style="display:block;">
                    <div class="header">
                        <div class="title">×“×©×‘×•×¨×“ ×× ×”×œ×™×</div>
                        <div id="dateDisplay" style="font-weight:bold; color:var(--accent);"></div>
                    </div>
                    
                    <div class="grid-3">
                        <div class="card">
                            <div class="stat-val" id="stTotal">0</div>
                            <div class="stat-lbl">×œ×§×•×—×•×ª ×‘×××’×¨</div>
                        </div>
                        <div class="card">
                            <div class="stat-val" id="stActive">0</div>
                            <div class="stat-lbl">×œ×§×•×—×•×ª ×‘×˜×™×¤×•×œ</div>
                        </div>
                        <div class="card">
                            <div class="stat-val" id="stDeals">0</div>
                            <div class="stat-lbl">×¢×¡×§××•×ª ×”×—×•×“×©</div>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="card">
                            <h3>ğŸŒ ×¤×™×œ×•×— ××§×•×¨×•×ª (×™×©×™×‘×•×ª/××•×¡×“×•×ª)</h3>
                            <canvas id="sourceChart" height="200"></canvas>
                        </div>
                        <div class="card">
                            <h3>ğŸ˜ï¸ ×¤×™×œ×•×— ×¢×¨×™×</h3>
                            <canvas id="cityChart" height="200"></canvas>
                        </div>
                    </div>
                </section>

                <section id="crm" class="page">
                    <div class="header">
                        <div class="title">×××’×¨ ×”×œ×§×•×—×•×ª</div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-white" onclick="document.getElementById('excelIn').click()"><i class="fa-solid fa-file-import"></i> ×™×™×‘×•× ××§×¡×œ ××œ×</button>
                            <input type="file" id="excelIn" hidden>
                            <button class="btn btn-white admin-only" onclick="exportExcel()"><i class="fa-solid fa-file-export"></i> ×™×™×¦×•×</button>
                            <button class="btn btn-primary" onclick="openModal()"><i class="fa-solid fa-plus"></i> ×œ×§×•×— ×—×“×©</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="toolbar">
                            <div style="position:relative; flex:1;">
                                <i class="fa-solid fa-search" style="position:absolute; right:10px; top:10px; color:#94a3b8;"></i>
                                <input type="text" id="searchBox" placeholder="×—×™×¤×•×© ×¢××•×§: ×©×, ×˜×œ×¤×•×Ÿ, ×™×œ×“×™×, ×”×¢×¨×•×ª, ×™×©×™×‘×”..." onkeyup="renderTable()" style="padding-right:35px; margin:0;">
                            </div>
                            <select id="filterStat" onchange="renderTable()" style="width:150px; margin:0; font-weight:bold;">
                                <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                                <option>×—×“×©</option>
                                <option>×‘×˜×™×¤×•×œ</option>
                                <option>××•"×</option>
                                <option>×—×•×–×”</option>
                                <option value="×—×¡×•×">â›” ×¨×©×™××” ×©×—×•×¨×”</option>
                            </select>
                            <button class="btn btn-white" onclick="toggleColsMenu()"><i class="fa-solid fa-table-columns"></i> ×¢××•×“×•×ª</button>
                            
                            <div id="bulkActions" style="display:none; gap:5px; border-right:1px solid #ddd; padding-right:10px;">
                                <button class="btn btn-danger admin-only" onclick="deleteSelected()"><i class="fa-solid fa-trash"></i> ××—×§ ××¡×•×× ×™×</button>
                                <span id="selCount" style="font-size:12px; line-height:30px;">0 × ×‘×—×¨×•</span>
                            </div>
                        </div>

                        <div id="colsMenu" class="col-menu"></div>

                        <div class="table-scroll">
                            <table id="mainTable">
                                <thead id="tableHead"></thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="calendar" class="page">
                    <div class="header">
                        <div class="title">×™×•××Ÿ ××©×™××•×ª</div>
                        <button class="btn btn-primary" onclick="openGeneralTask()">+ ××©×™××” ××™×©×™×ª</button>
                    </div>
                    <div id="quickTask" class="card" style="display:none; margin-bottom:20px; background:#eff6ff; border-color:#bfdbfe;">
                        <h4>×”×•×¡×¤×ª ××©×™××” ×œ×™×•××Ÿ</h4>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <input id="gtTitle" placeholder="×ª×™××•×¨ ×”××©×™××”...">
                            <input type="date" id="gtDate">
                            <input type="time" id="gtTime" value="09:00">
                            <button class="btn btn-primary" onclick="addGenTask()">×©××•×¨</button>
                            <button class="btn btn-white" onclick="document.getElementById('quickTask').style.display='none'">×‘×™×˜×•×œ</button>
                        </div>
                    </div>
                    <div id="calGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:20px;"></div>
                </section>
                
                <section id="projects" class="page">
                    <div class="header"><div class="title">×¤×¨×•×™×§×˜×™×</div></div>
                    <div class="card" style="text-align:center; padding:50px;">
                        <h3>ğŸš§ ××•×“×•×œ ×‘×‘× ×™×™×”</h3>
                        <p>×›××Ÿ ×™×•×¤×™×¢ ××œ××™ ×”×“×™×¨×•×ª ×•×”×‘× ×™×™× ×™× ×‘×’×¨×¡×” ×”×‘××”.</p>
                    </div>
                </section>

                <section id="settings" class="page">
                    <div class="header"><div class="title">×”×’×“×¨×•×ª</div></div>
                    <div class="grid-2">
                        <div class="card">
                            <h3>×”×’×“×¨×•×ª ×›×œ×œ×™×•×ª</h3>
                            <label>×¨×™×‘×™×ª ×¤×¨×™×™× (%)</label>
                            <input type="number" id="setPrime" value="6.0">
                            <button class="btn btn-primary" onclick="saveSettings()">×©××•×¨</button>
                        </div>
                        <div class="card admin-only">
                            <h3>××©×ª××©×™× ×•×”×¨×©××•×ª</h3>
                            <div id="usersList" style="height:150px; overflow-y:auto; border:1px solid #eee; margin-bottom:10px; padding:5px;"></div>
                            <div style="display:flex; gap:5px;">
                                <input id="newUEmail" placeholder="××™××™×™×œ">
                                <select id="newURole"><option value="agent">×¡×•×›×Ÿ</option><option value="admin">×× ×”×œ</option></select>
                                <button class="btn btn-primary" onclick="addUser()">×”×•×¡×£</button>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <div id="clientModal" class="modal">
        <div class="modal-box">
            <div class="modal-head">
                <h2 id="modalTitle">×›×¨×˜×™×¡ ×œ×§×•×—</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn-icon" onclick="printClient()"><i class="fa-solid fa-print"></i></button>
                    <button class="btn-icon" onclick="document.getElementById('clientModal').style.display='none'"><i class="fa-solid fa-times"></i></button>
                </div>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                
                <div id="blockedMsg" style="display:none; background:#fef2f2; color:#991b1b; padding:15px; border-radius:8px; margin-bottom:20px; text-align:center; font-weight:bold; border:1px solid #fecaca;">
                    â›” ×œ×§×•×— ×–×” ×—×¡×•× (×¨×©×™××” ×©×—×•×¨×”). ××™×Ÿ ×œ×™×¦×•×¨ ×§×©×¨!
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="tab('t1', this)">×¤×¨×˜×™× ××™×©×™×™×</div>
                    <div class="tab" onclick="tab('t2', this)">××©×¤×—×”</div>
                    <div class="tab" onclick="tab('t3', this)">×¡×˜×˜×•×¡</div>
                    <div class="tab" onclick="tab('t5', this)">×™×•××Ÿ</div>
                    <div class="tab" onclick="tab('t4', this)">×›×œ×™×</div>
                </div>

                <div id="t1" class="tab-content active">
                    <div class="grid-2">
                        <div>
                            <label>×©× ××œ×</label><input id="inpName">
                            <label>×‘×Ÿ/×‘×ª ×–×•×’</label><input id="inpSpouse">
                            <label>×˜×œ×¤×•×Ÿ (×—×•×‘×”)</label><input id="inpPhone">
                            <label>×˜×œ×¤×•×Ÿ × ×•×¡×£</label><input id="inpPhone2">
                            <label>××™××™×™×œ</label><input id="inpEmail">
                            <label>×ª.×–</label><input id="inpId">
                        </div>
                        <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0;">
                            <h4 style="color:var(--accent); margin-bottom:10px;">×©×“×•×ª × ×•×¡×¤×™× (××”××§×¡×œ)</h4>
                            <div id="customFieldsContainer"></div>
                        </div>
                    </div>
                </div>

                <div id="t2" class="tab-content">
                    <div id="kidsList"></div>
                    <button class="btn btn-white" onclick="addKidRow()" style="width:100%; margin-top:10px;">+ ×”×•×¡×£ ×™×œ×“</button>
                </div>

                <div id="t3" class="tab-content">
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <div style="flex:1"><label>×¡×˜×˜×•×¡</label><select id="inpStatus"><option>×—×“×©</option><option>×‘×˜×™×¤×•×œ</option><option>××•"×</option><option>×—×•×–×”</option><option>×—×¡×•×</option></select></div>
                        <div style="flex:1"><label>×ª×§×¦×™×‘</label><input type="number" id="inpBudget"></div>
                        <div style="flex:1"><label>×¡×•×›×Ÿ ××˜×¤×œ</label><input id="inpAgent" readonly style="background:#eee;"></div>
                    </div>
                    <label>×”×¢×¨×•×ª ×•×”×™×¡×˜×•×¨×™×” (×›×•×œ×œ × ×ª×•× ×™× ×’×•×œ××™×™×)</label>
                    <textarea id="inpNotes" rows="12" style="font-family:monospace; line-height:1.5; font-size:13px;"></textarea>
                    <button class="btn btn-white" onclick="addTime()">×”×•×¡×£ ×—×•×ª××ª ×–××Ÿ</button>
                </div>

                <div id="t5" class="tab-content">
                    <div class="card" style="margin-bottom:15px; background:#eff6ff;">
                        <h4>×¤×’×™×©×” ×—×“×©×”</h4>
                        <div style="display:flex; gap:10px;">
                            <input type="date" id="mDate">
                            <input type="time" id="mTime">
                            <input id="mNote" placeholder="× ×•×©×...">
                            <button class="btn btn-primary" onclick="addMeeting()">×©×‘×¥</button>
                        </div>
                    </div>
                    <div id="clientMeetings"></div>
                </div>

                <div id="t4" class="tab-content">
                    <div class="grid-2">
                        <div class="card" style="margin:0;">
                            <h4>××—×©×‘×•×Ÿ ××©×›× ×ª×</h4>
                            <input type="number" id="calcAmount" placeholder="×¡×›×•× ×”×œ×•×•××”">
                            <h3 id="calcRes" style="margin-top:10px;">0 â‚ª</h3>
                            <button class="btn btn-primary" onclick="calcMortgage()" style="width:100%;">×—×©×‘</button>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <button class="btn btn-white comms" onclick="wa()"><i class="fa-brands fa-whatsapp" style="color:#25D366;"></i> ×•×•××˜×¡××¤</button>
                            <button class="btn btn-white comms" onclick="mail()"><i class="fa-solid fa-envelope"></i> ××™××™×™×œ</button>
                            <button class="btn btn-white" onclick="pdf()"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-danger admin-only" id="btnDel" onclick="delClient()">××—×§ ×œ×§×•×—</button>
                <div style="flex:1"></div>
                <button class="btn btn-white" onclick="document.getElementById('clientModal').style.display='none'">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveClient()">×©××•×¨ ×©×™× ×•×™×™×</button>
            </div>
        </div>
    </div>

    <div id="dupeModal" class="modal">
        <div class="modal-box" style="max-width:600px;">
            <div class="modal-head" style="background:#fff7ed; color:#c2410c;">
                <h2>âš ï¸ ×”×ª×’×œ×• ×›×¤×™×œ×•×™×•×ª ×‘×™×™×‘×•×</h2>
            </div>
            <div class="modal-body">
                <p>×”××¢×¨×›×ª ×–×™×”×ª×” ×©×œ×§×•×—×•×ª ××œ×• ×›×‘×¨ ×§×™×™××™× ×‘×××’×¨. ××” ×ª×¨×¦×” ×œ×¢×©×•×ª?</p>
                <div id="dupeList" style="max-height:200px; overflow-y:auto; background:#f8fafc; padding:10px; border:1px solid #ddd; margin:10px 0; font-size:13px;"></div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-white" onclick="resolveDupes('skip')">×“×œ×’ ×¢×œ ×›×•×œ×</button>
                    <button class="btn btn-primary" onclick="resolveDupes('merge')">××—×“ × ×ª×•× ×™× (×”×•×¡×£ ×œ×”×¢×¨×•×ª)</button>
                    <button class="btn btn-danger" onclick="resolveDupes('create')">×¦×•×¨ ×›×¤×•×œ×™×</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJvUDVuccEZSuTsUSs7o-hnpME2WaTWio", 
            authDomain: "nadlan-pro.firebaseapp.com",
            projectId: "nadlan-pro",
            storageBucket: "nadlan-pro.firebasestorage.app",
            messagingSenderId: "435010903224",
            appId: "1:435010903224:web:53cc66ba40fa3d4198e84d",
            measurementId: "G-VRX35WJ2PE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let userRole = 'agent';
        let clients = {};
        let meetings = {};
        let users = {};
        let settings = { prime: 6.0 };
        let customFields = new Set(['×™×©×™×‘×”','×¨×—×•×‘','××¡×¤×¨','××§×•×¨']);
        let visibleCols = ['checkbox', 'name', 'phone', 'status', 'city', 'agent'];
        let selectedIDs = new Set();
        let pendingDupes = []; // ×œ×©××™×¨×ª ×”×›×¤×•×œ×™× ×¢×“ ×œ×”×—×œ×˜×”
        let charts = {};

        // --- Auth ---
        document.getElementById('btnLogin').onclick = () => {
            signInWithEmailAndPassword(auth, document.getElementById('txtEmail').value, document.getElementById('txtPass').value)
            .catch(e => document.getElementById('loginError').innerText = e.message);
        };

        onAuthStateChanged(auth, u => {
            if(u) {
                currentUser = u;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('lblUser').innerText = u.email;
                document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('he-IL');
                loadData();
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        window.doLogout = () => signOut(auth);

        function loadData() {
            onValue(ref(db, 'users'), s => {
                users = s.val() || {};
                const me = Object.values(users).find(u => u.email === currentUser.email);
                userRole = (!Object.keys(users).length) ? 'admin' : (me ? me.role : 'agent');
                if(!Object.keys(users).length) push(ref(db, 'users'), {email: currentUser.email, role: 'admin'});
                document.getElementById('lblRole').innerText = userRole==='admin'?'×× ×”×œ':'×¡×•×›×Ÿ';
                
                document.querySelectorAll('.admin-only').forEach(e => e.style.display = userRole==='admin'?'inline-flex':'none');
                renderUsers();
            });

            onValue(ref(db, 'clients'), s => {
                clients = s.val() || {};
                // ×¢×“×›×•×Ÿ ×©×“×•×ª ××™×•×—×“×™×
                Object.values(clients).forEach(c => {
                    if(c.customData) Object.keys(c.customData).forEach(k => customFields.add(k));
                });
                renderTable();
                updateStats();
                updateCharts();
            });

            onValue(ref(db, 'meetings'), s => {
                meetings = s.val() || {};
                renderCalendar();
            });
            
            onValue(ref(db, 'settings'), s => {
                if(s.val()) settings = s.val();
                if(document.getElementById('setPrime')) document.getElementById('setPrime').value = settings.prime || 6.0;
            });
        }

        // --- ×™×™×‘×•× ××§×¡×œ (×”×× ×’× ×•×Ÿ ×”××œ×) ---
        document.getElementById('excelIn').onchange = (e) => {
            const f = e.target.files[0];
            const reader = new FileReader();
            reader.onload = ex => {
                const wb = XLSX.read(new Uint8Array(ex.target.result), {type:'array'});
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                
                let newBatch = [];
                pendingDupes = [];
                const isBlacklist = f.name.includes('×œ××—×•×§') || f.name.includes('×—×¡×•×');

                const find = (row, words) => {
                    const k = Object.keys(row).find(key => words.some(w => key.includes(w)));
                    return k ? row[k] : '';
                };

                data.forEach(row => {
                    const phone = String(find(row, ['× ×™×™×“','×˜×œ×¤×•×Ÿ'])||'').replace(/\D/g,'');
                    const idNum = String(find(row, ['×ª.×–','×–×”×•×ª'])||'');
                    
                    // ×‘×“×™×§×ª ×›×¤×™×œ×•×ª
                    const exists = Object.values(clients).find(c => (c.phone===phone && phone.length>6) || (c.idNum===idNum && idNum.length>6));
                    
                    const c = {
                        name: (find(row, ['×©× ××©×¤×—×”','×©×'])||'×œ×œ× ×©×') + ' ' + (find(row, ['×¤×¨×˜×™'])||''),
                        spouse: find(row, ['××©×”','×–×•×’'])||'',
                        phone: phone,
                        phone2: String(find(row, ['× ×•×¡×£','2'])||'').replace(/\D/g,''),
                        email: find(row, ['××™×™×œ','×“×•×'])||'',
                        idNum: idNum,
                        city: find(row, ['×¢×™×¨','×›×ª×•×‘×ª'])||'',
                        status: isBlacklist ? '×—×¡×•×' : '×—×“×©',
                        notes: `--- ×™×™×‘×•× ${f.name} ---\n`,
                        agent: currentUser.email,
                        lastUpdate: Date.now(),
                        children: [],
                        customData: {}
                    };

                    // ××™×¡×•×£ ×›×œ ×”×©×“×•×ª
                    for(let [k,v] of Object.entries(row)) {
                        if(v) {
                            c.notes += `${k}: ${v}\n`;
                            // ×–×™×”×•×™ ×©×“×•×ª ××™×•×—×“×™× ××•×˜×•××˜×™
                            if(!['×©×','×˜×œ×¤×•×Ÿ','××™×™×œ','×ª.×–'].some(x=>k.includes(x))) {
                                c.customData[k] = v;
                                customFields.add(k);
                            }
                        }
                    }

                    // ×™×œ×“×™×
                    for(let i=1; i<15; i++) {
                        const kn = find(row, [`×™×œ×“ ${i}`,`×©× ×”×™×œ×“${i}`]);
                        if(kn) c.children.push({name:kn, id: find(row, [`×–×”×•×ª ${i}`])||''});
                    }

                    if(exists) {
                        pendingDupes.push({new: c, old: exists});
                    } else if(phone) {
                        newBatch.push(c);
                    }
                });

                // ×©××™×¨×ª ×”×—×“×©×™×
                newBatch.forEach(c => push(ref(db, 'clients'), c));
                
                // ×˜×™×¤×•×œ ×‘×›×¤×•×œ×™×
                if(pendingDupes.length > 0) {
                    const list = document.getElementById('dupeList');
                    list.innerHTML = pendingDupes.map(d => `<div style="border-bottom:1px solid #eee; padding:5px;"><b>${d.new.name}</b> (${d.new.phone}) - ×§×™×™× ×›×‘×¨ ×›-${d.old.name}</div>`).join('');
                    document.getElementById('dupeModal').style.display = 'flex';
                } else {
                    alert(`×™×™×‘×•× ×”×•×©×œ×! ${newBatch.length} ×œ×§×•×—×•×ª ×—×“×©×™×.`);
                }
            };
            reader.readAsArrayBuffer(f);
        };

        window.resolveDupes = (action) => {
            if(action === 'create') {
                pendingDupes.forEach(d => push(ref(db, 'clients'), d.new));
                alert(`${pendingDupes.length} ×œ×§×•×—×•×ª ×›×¤×•×œ×™× × ×•×¦×¨×•.`);
            } else if(action === 'merge') {
                // ×¨×§ ××•×¡×™×£ ×œ×”×¢×¨×•×ª ×©×œ ×”×™×©×Ÿ
                pendingDupes.forEach(d => {
                    const oldKey = Object.keys(clients).find(k => clients[k] === d.old);
                    if(oldKey) update(ref(db, `clients/${oldKey}`), { 
                        notes: (d.old.notes || '') + '\n' + d.new.notes,
                        status: d.new.status === '×—×¡×•×' ? '×—×¡×•×' : d.old.status // ×× ×”×—×“×© ×—×¡×•×, × ×—×¡×•× ××ª ×”×™×©×Ÿ
                    });
                });
                alert('×”× ×ª×•× ×™× ××•×—×“×• ×‘×”×¢×¨×•×ª.');
            }
            document.getElementById('dupeModal').style.display = 'none';
        };

        // --- ×˜×‘×œ×” ×•×—×™×¤×•×© ××ª×§×“× ---
        window.renderTable = () => {
            const tbody = document.getElementById('tableBody');
            const thead = document.getElementById('tableHead');
            const term = document.getElementById('searchBox').value.toLowerCase();
            const filter = document.getElementById('filterStat').value;
            
            // ×‘× ×™×™×ª ×›×•×ª×¨×•×ª
            let cols = ['checkbox', 'name', 'phone', 'status', 'city', 'agent'];
            visibleCols.forEach(c => { if(!cols.includes(c) && c!=='checkbox') cols.push(c); });
            
            let h = `<tr><th style="width:30px"><input type="checkbox" onchange="toggleAll(this)"></th>`;
            cols.filter(c=>c!=='checkbox').forEach(c => h+=`<th>${colTrans(c)}</th>`);
            h+=`<th>×¤×¢×•×œ×•×ª</th></tr>`;
            thead.innerHTML = h;
            tbody.innerHTML = '';

            Object.entries(clients).forEach(([k, c]) => {
                if(userRole!=='admin' && c.agent!==currentUser.email) return;
                if(filter && c.status!==filter) return;
                
                // ×—×™×¤×•×© ×¨× ×˜×’×Ÿ
                const fullStr = JSON.stringify(c).toLowerCase();
                if(term && !fullStr.includes(term)) return;

                const tr = document.createElement('tr');
                if(c.status==='×—×¡×•×') tr.className = 'blocked';

                let html = `<td><input type="checkbox" class="cb" value="${k}" onchange="chk()"></td>`;
                cols.filter(c=>c!=='checkbox').forEach(col => {
                    let val = '-';
                    if(col==='name') val = `<b>${c.name}</b><br><small>${c.spouse||''}</small>`;
                    else if(col==='status') val = `<select class="quick-select" onchange="setStatus('${k}',this.value)" style="background:${stColor(c.status)}">
                        <option>${c.status}</option><option>×—×“×©</option><option>×‘×˜×™×¤×•×œ</option><option>××•"×</option><option>×—×•×–×”</option><option>×—×¡×•×</option></select>`;
                    else if(col==='agent') val = c.agent ? c.agent.split('@')[0] : '-';
                    else val = c[col] || (c.customData?c.customData[col]:'') || '-';
                    html += `<td>${val}</td>`;
                });
                html += `<td><button class="btn-icon" onclick="edit('${k}')"><i class="fa-solid fa-pen"></i></button></td>`;
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        };

        window.setStatus = (id, s) => update(ref(db, `clients/${id}`), {status: s, lastUpdate: Date.now()});
        
        window.toggleAll = (el) => {
            document.querySelectorAll('.cb').forEach(c => c.checked = el.checked);
            window.chk();
        }
        
        window.chk = () => {
            selectedIDs.clear();
            document.querySelectorAll('.cb:checked').forEach(c => selectedIDs.add(c.value));
            document.getElementById('bulkActions').style.display = selectedIDs.size?'flex':'none';
            document.getElementById('selCount').innerText = selectedIDs.size + ' × ×‘×—×¨×•';
        }

        window.deleteSelected = () => {
            if(confirm(`×œ××—×•×§ ${selectedIDs.size} ×œ×§×•×—×•×ª?`)) {
                selectedIDs.forEach(id => remove(ref(db, `clients/${id}`)));
                selectedIDs.clear();
                window.chk();
            }
        };

        // --- ×¢×¨×™×›×” (×ª×™×§×•×Ÿ ×›×¤×ª×•×¨ ×”×¢×™×¤×¨×•×Ÿ) ---
        window.edit = (id) => {
            const c = clients[id];
            document.getElementById('editId').value = id;
            document.getElementById('inpName').value = c.name;
            document.getElementById('inpSpouse').value = c.spouse || '';
            document.getElementById('inpPhone').value = c.phone;
            document.getElementById('inpPhone2').value = c.phone2 || '';
            document.getElementById('inpEmail').value = c.email || '';
            document.getElementById('inpId').value = c.idNum || '';
            document.getElementById('inpStatus').value = c.status;
            document.getElementById('inpBudget').value = c.budget || '';
            document.getElementById('inpAgent').value = c.agent || '';
            document.getElementById('inpNotes').value = c.notes || '';
            
            // ×”×¦×’×ª ×”×ª×¨××” ×œ×—×¡×•××™×
            const isBlocked = c.status === '×—×¡×•×';
            document.getElementById('blockedMsg').style.display = isBlocked ? 'block' : 'none';
            document.querySelectorAll('.comms').forEach(b => b.disabled = isBlocked);

            // ×™×œ×“×™×
            const kl = document.getElementById('kidsList');
            kl.innerHTML = '';
            if(c.children) c.children.forEach(k => addKidRow(k.name, k.id));
            
            // ×©×“×•×ª ××™×•×—×“×™× (×“×™× ××™)
            const cf = document.getElementById('customFieldsContainer');
            cf.innerHTML = '';
            // ××™×—×•×“ ×›×œ ×”×©×“×•×ª ×©×™×© ×‘××¢×¨×›×ª + ×©×“×•×ª ×©×™×© ×œ×œ×§×•×— ×”×–×”
            const allFields = new Set([...customFields, ...Object.keys(c.customData||{})]);
            allFields.forEach(k => {
                const val = (c.customData && c.customData[k]) ? c.customData[k] : '';
                cf.innerHTML += `<div><label style="font-size:11px;">${k}</label><input class="cf-input" data-key="${k}" value="${val}"></div>`;
            });

            renderClientMeetings(id);
            document.getElementById('btnDel').style.display = userRole==='admin'?'block':'none';
            document.getElementById('clientModal').style.display = 'flex';
        };

        window.saveClient = () => {
            const id = document.getElementById('editId').value;
            const c = {
                name: document.getElementById('inpName').value,
                spouse: document.getElementById('inpSpouse').value,
                phone: document.getElementById('inpPhone').value,
                phone2: document.getElementById('inpPhone2').value,
                email: document.getElementById('inpEmail').value,
                idNum: document.getElementById('inpId').value,
                status: document.getElementById('inpStatus').value,
                budget: document.getElementById('inpBudget').value,
                notes: document.getElementById('inpNotes').value,
                agent: id ? document.getElementById('inpAgent').value : currentUser.email,
                lastUpdate: Date.now(),
                children: [],
                customData: {}
            };

            document.querySelectorAll('.kid-row').forEach(r => c.children.push({
                name: r.querySelector('.kn').value, 
                id: r.querySelector('.ki').value
            }));
            
            document.querySelectorAll('.cf-input').forEach(i => {
                if(i.value) c.customData[i.dataset.key] = i.value;
            });

            if(id) update(ref(db, `clients/${id}`), c);
            else push(ref(db, 'clients'), c);
            
            if(c.status==='×—×•×–×”') confetti();
            document.getElementById('clientModal').style.display='none';
        };

        // --- ×’×¨×¤×™× ×•×“×©×‘×•×¨×“ ---
        window.updateCharts = () => {
            const cities = {};
            const sources = {};
            
            Object.values(clients).forEach(c => {
                const city = c.city || '×œ× ×™×“×•×¢';
                cities[city] = (cities[city]||0)+1;

                // ×—×™×¤×•×© ××§×•×¨/×™×©×™×‘×”
                const src = c.customData ? (c.customData['×™×©×™×‘×”'] || c.customData['××§×•×¨'] || c.customData['×™×©×™×‘×” ×‘×” ×œ××“']) : '××—×¨';
                if(src) sources[src] = (sources[src]||0)+1;
            });
            
            drawChart('cityChart', cities, '×¢×¨×™×');
            drawChart('sourceChart', sources, '××§×•×¨×•×ª');
        };

        function drawChart(id, data, label) {
            const ctx = document.getElementById(id).getContext('2d');
            const keys = Object.keys(data).sort((a,b)=>data[b]-data[a]).slice(0,5);
            const vals = keys.map(k=>data[k]);
            
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: 'bar',
                data: { labels: keys, datasets: [{ label: label, data: vals, backgroundColor: '#3b82f6' }] },
                options: { responsive: true, plugins: { legend: {display:false} } }
            });
        }

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ---
        window.openModal = () => { document.getElementById('editId').value=''; document.getElementById('clientModal').style.display='flex'; document.getElementById('kidsList').innerHTML=''; document.getElementById('customFieldsContainer').innerHTML=''; };
        window.tab = (id, el) => { document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); el.classList.add('active'); document.getElementById(id).classList.add('active'); };
        window.addKidRow = (n='', i='') => document.getElementById('kidsList').insertAdjacentHTML('beforeend', `<div class="kid-row" style="display:flex; gap:5px; margin-bottom:5px;"><input class="kn" value="${n}" placeholder="×©×"><input class="ki" value="${i}" placeholder="×ª.×–"><button class="btn-icon" onclick="this.parentElement.remove()">x</button></div>`);
        window.addTime = () => document.getElementById('inpNotes').value = `[${new Date().toLocaleString()} ${currentUser.email.split('@')[0]}] ` + document.getElementById('inpNotes').value;
        window.delClient = () => { if(confirm('×œ××—×•×§?')) { remove(ref(db, `clients/${document.getElementById('editId').value}`)); document.getElementById('clientModal').style.display='none'; } };
        window.stColor = (s) => ({'×—×“×©':'#fff','×‘×˜×™×¤×•×œ':'#eff6ff','××•"×':'#fef9c3','×—×•×–×”':'#dcfce7','×—×¡×•×':'#fee2e2'}[s]||'#fff');
        window.colTrans = (k) => ({name:'×©×', phone:'×˜×œ×¤×•×Ÿ', status:'×¡×˜×˜×•×¡', city:'×¢×™×¨', agent:'×¡×•×›×Ÿ'}[k]||k);
        window.toggleColsMenu = () => { 
            const m = document.getElementById('colsMenu'); 
            m.style.display = m.style.display==='block'?'none':'block';
            m.innerHTML = '';
            [...visibleCols, ...customFields].forEach(k => {
                if(k!=='checkbox') m.innerHTML += `<div><label><input type="checkbox" onchange="toggleCol('${k}')" ${visibleCols.includes(k)?'checked':''}> ${colTrans(k)}</label></div>`;
            });
        };
        window.toggleCol = (k) => { const i=visibleCols.indexOf(k); if(i>-1)visibleCols.splice(i,1); else visibleCols.push(k); renderTable(); };
        window.updateStats = () => { const a=Object.values(clients); document.getElementById('stTotal').innerText=a.length; document.getElementById('stActive').innerText=a.filter(c=>['×‘×˜×™×¤×•×œ','××•"×'].includes(c.status)).length; document.getElementById('stDeals').innerText=a.filter(c=>c.status==='×—×•×–×”').length; };
        
        // ×™×•××Ÿ ×•××©×™××•×ª
        window.openGeneralTask = () => { document.getElementById('quickTask').style.display='block'; };
        window.addGenTask = () => {
            push(ref(db, 'meetings'), { clientId: 'general', clientName: '××©×™××”', date: document.getElementById('gtDate').value, time: document.getElementById('gtTime').value, note: document.getElementById('gtTitle').value, agent: currentUser.email });
            document.getElementById('quickTask').style.display='none';
        };
        window.renderCalendar = () => {
            const d = document.getElementById('calGrid');
            d.innerHTML = '';
            const grouped = {};
            Object.values(meetings).sort((a,b)=>a.date.localeCompare(b.date)).forEach(m => {
                if(!grouped[m.date]) grouped[m.date]=[];
                grouped[m.date].push(m);
            });
            Object.keys(grouped).forEach(date => {
                let html = `<div class="day-col"><div class="day-title">${new Date(date).toLocaleDateString('he-IL')}</div>`;
                grouped[date].forEach(m => html += `<div class="cal-event" style="border-color:${m.clientId==='general'?'#22c55e':'#3b82f6'}"><b>${m.time}</b> ${m.note}<br><small>${m.clientName}</small></div>`);
                html+='</div>';
                d.innerHTML += html;
            });
        };
        
        // ×¤×’×™×©×•×ª ×‘×ª×•×š ×›×¨×˜×™×¡ ×œ×§×•×—
        window.addMeeting = () => {
            const cid = document.getElementById('editId').value;
            if(!cid) return;
            push(ref(db, 'meetings'), {
                clientId: cid, clientName: document.getElementById('inpName').value,
                date: document.getElementById('mDate').value, time: document.getElementById('mTime').value,
                note: document.getElementById('mNote').value, agent: currentUser.email
            });
        };
        function renderClientMeetings(cid) {
            const d = document.getElementById('clientMeetings');
            d.innerHTML = '';
            Object.values(meetings).filter(m => m.clientId === cid).forEach(m => {
                d.innerHTML += `<div style="background:#f1f5f9; padding:8px; margin-bottom:5px; border-radius:4px;"><b>${m.date} ${m.time}</b>: ${m.note}</div>`;
            });
        }

        // ××—×©×‘×•×Ÿ ××©×›× ×ª× ×•×›×œ×™×
        window.calcMortgage = () => { const p=Number(document.getElementById('calcAmount').value), r=0.065/12, n=300; document.getElementById('calcRes').innerText = Math.round(p*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1)).toLocaleString() + ' â‚ª'; };
        window.wa = () => window.open(`https://wa.me/972${document.getElementById('inpPhone').value.replace('0','')}`);
        window.mail = () => window.location.href=`mailto:${document.getElementById('inpEmail').value}`;
        window.pdf = () => html2pdf(document.getElementById('t1'));
        
        // ××©×ª××©×™×
        window.addUser = () => { push(ref(db, 'users'), {email: document.getElementById('newUEmail').value, role: document.getElementById('newURole').value}); renderUsers(); };
        function renderUsers() { document.getElementById('usersList').innerHTML = Object.values(users).map(u=>`<div>${u.email} - ${u.role}</div>`).join(''); }

    </script>
</body>
</html>
