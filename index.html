<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×“×œ"×Ÿ PRO 17.5 - ×”××¢×¨×›×ª ×”××œ××” (Safe Mode)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- ×¢×™×¦×•×‘ ×’×œ×•×‘×œ×™ ×•××•×¨×—×‘ --- */
        :root {
            --primary: #0f172a; 
            --primary-hover: #1e293b;
            --accent: #2563eb; 
            --accent-hover: #1d4ed8;
            --bg: #f1f5f9; 
            --surface: #ffffff; 
            --border: #cbd5e1; 
            --text: #0f172a; 
            --text-muted: #64748b;
            --danger: #ef4444; 
            --success: #22c55e; 
            --warning: #f59e0b;
            --radius: 12px; 
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --header-height: 70px;
        }

        [data-theme="dark"] {
            --primary: #020617; 
            --primary-hover: #1e293b;
            --accent: #60a5fa; 
            --accent-hover: #3b82f6;
            --bg: #0f172a; 
            --surface: #1e293b; 
            --border: #334155;
            --text: #f8fafc; 
            --text-muted: #94a3b8;
            --shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Rubik', sans-serif; 
            outline: none; 
            transition: all 0.2s ease-in-out; 
        }

        body { 
            background: var(--bg); 
            color: var(--text); 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* ××¡×š ×›× ×™×¡×” */
        #loginOverlay { 
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, var(--primary) 0%, #000 100%); 
            z-index: 10000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        
        .login-card { 
            background: white; 
            padding: 40px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 400px; 
            text-align: center; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); 
        }
        
        .login-input { 
            width: 100%; 
            padding: 14px; 
            margin-bottom: 15px; 
            border: 1px solid #cbd5e1; 
            border-radius: 8px; 
            font-size: 16px; 
            background: #f8fafc; 
        }
        
        .login-btn { 
            width: 100%; 
            padding: 14px; 
            background: var(--accent); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
        }
        
        .login-btn:hover { 
            background: var(--accent-hover); 
            transform: translateY(-2px); 
        }

        /* ××‘× ×” ×¨××©×™ */
        #mainApp { display: none; height: 100%; width: 100%; }
        .layout-container { display: flex; height: 100%; }

        /* ×¡×¨×’×œ ×¦×“ */
        aside { 
            width: 280px; 
            background: var(--primary); 
            color: white; 
            display: flex; 
            flex-direction: column; 
            z-index: 50; 
            box-shadow: 5px 0 25px rgba(0,0,0,0.15); 
        }
        
        .brand { 
            padding: 30px; 
            text-align: center; 
            background: rgba(255,255,255,0.03); 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
        }
        
        .brand-title { 
            font-size: 26px; 
            font-weight: 900; 
            letter-spacing: 1px; 
            color: white; 
        }
        
        .nav-list { flex: 1; padding: 20px; overflow-y: auto; }
        
        .nav-item { 
            padding: 16px 20px; 
            border-radius: var(--radius); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            color: #94a3b8; 
            margin-bottom: 10px; 
            font-weight: 500; 
            font-size: 15px;
        }
        
        .nav-item:hover { 
            background: rgba(255,255,255,0.1); 
            color: white; 
            transform: translateX(5px); 
        }
        
        .nav-item.active { 
            background: var(--accent); 
            color: white; 
            font-weight: 700; 
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.4); 
        }
        
        .user-panel { 
            padding: 20px; 
            background: rgba(0,0,0,0.2); 
            border-top: 1px solid rgba(255,255,255,0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        /* ×ª×•×›×Ÿ */
        main { 
            flex: 1; 
            padding: 30px; 
            overflow-y: auto; 
            position: relative; 
            background: var(--bg); 
        }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            height: 50px;
        }
        
        .page-title { 
            font-size: 32px; 
            font-weight: 800; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        [data-theme="dark"] .page-title { color: var(--text); }

        /* ×’×¨×™×“ ×•×›×¨×˜×™×¡×™× */
        .grid-3 { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 25px; 
            margin-bottom: 35px; 
        }
        
        .stat-card { 
            background: var(--surface); 
            padding: 30px; 
            border-radius: var(--radius); 
            border: 1px solid var(--border); 
            box-shadow: var(--shadow); 
            position: relative; 
            overflow: hidden; 
        }
        
        .stat-card:hover { transform: translateY(-5px); }
        
        .stat-val { 
            font-size: 42px; 
            font-weight: 800; 
            margin-top: 10px; 
            color: var(--text); 
        }
        
        .stat-label { 
            font-size: 15px; 
            color: var(--text-muted); 
            font-weight: 500; 
        }
        
        .card { 
            background: var(--surface); 
            padding: 25px; 
            border-radius: var(--radius); 
            border: 1px solid var(--border); 
            box-shadow: var(--shadow); 
            margin-bottom: 25px; 
        }

        /* ×˜×‘×œ×” */
        .table-frame { 
            background: var(--surface); 
            border-radius: var(--radius); 
            border: 1px solid var(--border); 
            box-shadow: var(--shadow); 
            display: flex; 
            flex-direction: column; 
            height: calc(100vh - 180px); 
            overflow: hidden; 
            position: relative; 
        }
        
        .table-tools { 
            padding: 20px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            background: var(--bg); 
            flex-wrap: wrap; 
        }
        
        .table-body-scroll { overflow: auto; flex: 1; }
        
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        
        th { 
            background: var(--surface); 
            text-align: right; 
            padding: 18px; 
            font-weight: 700; 
            color: var(--text-muted); 
            font-size: 13px; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            border-bottom: 2px solid var(--border); 
            white-space: nowrap; 
        }
        
        td { 
            padding: 16px 18px; 
            border-bottom: 1px solid var(--border); 
            font-size: 14px; 
            vertical-align: middle; 
            color: var(--text); 
        }
        
        tr:hover { background: rgba(59, 130, 246, 0.05); cursor: pointer; }

        /* ×›×¤×ª×•×¨×™× ×•×˜×¤×¡×™× */
        .btn { 
            padding: 12px 24px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            display: inline-flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 14px; 
            white-space: nowrap; 
        }
        
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-2px); }
        
        .btn-white { background: var(--surface); border: 1px solid var(--border); color: var(--text); }
        .btn-white:hover { border-color: var(--accent); color: var(--accent); }
        
        .btn-danger { background: var(--danger); color: white; }
        
        .btn-icon { 
            padding: 10px; 
            border-radius: 8px; 
            background: transparent; 
            border: none; 
            cursor: pointer; 
            color: var(--text-muted); 
            font-size: 16px; 
        }
        .btn-icon:hover { background: rgba(0,0,0,0.05); color: var(--accent); }
        
        input, select, textarea { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            color: var(--text); 
            padding: 14px; 
            border-radius: 8px; 
            width: 100%; 
            font-size: 14px; 
            margin-bottom: 12px; 
        }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        
        /* ××•×“××œ */
        .modal { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.7); 
            z-index: 2000; 
            display: none; 
            justify-content: center; 
            align-items: center; 
            backdrop-filter: blur(5px); 
        }
        
        .modal-box { 
            background: var(--surface); 
            width: 95%; 
            max-width: 1200px; 
            border-radius: 20px; 
            max-height: 95vh; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.4); 
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
        }
        
        .modal-head { 
            padding: 25px 35px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .modal-content { padding: 35px; overflow-y: auto; flex: 1; }
        
        .modal-foot { 
            padding: 25px 35px; 
            border-top: 1px solid var(--border); 
            display: flex; 
            justify-content: flex-end; 
            gap: 15px; 
            background: var(--bg); 
            border-radius: 0 0 20px 20px; 
        }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        /* ×™×•××Ÿ */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 25px; 
        }
        
        .day-column { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            border-radius: 16px; 
            padding: 20px; 
            box-shadow: var(--shadow);
        }
        
        .day-header { 
            font-weight: 800; 
            color: var(--accent); 
            margin-bottom: 20px; 
            padding-bottom: 15px; 
            border-bottom: 2px solid var(--bg); 
            font-size: 16px;
        }
        
        .event-card { 
            background: var(--bg); 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 15px; 
            border-right: 5px solid var(--accent); 
            position: relative; 
            transition: 0.2s; 
            cursor: pointer;
        }
        
        .event-card:hover { transform: translateX(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .event-time { font-size: 13px; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        .event-title { font-weight: 600; margin-bottom: 5px; font-size: 15px; }
        .event-sub { font-size: 12px; color: var(--text-muted); }

        /* ×˜××‘×™× */
        .tabs { display: flex; gap: 30px; border-bottom: 1px solid var(--border); margin-bottom: 30px; }
        .tab { 
            padding: 15px 0; 
            cursor: pointer; 
            color: var(--text-muted); 
            font-weight: 500; 
            border-bottom: 3px solid transparent; 
            font-size: 15px;
            transition: all 0.2s;
        }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--accent); border-color: var(--accent); font-weight: 700; }
        .tab-panel { display: none; animation: fadeIn 0.3s; }
        .tab-panel.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .cols-menu { 
            position: absolute; 
            top: 70px; 
            left: 20px; 
            background: var(--surface); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); 
            z-index: 100; 
            display: none; 
            min-width: 260px; 
            max-height: 500px;
            overflow-y: auto;
        }

        /* ×¨×›×™×‘×™× ××™×•×—×“×™× */
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .cr-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .cf-item { margin-bottom: 15px; }
        .cf-label { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card">
            <div style="font-size: 60px; margin-bottom: 15px;">ğŸ›¡ï¸</div>
            <h1>× ×“×œ"×Ÿ PRO <span style="font-size:18px; opacity:0.6; font-weight:400;">Cloud</span></h1>
            <p style="margin-bottom: 30px; color: #64748b; font-size: 14px;">×›× ×™×¡×” ×××•×‘×˜×—×ª ×œ××¢×¨×›×ª</p>
            <input type="email" id="txtEmail" class="login-input" placeholder="×›×ª×•×‘×ª ××™××™×™×œ">
            <input type="password" id="txtPass" class="login-input" placeholder="×¡×™×¡××” ××™×©×™×ª">
            <button class="login-btn" id="btnLogin">×”×ª×—×‘×¨ ×œ××¢×¨×›×ª</button>
            <div id="loginError" style="color:var(--danger); margin-top:20px; font-size:14px; font-weight:bold;"></div>
        </div>
    </div>

    <div id="mainApp">
        <div class="layout-container">
            <aside>
                <div class="brand">
                    <div class="brand-title">ğŸ¢ × ×“×œ"×Ÿ PRO</div>
                    <div style="font-size:12px; opacity:0.6; margin-top:5px;">V17.5 Enterprise Edition</div>
                </div>
                <div class="nav-list">
                    <div class="nav-item active" onclick="nav('dashboard')"><i class="fa-solid fa-chart-line"></i> ×“×©×‘×•×¨×“ ×× ×”×œ×™×</div>
                    <div class="nav-item" onclick="nav('crm')"><i class="fa-solid fa-users"></i> ×××’×¨ ×œ×§×•×—×•×ª</div>
                    <div class="nav-item" onclick="nav('calendar')"><i class="fa-solid fa-calendar-days"></i> ×™×•××Ÿ ×•×¤×’×™×©×•×ª</div>
                    <div class="nav-item" onclick="nav('projects')"><i class="fa-solid fa-building"></i> ×¤×¨×•×™×§×˜×™× ×‘×‘× ×™×™×”</div>
                    <div class="nav-item" onclick="nav('settings')"><i class="fa-solid fa-sliders"></i> ×”×’×“×¨×•×ª ××¢×¨×›×ª</div>
                </div>
                <div class="user-panel">
                    <div>
                        <div id="lblUser" style="font-weight:bold;">××•×¨×—</div>
                        <div style="font-size:11px; opacity:0.7;">××—×•×‘×¨ ×œ×¢× ×Ÿ (Online)</div>
                    </div>
                    <button class="btn-icon" onclick="doLogout()" style="color:white;" title="×”×ª× ×ª×§ ××”××¢×¨×›×ª"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </aside>

            <main>
                <section id="dashboard" class="page">
                    <div class="header">
                        <div class="page-title"><i class="fa-solid fa-gauge-high"></i> ××¨×›×– ×©×œ×™×˜×”</div>
                        <div style="font-weight:bold; color:var(--accent); font-size: 18px;" id="dateDisplay"></div>
                    </div>

                    <div class="grid-3">
                        <div class="stat-card" onclick="nav('crm')" style="cursor:pointer;">
                            <div class="stat-val" id="stTotal">0</div>
                            <div class="stat-label">×¡×”"×› ×œ×§×•×—×•×ª ×‘×××’×¨</div>
                            <i class="fa-solid fa-database" style="position:absolute; bottom:20px; left:20px; font-size:80px; opacity:0.05;"></i>
                        </div>
                        <div class="stat-card" style="border-bottom: 5px solid var(--warning);">
                            <div class="stat-val" id="stActive">0</div>
                            <div class="stat-label">×œ×§×•×—×•×ª ×‘×˜×™×¤×•×œ / ××•"×</div>
                            <i class="fa-solid fa-fire" style="position:absolute; bottom:20px; left:20px; font-size:80px; opacity:0.05; color:var(--warning);"></i>
                        </div>
                        <div class="stat-card" style="border-bottom: 5px solid var(--success);">
                            <div class="stat-val" id="stDeals">0</div>
                            <div class="stat-label">×—×•×–×™× ×©× ×—×ª××• ×”×—×•×“×©</div>
                            <i class="fa-solid fa-handshake" style="position:absolute; bottom:20px; left:20px; font-size:80px; opacity:0.05; color:var(--success);"></i>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:30px;">
                        <div class="card">
                            <h3 style="margin-bottom:25px; color:var(--primary);"><i class="fa-solid fa-calendar-check"></i> ×¤×’×™×©×•×ª ×•××©×™××•×ª ×œ×”×™×•×</h3>
                            <div id="dashboardAgenda"></div>
                        </div>
                        <div class="card" style="border:1px solid var(--border);">
                            <h3 style="margin-bottom:25px; color:var(--text);"><i class="fa-solid fa-bolt"></i> ×¢×“×›×•× ×™× ××—×¨×•× ×™×</h3>
                            <div id="liveFeed" style="font-size:13px; line-height:2.4; color:var(--text-muted);">
                                <div><i class="fa-solid fa-spinner fa-spin"></i> ×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×¢× ×Ÿ...</div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="crm" class="page" style="display:none;">
                    <div class="header">
                        <div class="page-title">×××’×¨ ×”×œ×§×•×—×•×ª</div>
                        <div style="display:flex; gap:15px;">
                            <button class="btn btn-white" onclick="document.getElementById('excelIn').click()"><i class="fa-solid fa-file-excel"></i> ×™×™×‘×•× ××§×¡×œ (×—×›×)</button>
                            <input type="file" id="excelIn" hidden>
                            <button class="btn btn-white" onclick="exportExcel()"><i class="fa-solid fa-download"></i> ×™×™×¦×•× ×”×›×œ</button>
                            <button class="btn btn-primary" onclick="openModal()"><i class="fa-solid fa-plus"></i> ×œ×§×•×— ×—×“×©</button>
                        </div>
                    </div>

                    <div class="table-frame">
                        <div class="table-tools">
                            <div style="flex:1; position:relative;">
                                <i class="fa-solid fa-search" style="position:absolute; right:15px; top:15px; color:#94a3b8;"></i>
                                <input type="text" id="searchBox" placeholder="×—×™×¤×•×© ×—×›× (×©×, ×ª.×–, ×˜×œ×¤×•×Ÿ, ×”×¢×¨×•×ª...)" onkeyup="renderTable()" style="padding-right:45px; max-width:400px; margin:0;">
                            </div>
                            <div style="width:1px; height:30px; background:var(--border); margin:0 10px;"></div>
                            <select id="filterStat" onchange="renderTable()" style="width:180px; margin:0; font-weight:bold;">
                                <option value="">×”×¦×’ ×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                                <option>×—×“×©</option>
                                <option>×‘×˜×™×¤×•×œ</option>
                                <option>××•"×</option>
                                <option>×—×•×–×”</option>
                                <option>×œ× ×¨×œ×•×•× ×˜×™</option>
                            </select>
                            <button class="btn btn-white" onclick="toggleColsMenu()" title="×‘×—×¨ ×¢××•×“×•×ª ×œ×ª×¦×•×’×”"><i class="fa-solid fa-table-columns"></i></button>
                            <button class="btn btn-white" onclick="toggleTheme()" title="××¦×‘ ×œ×™×œ×”/×™×•×"><i class="fa-solid fa-moon"></i></button>
                        </div>
                        <div id="colsMenu" class="cols-menu"></div>
                        <div class="table-body-scroll">
                            <table id="mainTable">
                                <thead id="tableHead"></thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="calendar" class="page" style="display:none;">
                    <div class="header">
                        <div class="page-title">×™×•××Ÿ ×¤×’×™×©×•×ª ×•××©×™××•×ª</div>
                        <button class="btn btn-primary" onclick="openGeneralTaskModal()"><i class="fa-solid fa-plus"></i> ×”×•×¡×£ ×ª×–×›×•×¨×ª ××™×©×™×ª</button>
                    </div>
                    
                    <div id="quickTaskArea" class="card" style="display:none; background:#eff6ff; border:2px solid var(--accent);">
                        <h4 style="color:var(--accent); margin-bottom:15px;">×”×•×¡×¤×ª ×ª×–×›×•×¨×ª ×›×œ×œ×™×ª (×œ×œ× ×©×™×•×š ×œ×œ×§×•×—)</h4>
                        <div style="display:flex; gap:15px; flex-wrap:wrap;">
                            <input type="text" id="genTaskTitle" placeholder="××” ×”××©×™××” ×œ×‘×™×¦×•×¢?" style="flex:2;">
                            <input type="date" id="genTaskDate" style="flex:1;">
                            <input type="time" id="genTaskTime" style="flex:1;">
                            <button class="btn btn-primary" onclick="addGeneralTask()">×©××•×¨ ×‘×™×•××Ÿ</button>
                            <button class="btn btn-white" onclick="document.getElementById('quickTaskArea').style.display='none'">×‘×™×˜×•×œ</button>
                        </div>
                    </div>

                    <div id="calendarView" class="calendar-grid">
                        </div>
                </section>

                <section id="projects" class="page" style="display:none;">
                    <div class="header">
                        <div class="page-title">× ×™×”×•×œ ×¤×¨×•×™×§×˜×™×</div>
                    </div>
                    <div class="card">
                        <div style="text-align:center; padding:80px; color:var(--text-muted);">
                            <i class="fa-solid fa-person-digging" style="font-size:70px; margin-bottom:25px; opacity:0.5;"></i>
                            <h2>××•×“×•×œ ×¤×¨×•×™×§×˜×™× ×‘×‘× ×™×™×”</h2>
                            <p style="font-size:18px; max-width:500px; margin:0 auto;">
                                ×›××Ÿ ×™×•×¤×™×¢ × ×™×”×•×œ ×”××œ××™ ×©×œ ×”×‘× ×™×™× ×™× ×•×”×“×™×¨×•×ª (×§×•××”, ×›×™×•×•×Ÿ, ××—×™×¨ ×œ××˜×¨).
                                <br>×”××•×“×•×œ × ××¦× ×›×¢×ª ×‘×¤×™×ª×•×— ×•×™×ª×•×•×¡×£ ×‘×’×¨×¡×” ×”×‘××”.
                            </p>
                        </div>
                    </div>
                </section>

                <section id="settings" class="page" style="display:none;">
                    <div class="header"><div class="page-title">×”×’×“×¨×•×ª ××¢×¨×›×ª</div></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                        <div class="card">
                            <h3>×”×’×“×¨×•×ª ×¤×™× × ×¡×™×•×ª</h3>
                            <p style="margin-bottom:15px; color:var(--text-muted);">××©××©×•×ª ×œ×—×™×©×•×‘×™ ×”××©×›× ×ª× ×‘××¢×¨×›×ª</p>
                            <label>×¨×™×‘×™×ª ×¤×¨×™×™× × ×•×›×—×™×ª (%)</label>
                            <input type="number" id="setPrime" value="6.0">
                            <button class="btn btn-primary" onclick="saveSettings()">×©××•×¨ ×©×™× ×•×™×™×</button>
                        </div>
                        <div class="card">
                            <h3>×’×™×‘×•×™ ×•×©×—×–×•×¨</h3>
                            <p style="margin-bottom:15px; color:var(--text-muted);">××•××œ×¥ ×œ×‘×¦×¢ ×’×™×‘×•×™ ×™×“× ×™ ×©×œ ×”×××’×¨ ××—×ª ×œ×©×‘×•×¢.</p>
                            <button class="btn btn-white" onclick="exportExcel()"><i class="fa-solid fa-download"></i> ×”×•×¨×“ ×’×™×‘×•×™ ××œ× ×œ××§×¡×œ</button>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-box">
            <div class="modal-head">
                <h2 id="modalTitle" style="font-size:24px; color:var(--primary);">×›×¨×˜×™×¡ ×œ×§×•×—</h2>
                <div style="display:flex; gap:12px;">
                    <button class="btn-icon" onclick="printClient()" title="×”×“×¤×¡ ×›×¨×˜×™×¡"><i class="fa-solid fa-print"></i></button>
                    <button class="btn-icon" onclick="closeModal()" title="×¡×’×•×¨"><i class="fa-solid fa-times"></i></button>
                </div>
            </div>
            <div class="modal-content">
                <input type="hidden" id="editId">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab(this, 't1')"><i class="fa-solid fa-user"></i> ×¤×¨×˜×™× ××™×©×™×™×</div>
                    <div class="tab" onclick="switchTab(this, 't2')"><i class="fa-solid fa-child"></i> ××©×¤×—×”</div>
                    <div class="tab" onclick="switchTab(this, 't3')"><i class="fa-solid fa-clipboard-list"></i> ×¡×˜×˜×•×¡ ×•×”×¢×¨×•×ª</div>
                    <div class="tab" onclick="switchTab(this, 't5')"><i class="fa-solid fa-calendar"></i> ×™×•××Ÿ</div>
                    <div class="tab" onclick="switchTab(this, 't4')"><i class="fa-solid fa-toolbox"></i> ×›×œ×™× ×•××—×©×‘×•× ×™×</div>
                </div>

                <div id="t1" class="tab-panel active">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:25px;">
                        <div><label>×©× ×œ×§×•×— ×¨××©×™</label><input id="inpName" placeholder="×©× ××œ×"></div>
                        <div><label>×‘×Ÿ/×‘×ª ×–×•×’</label><input id="inpSpouse" placeholder="×©× ×‘×Ÿ/×‘×ª ×”×–×•×’"></div>
                        <div><label>×˜×œ×¤×•×Ÿ ×¨××©×™ (×—×•×‘×”)</label><input id="inpPhone" placeholder="050..."></div>
                        <div><label>×˜×œ×¤×•×Ÿ × ×•×¡×£</label><input id="inpPhone2"></div>
                        <div><label>××™××™×™×œ</label><input id="inpEmail"></div>
                        <div><label>×ª×¢×•×“×ª ×–×”×•×ª</label><input id="inpId"></div>
                        
                        <div style="grid-column:span 2; background:#f8fafc; padding:25px; border-radius:16px; border:1px solid var(--border);">
                            <h4 style="color:var(--accent); margin-bottom:20px; border-bottom:1px solid #e2e8f0; padding-bottom:10px;">
                                <i class="fa-solid fa-database"></i> ××™×“×¢ × ×•×¡×£ (× ×§×œ×˜ ×××§×¡×œ)
                            </h4>
                            <div id="customFields" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px;"></div>
                        </div>
                    </div>
                </div>

                <div id="t2" class="tab-panel">
                    <div id="childrenList"></div>
                    <button class="btn btn-white" onclick="addChildRow()" style="margin-top:20px; width:100%;">
                        <i class="fa-solid fa-plus"></i> ×”×•×¡×£ ×™×œ×“ ×œ×¨×©×™××”
                    </button>
                </div>

                <div id="t3" class="tab-panel">
                    <div style="display:flex; gap:25px; margin-bottom:20px;">
                        <div style="flex:1">
                            <label>×¡×˜×˜×•×¡ ×˜×™×¤×•×œ</label>
                            <select id="inpStatus" style="font-weight:bold;">
                                <option>×—×“×©</option>
                                <option>×‘×˜×™×¤×•×œ</option>
                                <option>××•"×</option>
                                <option>×—×•×–×”</option>
                                <option>×œ× ×¨×œ×•×•× ×˜×™</option>
                            </select>
                        </div>
                        <div style="flex:1">
                            <label>×ª×§×¦×™×‘ ××©×•×¢×¨ (â‚ª)</label>
                            <input type="number" id="inpBudget">
                        </div>
                    </div>
                    <label>×”×¢×¨×•×ª, ×¡×™×›×•××™ ×©×™×—×” ×•×”×™×¡×˜×•×¨×™×” (×›×•×œ×œ × ×ª×•× ×™× ×’×•×œ××™×™× ×××§×¡×œ)</label>
                    <textarea id="inpNotes" rows="12" style="font-family:monospace; font-size:13px; line-height:1.6; background:#fffbeb;"></textarea>
                    <button class="btn btn-white btn-sm" onclick="addTimestamp()"><i class="fa-solid fa-clock"></i> ×”×•×¡×£ ×—×•×ª××ª ×–××Ÿ ×•×©× × ×¦×™×’</button>
                </div>

                <div id="t5" class="tab-panel">
                    <div style="background:#eff6ff; padding:20px; border-radius:16px; margin-bottom:25px; border:1px solid #bfdbfe;">
                        <h4 style="color:var(--accent); margin-bottom:15px;">×§×‘×¢ ×¤×’×™×©×”/××©×™××” ×—×“×©×” ×œ×œ×§×•×— ×–×”</h4>
                        <div style="display:flex; gap:15px; align-items:flex-end;">
                            <div style="flex:1"><label style="margin-bottom:5px; display:block; font-size:12px;">×ª××¨×™×š</label><input type="date" id="meetDate" style="margin:0;"></div>
                            <div style="flex:1"><label style="margin-bottom:5px; display:block; font-size:12px;">×©×¢×”</label><input type="time" id="meetTime" style="margin:0;"></div>
                            <div style="flex:2"><label style="margin-bottom:5px; display:block; font-size:12px;">× ×•×©×</label><input type="text" id="meetNote" placeholder="×œ×“×•×’××”: ×¤×’×™×©×” ×‘××©×¨×“" style="margin:0;"></div>
                            <button class="btn btn-primary" onclick="addMeeting()">×©×‘×¥ ×‘×™×•××Ÿ</button>
                        </div>
                    </div>
                    <h4 style="margin-bottom:15px;">×”×™×¡×˜×•×¨×™×™×ª ×¤×’×™×©×•×ª:</h4>
                    <div id="clientMeetingsList"></div>
                </div>

                <div id="t4" class="tab-panel">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:40px;">
                        <div class="card" style="margin:0; border:2px solid var(--accent);">
                            <h3 style="color:var(--accent); margin-bottom:15px;"><i class="fa-solid fa-calculator"></i> ××—×©×‘×•×Ÿ ××©×›× ×ª×</h3>
                            <label>×¡×›×•× ×”×”×œ×•×•××”</label>
                            <input type="number" id="mLoan" placeholder="×œ×“×•×’××”: 1000000">
                            <div style="background:#f1f5f9; padding:15px; border-radius:10px; margin-top:15px; text-align:center;">
                                <div style="font-size:13px; color:var(--text-muted);">×”×—×–×¨ ×—×•×“×©×™ ××©×•×¢×¨</div>
                                <div style="font-size:32px; font-weight:800; color:var(--primary);" id="mRes">0 â‚ª</div>
                            </div>
                            <button class="btn btn-primary" onclick="calcModal()" style="width:100%; margin-top:15px;">×‘×¦×¢ ×—×™×©×•×‘</button>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:15px; justify-content:center;">
                            <button class="btn btn-white" onclick="sendWhatsapp()" style="height:60px; font-size:16px;"><i class="fa-brands fa-whatsapp" style="color:#25D366; font-size:24px;"></i> ×©×œ×— ×”×•×“×¢×ª ×•×•××˜×¡××¤</button>
                            <button class="btn btn-white" onclick="sendEmail()" style="height:60px; font-size:16px;"><i class="fa-solid fa-envelope" style="color:#EA4335; font-size:24px;"></i> ×©×œ×— ××™××™×™×œ</button>
                            <button class="btn btn-white" onclick="genPDF()" style="height:60px; font-size:16px;"><i class="fa-solid fa-file-pdf" style="color:#F40F02; font-size:24px;"></i> ×”×¤×§ ×”×¦×¢×ª ××—×™×¨ (PDF)</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-danger" id="btnDelete" onclick="deleteClient()" style="display:none;"><i class="fa-solid fa-trash"></i> ××—×§ ×œ×§×•×—</button>
                <div style="flex:1"></div>
                <button class="btn btn-white" onclick="closeModal()">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveData()"><i class="fa-solid fa-save"></i> ×©××•×¨ ×©×™× ×•×™×™× ×‘×¢× ×Ÿ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // *** ×”××¤×ª×— ×”×¡×•×“×™ ×©×œ×š ***
        const firebaseConfig = {
            apiKey: "AIzaSyCJvUDVuccEZSuTsUSs7o-hnpME2WaTWio", 
            authDomain: "nadlan-pro.firebaseapp.com",
            projectId: "nadlan-pro",
            storageBucket: "nadlan-pro.firebasestorage.app",
            messagingSenderId: "435010903224",
            appId: "1:435010903224:web:53cc66ba40fa3d4198e84d",
            measurementId: "G-VRX35WJ2PE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let clientsData = {};
        let meetingsData = {};
        let settingsData = { prime: 6.0 };
        let customHeaders = new Set();
        let visibleCols = ['name', 'phone', 'city', 'status', 'budget'];

        // --- ×”×ª×—×‘×¨×•×ª ---
        document.getElementById('btnLogin').addEventListener('click', () => {
            const e = document.getElementById('txtEmail').value;
            const p = document.getElementById('txtPass').value;
            document.getElementById('btnLogin').innerText = "××ª×—×‘×¨...";
            signInWithEmailAndPassword(auth, e, p).catch(err => {
                document.getElementById('btnLogin').innerText = "×”×ª×—×‘×¨ ×œ××¢×¨×›×ª";
                document.getElementById('loginError').innerText = "×©×’×™××”: " + err.message;
            });
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('lblUser').innerText = user.email.split('@')[0];
                initData();
                document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('he-IL', {weekday:'long', day:'numeric', month:'long'});
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        window.doLogout = () => signOut(auth);

        // --- ×¡× ×›×¨×•×Ÿ × ×ª×•× ×™× ---
        function initData() {
            // ×”××–× ×” ×œ×œ×§×•×—×•×ª
            onValue(ref(db, 'clients'), snap => {
                clientsData = snap.val() || {};
                Object.values(clientsData).forEach(c => {
                    if(c.customData) Object.keys(c.customData).forEach(k => customHeaders.add(k));
                });
                renderTable();
                updateStats();
                updateFeed(); // ×¢×“×›×•×Ÿ ×¤×™×“ ×—×“×©×•×ª
            });

            // ×”××–× ×” ×œ×¤×’×™×©×•×ª
            onValue(ref(db, 'meetings'), snap => {
                meetingsData = snap.val() || {};
                renderCalendar(); 
            });

            // ×”××–× ×” ×œ×”×’×“×¨×•×ª
            onValue(ref(db, 'settings'), snap => {
                const val = snap.val();
                if(val && val.prime) settingsData.prime = val.prime;
                if(document.getElementById('setPrime')) document.getElementById('setPrime').value = settingsData.prime;
            });
        }

        // --- ×™×™×‘×•× ××§×¡×œ ×—×›× (×× ×’× ×•×Ÿ V17.5) ---
        document.getElementById('excelIn').addEventListener('change', (e) => {
            const fileName = e.target.files[0].name;
            const r = new FileReader();
            
            r.onload = ex => {
                const w = XLSX.read(new Uint8Array(ex.target.result), {type:'array'});
                const d = XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]]);
                let count = 0;
                
                // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ××¦×™××ª ×¢×¨×š ×œ×¤×™ ××’×•×•×Ÿ ×©××•×ª ××¤×©×¨×™×™× ×œ×¢××•×“×”
                const findVal = (row, keywords) => {
                    const key = Object.keys(row).find(k => keywords.some(w => k.includes(w)));
                    return key ? row[key] : '';
                };

                d.forEach(row => {
                    // ××™×¤×•×™ ×©×“×•×ª ×—×›× - ××•×ª×× ×‘××™×•×—×“ ×œ×§×‘×¦×™× ×©×œ×š
                    const phone = String(findVal(row, ['× ×™×™×“','×˜×œ×¤×•×Ÿ','×¤×œ××¤×•×Ÿ']) || '').replace(/\D/g,'');
                    const name = findVal(row, ['×©× ××©×¤×—×”','×©× ×¤×¨×˜×™','×©×']) || '×œ×§×•×— ×œ×œ× ×©×';
                    
                    if(name !== '×œ×§×•×— ×œ×œ× ×©×' || phone.length > 0) {
                        
                        // ×‘× ×™×™×ª ×™×•××Ÿ × ×ª×•× ×™× ×’×•×œ××™×™× ×œ×”×¢×¨×•×ª (×›×“×™ ×©×©×•× ×“×‘×¨ ×œ× ×™×œ×š ×œ××™×‘×•×“)
                        let rawDataLog = `\n--- ×™×™×‘×•× ××§×•×‘×¥: ${fileName} (${new Date().toLocaleDateString()}) ---\n`;
                        for (let [key, val] of Object.entries(row)) {
                            if(val) rawDataLog += `${key}: ${val}\n`; 
                        }

                        // ×™×¦×™×¨×ª ×”××•×‘×™×™×§×˜
                        const c = {
                            name: name + ' ' + (findVal(row, ['×¤×¨×˜×™']) || ''), // × ×™×¡×™×•×Ÿ ×œ×—×‘×¨ ×©× ××©×¤×—×” ×•×¤×¨×˜×™
                            spouse: findVal(row, ['××©×”','××™×©×”','×–×•×’']) || '',
                            phone: phone,
                            phone2: String(findVal(row, ['×˜×œ×¤×•×Ÿ 2','× ×•×¡×£','××™×©×”']) || '').replace(/\D/g,''), // ×œ×¢×™×ª×™× ×”×˜×œ×¤×•×Ÿ ×”×©× ×™ ×”×•× ×©×œ ×”××™×©×”
                            email: findVal(row, ['××™×™×œ','×“×•×']),
                            idNum: findVal(row, ['×ª.×–','×–×”×•×ª']),
                            city: findVal(row, ['×¢×™×¨','×›×ª×•×‘×ª']),
                            status: '×—×“×©',
                            notes: rawDataLog, // ×’×™×‘×•×™ ××œ×
                            lastUpdate: Date.now(),
                            agent: currentUser.email,
                            children: [],
                            customData: {} 
                        };
                        
                        // ××™×¤×•×™ ×©×“×•×ª ×¡×¤×¦×™×¤×™×™× ×œ×ª×•×š customData ×›×“×™ ×©×™×”×™×• ×‘×˜×‘×œ×”
                        // ××œ×• ×©×“×•×ª ×©×¨××™× ×• ×‘×§×‘×¦×™× ×©×œ×š:
                        const specificFields = ['×¨×—×•×‘', '××¡×¤×¨ ×‘×™×ª', '×™×©×™×‘×”', '×¢×™×¡×•×§', '××§×•×¨'];
                        specificFields.forEach(field => {
                            const val = findVal(row, [field]);
                            if(val) c.customData[field] = val;
                        });

                        push(ref(db, 'clients'), c);
                        count++;
                    }
                });
                
                if(count > 0) alert(`âœ… ×‘×•×¦×¢ ×‘×”×¦×œ×—×”!\n× ×§×œ×˜×• ${count} ×œ×§×•×—×•×ª.\n×›×œ ×”××™×“×¢ ×”×’×•×œ××™ × ×©××¨ ×‘×”×¢×¨×•×ª, ×•×©×“×•×ª ××¨×›×–×™×™× ××•×¤×• ×œ×›×¨×˜×™×¡.`);
                else alert('âŒ ×œ× × ×§×œ×˜×• × ×ª×•× ×™×. ×‘×“×•×§ ××ª ×ª×§×™× ×•×ª ×”×§×•×‘×¥.');
            };
            r.readAsArrayBuffer(e.target.files[0]);
        });

        // --- × ×™×”×•×œ ×™×•××Ÿ ×•×ª×–×›×•×¨×•×ª ---
        
        window.openGeneralTaskModal = () => {
            document.getElementById('quickTaskArea').style.display = 'block';
            document.getElementById('genTaskTitle').focus();
        };

        window.addGeneralTask = () => {
            const title = document.getElementById('genTaskTitle').value;
            const date = document.getElementById('genTaskDate').value;
            const time = document.getElementById('genTaskTime').value;

            if(!title || !date) { alert('×—×•×‘×” ×œ××œ× ××©×™××” ×•×ª××¨×™×š'); return; }

            push(ref(db, 'meetings'), {
                clientId: 'general',
                clientName: '××©×™××” ××™×©×™×ª',
                date: date,
                time: time || '09:00',
                note: title,
                agent: currentUser.email
            });
            
            document.getElementById('quickTaskArea').style.display = 'none';
            document.getElementById('genTaskTitle').value = '';
        };

        window.renderCalendar = () => {
            const container = document.getElementById('calendarView');
            const dashboardList = document.getElementById('dashboardAgenda');
            if(!container) return; 
            
            container.innerHTML = '';
            dashboardList.innerHTML = '';

            const sorted = Object.entries(meetingsData).sort((a,b) => (a[1].date+a[1].time).localeCompare(b[1].date+b[1].time));
            
            // ×§×™×‘×•×¥ ×œ×¤×™ ×ª××¨×™×›×™×
            const grouped = {};
            sorted.forEach(([id, m]) => {
                if(!grouped[m.date]) grouped[m.date] = [];
                grouped[m.date].push({id, ...m});
            });

            const today = new Date().toISOString().split('T')[0];
            let upcomingCount = 0;

            Object.keys(grouped).sort().forEach(date => {
                // ×¢×™×¦×•×‘ ×›×•×ª×¨×ª ×”×ª××¨×™×š
                const dateObj = new Date(date);
                const dayName = dateObj.toLocaleDateString('he-IL', {weekday:'long'});
                const dateStr = dateObj.toLocaleDateString('he-IL', {day:'numeric', month:'numeric'});
                
                let html = `
                <div class="day-column">
                    <div class="day-header">
                        <span>${dayName}</span>
                        <span style="float:left; opacity:0.6; font-size:14px;">${dateStr}</span>
                    </div>`;
                
                grouped[date].forEach(evt => {
                    const isTask = evt.clientId === 'general';
                    const icon = isTask ? '<i class="fa-solid fa-check-circle"></i>' : '<i class="fa-solid fa-user"></i>';
                    const style = isTask ? 'border-color:var(--success)' : 'border-color:var(--accent)';
                    const bg = isTask ? '#f0fdf4' : '#eff6ff'; // ×™×¨×•×§ ×‘×”×™×¨ ×œ××©×™××•×ª, ×›×—×•×œ ×‘×”×™×¨ ×œ×¤×’×™×©×•×ª
                    
                    html += `
                    <div class="event-card" style="${style}; background:${bg};">
                        <div class="event-time">
                            ${evt.time} 
                            <span style="float:left; cursor:pointer; color:var(--danger);" onclick="deleteMeeting('${evt.id}')" title="××—×§"><i class="fa-solid fa-trash"></i></span>
                        </div>
                        <div class="event-title">${icon} ${isTask ? evt.note : evt.clientName}</div>
                        <div class="event-sub">${isTask ? '' : evt.note}</div>
                        ${!isTask ? `<button class="btn-icon" style="font-size:12px; margin-top:5px; background:white; border:1px solid #ccc; padding:2px 8px;" onclick="editClient('${evt.clientId}')">××¢×‘×¨ ×œ×ª×™×§</button>` : ''}
                    </div>`;

                    // ×“×©×‘×•×¨×“
                    if(upcomingCount < 5 && date >= today) {
                        dashboardList.innerHTML += `
                        <div style="padding:12px; border-bottom:1px solid #f1f5f9; display:flex; align-items:center; gap:10px;">
                            <div style="font-weight:bold; color:var(--accent); min-width:45px;">${evt.time}</div>
                            <div style="flex:1;">
                                <div style="font-weight:600;">${isTask ? evt.note : evt.clientName}</div>
                                <div style="font-size:11px; opacity:0.6;">${dateStr} â€¢ ${isTask ? '××©×™××”' : '×¤×’×™×©×”'}</div>
                            </div>
                        </div>`;
                        upcomingCount++;
                    }
                });
                html += `</div>`;
                container.innerHTML += html;
            });
            
            if(upcomingCount === 0) dashboardList.innerHTML = '<div style="padding:20px; text-align:center; opacity:0.6;">××™×Ÿ ×¤×’×™×©×•×ª ×§×¨×•×‘×•×ª</div>';
        };

        // --- ×œ×•×’×™×§×ª ×××©×§ ×•× ×™×•×•×˜ (V17.5 ××•×¨×—×‘) ---
        
        window.nav = (p) => {
            const pages = document.querySelectorAll('.page');
            pages.forEach(x => x.style.display='none');
            
            const target = document.getElementById(p);
            if(target) target.style.display='block';
            
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            if(event && event.currentTarget) event.currentTarget.classList.add('active');
            
            if(p==='calendar') renderCalendar();
        }

        window.renderTable = () => {
            const tbody = document.getElementById('tableBody');
            const thead = document.getElementById('tableHead');
            const search = document.getElementById('searchBox').value.toLowerCase();
            const filter = document.getElementById('filterStat').value;
            
            // ×‘× ×™×™×ª ×¢××•×“×•×ª ×“×™× ××™×ª
            let cols = ['name', 'phone', 'status', 'city'];
            visibleCols.forEach(c => { if(!cols.includes(c)) cols.push(c); });
            
            thead.innerHTML = `<tr>${cols.map(colName).map(x=>`<th>${x}</th>`).join('')}<th>×¤×¢×•×œ×•×ª</th></tr>`;
            tbody.innerHTML = '';

            Object.entries(clientsData).forEach(([key, c]) => {
                if (filter && c.status !== filter) return;
                
                // ×—×™×¤×•×© ×—×›× ×©×›×•×œ×œ ×’× ××ª ×”×”×¢×¨×•×ª ×•×”×©×“×•×ª ×”××™×•×—×“×™×
                const txt = (c.name + c.phone + c.idNum + Object.values(c.customData||{}).join(' ') + (c.notes||'')).toLowerCase();
                if (search && !txt.includes(search)) return;

                const tr = document.createElement('tr');
                tr.onclick = (e) => { if(e.target.tagName!=='BUTTON' && e.target.tagName!=='I') window.editClient(key); };
                
                let html = '';
                cols.forEach(col => {
                    let v = '-';
                    if(col==='name') v = `<b>${c.name}</b><br><small style="opacity:0.7">${c.spouse||''}</small>`;
                    else if(col==='status') v = `<span class="badge" style="background:${stColor(c.status)}; color:#1e293b;">${c.status}</span>`;
                    else v = c[col] || (c.customData ? c.customData[col] : '') || '-';
                    html += `<td>${v}</td>`;
                });
                
                html += `<td><button class="btn-icon" onclick="editClient('${key}')"><i class="fa-solid fa-pen"></i></button></td>`;
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        };

        window.editClient = (id) => {
            const c = clientsData[id];
            document.getElementById('editId').value = id;
            document.getElementById('inpName').value = c.name;
            document.getElementById('inpSpouse').value = c.spouse || '';
            document.getElementById('inpPhone').value = c.phone;
            document.getElementById('inpPhone2').value = c.phone2 || '';
            document.getElementById('inpEmail').value = c.email || '';
            document.getElementById('inpId').value = c.idNum || '';
            document.getElementById('inpStatus').value = c.status;
            document.getElementById('inpBudget').value = c.budget || '';
            document.getElementById('inpNotes').value = c.notes || '';
            
            // ×˜×¢×™× ×ª ×™×œ×“×™×
            document.getElementById('childrenList').innerHTML = '';
            if(c.children) c.children.forEach(k => window.addChildRow(k.name, k.id));
            
            // ×˜×¢×™× ×ª ×©×“×•×ª ××•×ª×××™× ××™×©×™×ª
            const cfDiv = document.getElementById('customFields');
            cfDiv.innerHTML = '';
            customHeaders.forEach(k => {
                const val = (c.customData && c.customData[k]) ? c.customData[k] : '';
                // ×™×¦×™×¨×ª ×©×“×” ××¢×•×¦×‘
                const fieldHtml = `
                <div class="cf-item">
                    <span class="cf-label">${k}</span>
                    <input class="cf-inp" data-key="${k}" value="${val}" style="margin:0;">
                </div>`;
                cfDiv.innerHTML += fieldHtml;
            });

            renderClientMeetings(id);
            document.getElementById('btnDelete').style.display = 'block';
            document.getElementById('modal').style.display = 'flex';
        };

        window.openModal = () => {
            document.getElementById('editId').value = '';
            document.getElementById('inpName').value = '';
            document.getElementById('inpPhone').value = '';
            document.getElementById('inpNotes').value = '';
            document.getElementById('childrenList').innerHTML = '';
            document.getElementById('customFields').innerHTML = '';
            document.getElementById('clientMeetingsList').innerHTML = '';
            
            // ×”×•×¡×¤×ª ×©×“×•×ª ×¨×™×§×™× ×©×œ custom headers ×›×“×™ ×©××¤×©×¨ ×™×”×™×” ×œ××œ× ××•×ª× ×’× ×‘×œ×§×•×— ×—×“×©
            const cfDiv = document.getElementById('customFields');
            if(customHeaders.size > 0) {
                customHeaders.forEach(k => {
                    cfDiv.innerHTML += `<div class="cf-item"><span class="cf-label">${k}</span><input class="cf-inp" data-key="${k}" style="margin:0;"></div>`;
                });
            } else {
                cfDiv.innerHTML = '<div style="opacity:0.5; font-size:13px;">××™×Ÿ ×©×“×•×ª ××™×•×—×“×™× ×¢×“×™×™×Ÿ. ×™×™×‘× ××§×¡×œ ×›×“×™ ×œ×™×¦×•×¨ ×›××œ×”.</div>';
            }

            document.getElementById('btnDelete').style.display = 'none';
            document.getElementById('modal').style.display = 'flex';
        }

        window.closeModal = () => document.getElementById('modal').style.display = 'none';

        window.saveData = () => {
            const id = document.getElementById('editId').value;
            const c = {
                name: document.getElementById('inpName').value,
                spouse: document.getElementById('inpSpouse').value,
                phone: document.getElementById('inpPhone').value,
                phone2: document.getElementById('inpPhone2').value,
                email: document.getElementById('inpEmail').value,
                idNum: document.getElementById('inpId').value,
                status: document.getElementById('inpStatus').value,
                budget: document.getElementById('inpBudget').value,
                notes: document.getElementById('inpNotes').value,
                lastUpdate: Date.now(),
                agent: currentUser.email,
                children: [],
                customData: {}
            };
            
            // ×©××™×¨×ª ×™×œ×“×™×
            document.querySelectorAll('.cr-row').forEach(r => {
                c.children.push({
                    name: r.querySelector('.cn').value, 
                    id: r.querySelector('.ci').value
                });
            });
            
            // ×©××™×¨×ª ×©×“×•×ª ××•×ª×××™×
            document.querySelectorAll('.cf-inp').forEach(i => {
                c.customData[i.dataset.key] = i.value;
            });

            if(id) update(ref(db, 'clients/'+id), c);
            else push(ref(db, 'clients'), c);
            
            if(c.status === '×—×•×–×”') confetti({particleCount: 100, spread: 70, origin: { y: 0.6 }});
            closeModal();
        };

        window.deleteClient = () => {
            if(confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×œ×§×•×— ×œ×¦××™×ª×•×ª?')) { 
                remove(ref(db, 'clients/'+document.getElementById('editId').value)); 
                closeModal(); 
            }
        };

        // --- × ×™×”×•×œ ×¤×’×™×©×•×ª (Backend) ---
        window.addMeeting = () => {
            const cid = document.getElementById('editId').value;
            const date = document.getElementById('meetDate').value;
            const title = document.getElementById('meetNote').value;
            
            if(!cid || !date || !title) {
                alert('× × ×œ××œ× ×ª××¨×™×š ×•× ×•×©× ×œ×¤×’×™×©×”');
                return;
            }
            
            push(ref(db, 'meetings'), {
                clientId: cid,
                clientName: document.getElementById('inpName').value,
                date: date,
                time: document.getElementById('meetTime').value || '10:00',
                note: title,
                agent: currentUser.email
            });
            
            renderClientMeetings(cid); // ×¨×¢× ×•×Ÿ ××™×™×“×™
        };

        function renderClientMeetings(cid) {
            const div = document.getElementById('clientMeetingsList');
            div.innerHTML = '';
            Object.entries(meetingsData).forEach(([mid, m]) => {
                if(m.clientId === cid) {
                    div.innerHTML += `
                    <div style="background:#f8fafc; padding:10px; border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border);">
                        <div>
                            <strong>${m.date} ${m.time}</strong> - ${m.note}
                        </div>
                        <button class="btn-icon" onclick="deleteMeeting('${mid}')" style="color:var(--danger);"><i class="fa-solid fa-trash"></i></button>
                    </div>`;
                }
            });
        }
        
        window.deleteMeeting = (mid) => { 
            if(confirm('×œ××—×•×§ ×¤×’×™×©×” ×–×•?')) remove(ref(db, 'meetings/'+mid)); 
        };
        
        // --- ×›×œ×™× ×•×¢×–×¨×™× ---
        
        // ×©××™×¨×ª ×”×’×“×¨×•×ª
        window.saveSettings = () => {
            const p = document.getElementById('setPrime').value;
            update(ref(db, 'settings'), { prime: p }).then(()=>alert('×”×”×’×“×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”!'));
        };
        
        // ×©×•×¨×ª ×™×œ×“
        window.addChildRow = (n='', i='') => {
            const html = `
            <div class="cr-row">
                <input class="cn" value="${n}" placeholder="×©× ×”×™×œ×“" style="margin:0;">
                <input class="ci" value="${i}" placeholder="××¡×¤×¨ ×–×”×•×ª" style="margin:0;">
                <button type="button" class="btn-icon" onclick="this.parentElement.remove()" style="color:var(--danger);"><i class="fa-solid fa-minus-circle"></i></button>
            </div>`;
            document.getElementById('childrenList').insertAdjacentHTML('beforeend', html);
        }
        
        // ×—×•×ª××ª ×–××Ÿ
        window.addTimestamp = () => {
            const t = document.getElementById('inpNotes');
            const stamp = `\n--- ×¢×•×“×›×Ÿ ×¢"×™ ${currentUser.email.split('@')[0]} ×‘-${new Date().toLocaleString()} ---\n`;
            t.value = stamp + t.value;
        }
        
        // ×ª×¤×¨×™×˜ ×¢××•×“×•×ª
        window.toggleColsMenu = () => {
            const m = document.getElementById('colsMenu');
            m.style.display = (m.style.display === 'block') ? 'none' : 'block';
            
            // ×¨×¢× ×•×Ÿ ×”×ª×•×›×Ÿ
            m.innerHTML = '<h4 style="margin-bottom:10px;">×”×¦×’/×”×¡×ª×¨ ×¢××•×“×•×ª:</h4>';
            
            // ×¢××•×“×•×ª ×§×‘×•×¢×•×ª
            ['phone','email','status','city','budget'].forEach(k => {
                const checked = visibleCols.includes(k) ? 'checked' : '';
                m.innerHTML += `<div><label><input type="checkbox" onchange="toggleCol('${k}')" ${checked}> ${colName(k)}</label></div>`;
            });
            
            // ×¢××•×“×•×ª ××•×ª×××•×ª
            m.innerHTML += '<hr style="margin:10px 0; border:0; border-top:1px solid #eee;">';
            customHeaders.forEach(k => {
                const checked = visibleCols.includes(k) ? 'checked' : '';
                m.innerHTML += `<div><label><input type="checkbox" onchange="toggleCol('${k}')" ${checked}> ${k}</label></div>`;
            });
        }
        
        window.toggleCol = (k) => { 
            const i = visibleCols.indexOf(k); 
            if(i>-1) visibleCols.splice(i,1); else visibleCols.push(k); 
            renderTable(); 
        };
        
        // ×¡×˜×˜×™×¡×˜×™×§×•×ª
        window.updateStats = () => { 
            const a = Object.values(clientsData); 
            document.getElementById('stTotal').innerText = a.length; 
            document.getElementById('stActive').innerText = a.filter(c=>['×‘×˜×™×¤×•×œ','××•"×'].includes(c.status)).length; 
            document.getElementById('stDeals').innerText = a.filter(c=>c.status==='×—×•×–×”').length; 
        };
        
        window.updateFeed = () => {
            const arr = Object.values(clientsData).sort((a,b) => b.lastUpdate - a.lastUpdate).slice(0,5);
            document.getElementById('liveFeed').innerHTML = arr.map(c => 
                `<div><i class="fa-solid fa-clock-rotate-left"></i> <b>${c.name}</b> ×¢×•×“×›×Ÿ ×œ×¡×˜×˜×•×¡ ${c.status} <span style="opacity:0.5; font-size:11px;">(${new Date(c.lastUpdate).toLocaleTimeString()})</span></div>`
            ).join('');
        };
        
        // ××™×œ×•×Ÿ ×©××•×ª ×œ×¢××•×“×•×ª
        window.colName = (k) => ({
            name:'×©× ×œ×§×•×—', 
            phone:'×˜×œ×¤×•×Ÿ', 
            status:'×¡×˜×˜×•×¡', 
            city:'×¢×™×¨ ××’×•×¨×™×', 
            email:'××™××™×™×œ', 
            budget:'×ª×§×¦×™×‘',
            spouse: '×‘×Ÿ/×‘×ª ×–×•×’'
        }[k]||k);
        
        // ×¦×‘×¢×™ ×¡×˜×˜×•×¡
        window.stColor = (s) => ({
            '×—×“×©':'#e2e8f0', // ××¤×•×¨
            '×‘×˜×™×¤×•×œ':'#bfdbfe', // ×›×—×•×œ
            '××•"×':'#fde047', // ×¦×”×•×‘
            '×—×•×–×”':'#86efac', // ×™×¨×•×§
            '×œ× ×¨×œ×•×•× ×˜×™':'#fecaca' // ××“×•×
        }[s]||'#fff');
        
        // ××¢×‘×¨ ×˜××‘×™×
        window.switchTab = (el, id) => { 
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); 
            document.querySelectorAll('.tab-panel').forEach(x=>x.classList.remove('active')); 
            el.classList.add('active'); 
            document.getElementById(id).classList.add('active'); 
        };
        
        // ××—×©×‘×•×Ÿ ××©×›× ×ª×
        window.calcModal = () => { 
            const p=Number(document.getElementById('mLoan').value);
            if(!p) return;
            // ×”× ×—×ª ×‘×¡×™×¡ + ×¤×¨×™×™×
            const r=(Number(settingsData.prime)+0.5)/100/12; 
            const n=300; // 25 ×©× ×”
            const res = Math.round(p*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1));
            document.getElementById('mRes').innerText = res.toLocaleString() + ' â‚ª'; 
        };
        
        // ×¤×¢×•×œ×•×ª ×—×™×¦×•× ×™×•×ª
        window.sendWhatsapp = () => window.open(`https://wa.me/972${document.getElementById('inpPhone').value.replace('0','')}`);
        window.sendEmail = () => window.location.href=`mailto:${document.getElementById('inpEmail').value}`;
        window.genPDF = () => {
            const element = document.getElementById('modal');
            const opt = {
                margin: 10,
                filename: `Client_${document.getElementById('inpName').value}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        };
        
        // ×™×™×¦×•× ×œ××§×¡×œ (×’×™×‘×•×™)
        window.exportExcel = () => {
            const ws = XLSX.utils.json_to_sheet(Object.values(clientsData).map(c=>({
                ...c, 
                children: JSON.stringify(c.children),
                customData: JSON.stringify(c.customData)
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Clients_Backup");
            XLSX.writeFile(wb, `Nadlan_Full_Backup_${new Date().toISOString().slice(0,10)}.xlsx`);
        };
        
        // ×”×—×œ×¤×ª ×¢×¨×›×ª × ×•×©×
        window.toggleTheme = () => {
            const t = document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
            document.documentElement.setAttribute('data-theme', t);
        }
    </script>
</body>
</html>
