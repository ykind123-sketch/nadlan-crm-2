<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×“×œ"×Ÿ PRO 19.0 - ×”×’×¨×¡×” ×”××ª×§× ×ª</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- ×¢×™×¦×•×‘ ×’×œ×•×‘×œ×™ --- */
        :root {
            --primary: #1e293b; --primary-light: #334155;
            --accent: #2563eb; --accent-hover: #1d4ed8;
            --bg: #f8fafc; --surface: #ffffff; 
            --border: #e2e8f0; --text: #0f172a; --text-muted: #64748b;
            --danger: #ef4444; --success: #22c55e; --warning: #f59e0b;
            --radius: 8px; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --primary: #020617; --primary-light: #1e293b;
            --accent: #60a5fa; --accent-hover: #3b82f6;
            --bg: #0f172a; --surface: #1e293b; --border: #334155;
            --text: #f8fafc; --text-muted: #94a3b8;
            --shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Rubik', sans-serif; outline: none; transition: all 0.2s; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* ××¡×š ×›× ×™×¡×” */
        #loginOverlay { position: fixed; inset: 0; background: linear-gradient(135deg, var(--primary) 0%, #000 100%); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .login-card { background: white; padding: 40px; border-radius: 16px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 6px; font-size: 15px; }
        .login-btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* ××‘× ×” ×¨××©×™ */
        #mainApp { display: none; height: 100%; width: 100%; }
        .layout-container { display: flex; height: 100%; }

        /* ×¡×¨×’×œ ×¦×“ */
        aside { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; z-index: 50; box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
        .brand { padding: 25px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .brand-title { font-size: 22px; font-weight: 800; letter-spacing: 1px; }
        .nav-list { flex: 1; padding: 15px; overflow-y: auto; }
        .nav-item { padding: 12px 15px; border-radius: var(--radius); cursor: pointer; display: flex; align-items: center; gap: 12px; color: #94a3b8; margin-bottom: 5px; font-size: 14px; font-weight: 500; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: var(--accent); color: white; font-weight: 700; }
        .user-panel { padding: 20px; background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; font-size: 13px; }

        /* ×ª×•×›×Ÿ */
        main { flex: 1; padding: 25px; overflow-y: auto; position: relative; background: var(--bg); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .page-title { font-size: 26px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }

        /* ×’×¨×™×“ */
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .card { background: var(--surface); padding: 25px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); margin-bottom: 25px; }
        .stat-val { font-size: 36px; font-weight: 800; color: var(--text); }
        .stat-label { font-size: 13px; color: var(--text-muted); }

        /* ×˜×‘×œ×” */
        .table-frame { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); display: flex; flex-direction: column; height: calc(100vh - 170px); overflow: hidden; position: relative; }
        .table-tools { padding: 15px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; background: var(--bg); flex-wrap: wrap; }
        .table-body-scroll { overflow: auto; flex: 1; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: var(--surface); text-align: right; padding: 12px 15px; font-weight: 600; color: var(--text-muted); font-size: 13px; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border); }
        td { padding: 8px 15px; border-bottom: 1px solid var(--border); font-size: 13px; color: var(--text); vertical-align: middle; }
        tr:hover { background: var(--bg); }
        tr.blocked-row { background: #fee2e2 !important; }

        /* ×›×¤×ª×•×¨×™× ×•×˜×¤×¡×™× */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; font-size: 13px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-white { background: var(--surface); border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-icon { padding: 6px; background: transparent; border: none; cursor: pointer; color: var(--text-muted); font-size: 14px; }
        .btn-icon:hover { color: var(--accent); background: rgba(0,0,0,0.05); border-radius: 4px; }
        
        input, select, textarea { background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 6px; width: 100%; font-size: 14px; margin-bottom: 10px; }
        .quick-select { padding: 4px; height: 30px; font-size: 12px; margin: 0; width: auto; border-color: transparent; background: transparent; font-weight: bold; cursor: pointer; }
        .quick-select:hover { border-color: var(--border); background: var(--bg); }

        /* ××•×“××œ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-box { background: var(--surface); width: 95%; max-width: 1100px; border-radius: 16px; max-height: 95vh; display: flex; flex-direction: column; box-shadow: 0 50px 100px -20px rgba(0,0,0,0.3); }
        .modal-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-content { padding: 25px; overflow-y: auto; flex: 1; }
        .modal-foot { padding: 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: var(--bg); border-radius: 0 0 16px 16px; }

        /* ×˜××‘×™× */
        .tabs { display: flex; gap: 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .tab { padding: 10px 0; cursor: pointer; color: var(--text-muted); font-weight: 500; border-bottom: 3px solid transparent; font-size: 14px; }
        .tab.active { color: var(--accent); border-color: var(--accent); font-weight: 700; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        
        /* ×™×•××Ÿ */
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .day-col { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 15px; }
        .day-title { font-weight: bold; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid var(--border); color: var(--accent); }
        .cal-event { background: var(--bg); padding: 10px; border-radius: 6px; margin-bottom: 8px; border-right: 3px solid var(--accent); font-size: 13px; position:relative; }
        
        /* ×ª×¤×¨×™×˜ ×¢××•×“×•×ª */
        .cols-menu { position: absolute; top: 60px; left: 20px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 100; display: none; min-width: 200px; max-height: 400px; overflow-y: auto; }
        
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .admin-only { display: none !important; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card">
            <h1>×›× ×™×¡×” ×œ××¢×¨×›×ª</h1>
            <p style="margin-bottom: 20px; color: var(--text-muted);">× ×“×œ"×Ÿ PRO - ×’×¨×¡×” 19.0</p>
            <input type="email" id="txtEmail" class="login-input" placeholder="××™××™×™×œ">
            <input type="password" id="txtPass" class="login-input" placeholder="×¡×™×¡××”">
            <button class="login-btn" id="btnLogin">×”×ª×—×‘×¨</button>
            <div id="loginError" style="color:var(--danger); margin-top:15px; font-size:13px;"></div>
        </div>
    </div>

    <div id="mainApp">
        <div class="layout-container">
            <aside>
                <div class="brand">
                    <div class="brand-title">ğŸ¢ × ×“×œ"×Ÿ PRO</div>
                    <div style="font-size:11px; opacity:0.6; margin-top:5px;">V19.0 Fixer</div>
                </div>
                <div class="nav-list">
                    <div class="nav-item active" onclick="nav('dashboard')"><i class="fa-solid fa-chart-pie"></i> ×“×©×‘×•×¨×“ ×× ×”×œ×™×</div>
                    <div class="nav-item" onclick="nav('crm')"><i class="fa-solid fa-users"></i> ×××’×¨ ×œ×§×•×—×•×ª</div>
                    <div class="nav-item" onclick="nav('calendar')"><i class="fa-solid fa-calendar-days"></i> ×™×•××Ÿ ×•××©×™××•×ª</div>
                    <div class="nav-item" onclick="nav('projects')"><i class="fa-solid fa-building"></i> ×¤×¨×•×™×§×˜×™×</div>
                    <div class="nav-item" onclick="nav('settings')"><i class="fa-solid fa-sliders"></i> ×”×’×“×¨×•×ª ×•×”×¨×©××•×ª</div>
                </div>
                <div class="user-panel">
                    <div>
                        <div id="lblUser" style="font-weight:bold;">××•×¨×—</div>
                        <div id="lblRole" style="font-size:10px; color:var(--accent);"></div>
                    </div>
                    <button class="btn-icon" onclick="doLogout()"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </aside>

            <main>
                <section id="dashboard" class="page">
                    <div class="header"><div class="page-title">×“×©×‘×•×¨×“ ×× ×”×œ×™×</div><div id="dateDisplay"></div></div>
                    
                    <div class="grid-3">
                        <div class="card">
                            <div class="stat-val" id="stTotal">0</div>
                            <div class="stat-label">×œ×§×•×—×•×ª ×‘×××’×¨</div>
                        </div>
                        <div class="card">
                            <div class="stat-val" id="stActive">0</div>
                            <div class="stat-label">×‘×˜×™×¤×•×œ ×¤×¢×™×œ</div>
                        </div>
                        <div class="card">
                            <div class="stat-val" id="stDeals">0</div>
                            <div class="stat-label">×¢×¡×§××•×ª ×”×—×•×“×©</div>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div class="card">
                            <h3>ğŸ“Š ×¤×™×œ×•×— ×œ×¤×™ ×¢×™×¨ ××’×•×¨×™×</h3>
                            <canvas id="cityChart" height="200"></canvas>
                        </div>
                         <div class="card">
                            <h3>ğŸ“ ×¤×™×œ×•×— ×œ×¤×™ ××•×¡×“×•×ª (×™×©×™×‘×•×ª)</h3>
                            <canvas id="yeshivaChart" height="200"></canvas>
                        </div>
                    </div>
                </section>

                <section id="crm" class="page" style="display:none;">
                    <div class="header">
                        <div class="page-title">×××’×¨ ×”×œ×§×•×—×•×ª</div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-white" onclick="document.getElementById('excelIn').click()"><i class="fa-solid fa-file-excel"></i> ×™×™×‘×•× ××§×¡×œ (××ª×•×§×Ÿ)</button>
                            <input type="file" id="excelIn" hidden>
                            <button class="btn btn-white admin-btn" onclick="exportExcel()"><i class="fa-solid fa-download"></i> ×™×™×¦×•×</button>
                            <button class="btn btn-primary" onclick="openModal()"><i class="fa-solid fa-plus"></i> ×—×“×©</button>
                        </div>
                    </div>

                    <div class="table-frame">
                        <div class="table-tools">
                            <div style="flex:1; position:relative;">
                                <i class="fa-solid fa-search" style="position:absolute; right:10px; top:10px; color:#94a3b8;"></i>
                                <input type="text" id="searchBox" placeholder="×—×™×¤×•×© ××§×™×£ (×©×, ×˜×œ×¤×•×Ÿ, ×”×¢×¨×•×ª, ×™×œ×“×™×...)" onkeyup="renderTable()" style="padding-right:30px; margin:0;">
                            </div>
                            <select id="filterStat" onchange="renderTable()" style="width:140px; margin:0; font-weight:bold;">
                                <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                                <option>×—×“×©</option>
                                <option>×‘×˜×™×¤×•×œ</option>
                                <option>××•"×</option>
                                <option>×—×•×–×”</option>
                                <option>×—×¡×•×</option>
                            </select>
                            <button class="btn btn-white" onclick="toggleColsMenu()"><i class="fa-solid fa-columns"></i> ×¢××•×“×•×ª</button>
                            
                            <div id="bulkActions" style="display:none; border-right:1px solid var(--border); padding-right:10px; gap:5px;">
                                <button class="btn btn-danger admin-btn" onclick="deleteSelected()"><i class="fa-solid fa-trash"></i> ××—×§ ××¡×•×× ×™×</button>
                                <span id="selectedCount" style="font-size:12px;">0 × ×‘×—×¨×•</span>
                            </div>
                        </div>
                        
                        <div id="colsMenu" class="cols-menu"></div>

                        <div class="table-body-scroll">
                            <table id="mainTable">
                                <thead id="tableHead"></thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="calendar" class="page" style="display:none;">
                    <div class="header">
                        <div class="page-title">×™×•××Ÿ</div>
                        <button class="btn btn-primary" onclick="openGeneralTaskModal()">+ ××©×™××” ××™×©×™×ª</button>
                    </div>
                    <div id="quickTaskArea" class="card" style="display:none; background:#eff6ff; border:1px solid var(--accent);">
                        <h4>×”×•×¡×¤×ª ××©×™××” ×œ×™×•××Ÿ</h4>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="genTaskTitle" placeholder="××©×™××”...">
                            <input type="date" id="genTaskDate">
                            <button class="btn btn-primary" onclick="addGeneralTask()">×©××•×¨</button>
                            <button class="btn btn-white" onclick="document.getElementById('quickTaskArea').style.display='none'">×‘×™×˜×•×œ</button>
                        </div>
                    </div>
                    <div id="calendarView" class="calendar-grid"></div>
                </section>

                <section id="settings" class="page" style="display:none;">
                    <div class="header"><div class="page-title">×”×’×“×¨×•×ª</div></div>
                    <div class="grid-3">
                        <div class="card">
                            <h3>×›×œ×œ×™</h3>
                            <label>×¨×™×‘×™×ª ×¤×¨×™×™× (%)</label>
                            <input type="number" id="setPrime" value="6.0">
                            <button class="btn btn-primary" onclick="saveSettings()">×©××•×¨</button>
                        </div>
                        <div class="card admin-btn">
                            <h3>× ×™×”×•×œ ××©×ª××©×™×</h3>
                            <div id="usersList" style="margin-bottom:10px; height:100px; overflow-y:auto; border:1px solid #eee; padding:5px;"></div>
                            <div style="display:flex; gap:5px;">
                                <input id="newUserEmail" placeholder="××™××™×™×œ" style="margin:0;">
                                <select id="newUserRole" style="margin:0; width:100px;"><option value="agent">×¡×•×›×Ÿ</option><option value="admin">×× ×”×œ</option></select>
                                <button class="btn btn-primary" onclick="addUser()">×”×•×¡×£</button>
                            </div>
                        </div>
                    </div>
                </section>
                
                 <section id="projects" class="page" style="display:none;">
                    <div class="header"><div class="page-title">×¤×¨×•×™×§×˜×™×</div></div>
                    <div class="card" style="text-align:center; padding:50px;">
                        <h3>××•×“×•×œ × ×™×”×•×œ ××œ××™ ×“×™×¨×•×ª (×‘×¤×™×ª×•×—)</h3>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-box">
            <div class="modal-head">
                <h2 id="modalTitle">×›×¨×˜×™×¡ ×œ×§×•×—</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn-icon" onclick="printClient()"><i class="fa-solid fa-print"></i></button>
                    <button class="btn-icon" onclick="closeModal()"><i class="fa-solid fa-times"></i></button>
                </div>
            </div>
            <div class="modal-content">
                <input type="hidden" id="editId">
                <div id="blockedAlert" style="display:none; background:#fee2e2; color:#b91c1c; padding:10px; border-radius:6px; margin-bottom:15px; font-weight:bold; text-align:center;">
                    âš ï¸ ×œ×§×•×— ×–×” ×—×¡×•×! (×‘×™×§×© ×œ×”×™××—×§)
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchTab(this, 't1')">×¤×¨×˜×™× ××™×©×™×™×</div>
                    <div class="tab" onclick="switchTab(this, 't2')">××©×¤×—×”</div>
                    <div class="tab" onclick="switchTab(this, 't3')">×¡×˜×˜×•×¡</div>
                    <div class="tab" onclick="switchTab(this, 't5')">×™×•××Ÿ</div>
                    <div class="tab" onclick="switchTab(this, 't4')">×›×œ×™×</div>
                </div>

                <div id="t1" class="tab-panel active">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                        <div><label>×©× ××œ×</label><input id="inpName"></div>
                        <div><label>×‘×Ÿ/×‘×ª ×–×•×’</label><input id="inpSpouse"></div>
                        <div><label>×˜×œ×¤×•×Ÿ (×—×•×‘×”)</label><input id="inpPhone"></div>
                        <div><label>×˜×œ×¤×•×Ÿ × ×•×¡×£</label><input id="inpPhone2"></div>
                        <div><label>××™××™×™×œ</label><input id="inpEmail"></div>
                        <div><label>×ª.×–</label><input id="inpId"></div>
                        <div style="grid-column:span 2; background:#f8fafc; padding:15px; border-radius:8px; border:1px solid var(--border);">
                            <label style="font-weight:bold; color:var(--accent);">× ×ª×•× ×™× × ×•×¡×¤×™× ××”××§×¡×œ (×™×©×™×‘×•×ª, ×›×ª×•×‘×ª ×•×›×•')</label>
                            <div id="customFields" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;"></div>
                        </div>
                    </div>
                </div>

                <div id="t2" class="tab-panel">
                    <div id="childrenList"></div>
                    <button class="btn btn-white" onclick="addChildRow()" style="width:100%; margin-top:10px;">+ ×”×•×¡×£ ×™×œ×“</button>
                </div>

                <div id="t3" class="tab-panel">
                    <div style="display:flex; gap:20px;">
                        <div style="flex:1"><label>×¡×˜×˜×•×¡</label><select id="inpStatus"><option>×—×“×©</option><option>×‘×˜×™×¤×•×œ</option><option>××•"×</option><option>×—×•×–×”</option><option>×—×¡×•×</option><option>×œ× ×¨×œ×•×•× ×˜×™</option></select></div>
                        <div style="flex:1"><label>×ª×§×¦×™×‘</label><input type="number" id="inpBudget"></div>
                        <div style="flex:1"><label>×¡×•×›×Ÿ</label><input id="inpAgent" readonly style="background:#eee;"></div>
                    </div>
                    <label>×”×¢×¨×•×ª (×›×•×œ×œ ×”×™×¡×˜×•×¨×™×” ×’×•×œ××™×ª)</label>
                    <textarea id="inpNotes" rows="10" style="font-family:monospace; font-size:12px;"></textarea>
                    <button class="btn btn-white" onclick="addTimestamp()">×”×•×¡×£ ×—×•×ª××ª ×–××Ÿ</button>
                </div>

                <div id="t5" class="tab-panel">
                    <div style="background:#eff6ff; padding:15px; border-radius:8px; margin-bottom:15px;">
                        <h4>×§×‘×¢ ×¤×’×™×©×” ×—×“×©×”</h4>
                        <div style="display:flex; gap:10px;">
                            <input type="date" id="meetDate" style="margin:0;">
                            <input type="time" id="meetTime" style="margin:0;">
                            <input type="text" id="meetNote" placeholder="× ×•×©×" style="margin:0;">
                            <button class="btn btn-primary" onclick="addMeeting()">×©×‘×¥</button>
                        </div>
                    </div>
                    <div id="clientMeetingsList"></div>
                </div>

                <div id="t4" class="tab-panel">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div class="card" style="margin:0;">
                            <h4>××—×©×‘×•×Ÿ ××©×›× ×ª×</h4>
                            <input type="number" id="mLoan" placeholder="×¡×›×•× ×”×œ×•×•××”">
                            <div style="font-weight:bold; margin-top:5px;">×”×—×–×¨: <span id="mRes">0</span> â‚ª</div>
                            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="calcModal()">×—×©×‘</button>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <button class="btn btn-white comm-btn" onclick="sendWhatsapp()"><i class="fa-brands fa-whatsapp" style="color:#25D366;"></i> ×•×•××˜×¡××¤</button>
                            <button class="btn btn-white comm-btn" onclick="sendEmail()"><i class="fa-solid fa-envelope"></i> ××™××™×™×œ</button>
                            <button class="btn btn-white" onclick="genPDF()"><i class="fa-solid fa-file-pdf"></i> ×”×¤×§ PDF</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-danger admin-btn" id="btnDelete" onclick="deleteClient()" style="display:none;">××—×§</button>
                <div style="flex:1"></div>
                <button class="btn btn-white" onclick="closeModal()">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveData()">×©××•×¨</button>
            </div>
        </div>
    </div>
    
    <div id="dupesModal" class="modal">
        <div class="modal-box" style="max-width:600px;">
            <div class="modal-head"><h2>âš ï¸ × ××¦××• ×¨×©×•××•×ª ×›×¤×•×œ×•×ª</h2></div>
            <div class="modal-content">
                <p>×”××¢×¨×›×ª ×–×™×”×ª×” ×©×”×œ×§×•×—×•×ª ×”×‘××™× ×›×‘×¨ ×§×™×™××™× ×‘×××’×¨ (×œ×¤×™ ×˜×œ×¤×•×Ÿ ××• ×ª.×–). ×”× <b>×œ×</b> × ×•×¡×¤×• ××—×“×©.</p>
                <textarea id="dupesList" rows="10" style="width:100%; font-family:monospace;" readonly></textarea>
            </div>
            <div class="modal-foot">
                <button class="btn btn-primary" onclick="document.getElementById('dupesModal').style.display='none'">×”×‘× ×ª×™, ×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJvUDVuccEZSuTsUSs7o-hnpME2WaTWio", 
            authDomain: "nadlan-pro.firebaseapp.com",
            projectId: "nadlan-pro",
            storageBucket: "nadlan-pro.firebasestorage.app",
            messagingSenderId: "435010903224",
            appId: "1:435010903224:web:53cc66ba40fa3d4198e84d",
            measurementId: "G-VRX35WJ2PE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let userRole = 'agent';
        let clientsData = {};
        let meetingsData = {};
        let usersData = {};
        let settingsData = { prime: 6.0 };
        let customHeaders = new Set();
        let visibleCols = ['name', 'phone', 'city', 'status', 'budget'];
        let selectedClients = new Set();
        let charts = {}; // ×œ×©××™×¨×ª ×”×’×¨×¤×™×

        // --- ×”×ª×—×‘×¨×•×ª ---
        document.getElementById('btnLogin').addEventListener('click', () => {
            const e = document.getElementById('txtEmail').value;
            const p = document.getElementById('txtPass').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => alert(err.message));
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('lblUser').innerText = user.email;
                initData();
                document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('he-IL');
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        window.doLogout = () => signOut(auth);

        function initData() {
            onValue(ref(db, 'users'), snap => {
                usersData = snap.val() || {};
                const myUser = Object.values(usersData).find(u => u.email === currentUser.email);
                userRole = (Object.keys(usersData).length === 0) ? 'admin' : (myUser ? myUser.role : 'agent');
                if(Object.keys(usersData).length === 0) push(ref(db, 'users'), { email: currentUser.email, role: 'admin' });
                
                document.getElementById('lblRole').innerText = userRole === 'admin' ? '×× ×”×œ' : '×¡×•×›×Ÿ';
                applyPermissions();
                renderUsersList();
            });

            onValue(ref(db, 'clients'), snap => {
                clientsData = snap.val() || {};
                // ×¢×“×›×•×Ÿ ×©×“×•×ª ××™×•×—×“×™× ××›×œ ×”×œ×§×•×—×•×ª
                Object.values(clientsData).forEach(c => {
                    if(c.customData) Object.keys(c.customData).forEach(k => customHeaders.add(k));
                });
                renderTable();
                updateStats();
                updateCharts();
            });

            onValue(ref(db, 'meetings'), snap => {
                meetingsData = snap.val() || {};
                renderCalendar(); 
            });
        }

        function applyPermissions() {
            const isAdmin = userRole === 'admin';
            document.querySelectorAll('.admin-btn').forEach(el => el.style.display = isAdmin ? 'inline-flex' : 'none');
        }

        // --- ×™×™×‘×•× ××§×¡×œ ×”××ª×•×§×Ÿ (×¢× ×¨×©×™××ª ×›×¤×™×œ×•×™×•×ª) ---
        document.getElementById('excelIn').addEventListener('change', (e) => {
            const fileName = e.target.files[0].name;
            const r = new FileReader();
            
            r.onload = ex => {
                const w = XLSX.read(new Uint8Array(ex.target.result), {type:'array'});
                const d = XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]]);
                let count = 0;
                let dupesLog = "";
                const isBlacklist = fileName.includes("×œ××—×•×§") || fileName.includes("×—×¡×•×");

                const findVal = (row, keywords) => {
                    const key = Object.keys(row).find(k => keywords.some(w => k.includes(w)));
                    return key ? row[key] : '';
                };

                d.forEach(row => {
                    const phone = String(findVal(row, ['× ×™×™×“','×˜×œ×¤×•×Ÿ','×¤×œ××¤×•×Ÿ']) || '').replace(/\D/g,'');
                    const idNum = String(findVal(row, ['×ª.×–','×–×”×•×ª']) || '');
                    
                    // ×‘×“×™×§×ª ×›×¤×™×œ×•×ª
                    const exists = Object.values(clientsData).find(c => (c.phone === phone && phone.length>5) || (c.idNum === idNum && idNum.length>5));
                    
                    if (exists) {
                        dupesLog += `× ××¦×: ${exists.name} (×˜×œ×¤×•×Ÿ: ${exists.phone}) - ×œ× ×™×•×‘× ×©×•×‘.\n`;
                    } else if (phone.length > 0) {
                        const name = findVal(row, ['×©× ××©×¤×—×”','×©× ×¤×¨×˜×™','×©×']) || '×œ×œ× ×©×';
                        
                        const c = {
                            name: name + ' ' + (findVal(row, ['×¤×¨×˜×™']) || ''),
                            spouse: findVal(row, ['××©×”','××™×©×”','×–×•×’']) || '',
                            phone: phone,
                            phone2: String(findVal(row, ['×˜×œ×¤×•×Ÿ 2','× ×•×¡×£','××™×©×”']) || '').replace(/\D/g,''),
                            email: findVal(row, ['××™×™×œ','×“×•×']),
                            idNum: idNum,
                            city: findVal(row, ['×¢×™×¨','×›×ª×•×‘×ª']),
                            status: isBlacklist ? '×—×¡×•×' : '×—×“×©',
                            notes: `\n--- ×™×™×‘×•× ${fileName} ---\n`,
                            lastUpdate: Date.now(),
                            agent: currentUser.email,
                            children: [],
                            customData: {} 
                        };

                        // ×©××™×‘×ª ×›×œ ×”×©×“×•×ª
                        for (let [key, val] of Object.entries(row)) {
                            if(val) {
                                c.notes += `${key}: ${val}\n`; 
                                // ×”×›× ×¡×ª ×©×“×•×ª ×©×œ× ×–×•×”×• ×œ×©×“×•×ª ××™×•×—×“×™×
                                if(!['×©×','×˜×œ×¤×•×Ÿ','××™×™×œ','×ª.×–'].some(x=>key.includes(x))) {
                                    c.customData[key] = val;
                                    customHeaders.add(key); // ×”×•×¡×¤×” ×œ×¨×©×™××ª ×”×¢××•×“×•×ª ×”×›×œ×œ×™×ª
                                }
                            }
                        }

                        // ×™×œ×“×™×
                        for(let i=1; i<=15; i++) {
                            const childName = findVal(row, [`×©× ×”×™×œ×“${i}`, `×©× ×™×œ×“ ${i}`, `×™×œ×“ ${i}`]);
                            if (childName) {
                                c.children.push({ name: childName, id: findVal(row, [`×ª. ×–×”×•×ª${i}`]) || '' });
                            }
                        }
                        push(ref(db, 'clients'), c);
                        count++;
                    }
                });
                
                // ×“×•×— ×œ××©×ª××©
                if (dupesLog) {
                    document.getElementById('dupesList').value = dupesLog;
                    document.getElementById('dupesModal').style.display = 'flex';
                } else {
                    alert(`×™×™×‘×•× ×”×•×©×œ×! ${count} ×œ×§×•×—×•×ª ×—×“×©×™×.`);
                }
            };
            r.readAsArrayBuffer(e.target.files[0]);
        });

        // --- ×˜×‘×œ×” ×•×—×™×¤×•×© ---
        window.renderTable = () => {
            const tbody = document.getElementById('tableBody');
            const thead = document.getElementById('tableHead');
            const search = document.getElementById('searchBox').value.toLowerCase();
            const filter = document.getElementById('filterStat').value;
            
            let cols = ['checkbox', 'name', 'phone', 'status', 'city', 'agent'];
            visibleCols.forEach(c => { if(!cols.includes(c) && c!=='checkbox') cols.push(c); });
            
            let headHtml = `<tr><th style="width:30px"><input type="checkbox" onchange="toggleSelectAll(this)"></th>`;
            cols.filter(x=>x!=='checkbox').forEach(c => headHtml += `<th>${c}</th>`);
            headHtml += `<th>×¤×¢×•×œ×•×ª</th></tr>`;
            thead.innerHTML = headHtml;
            tbody.innerHTML = '';

            Object.entries(clientsData).forEach(([key, c]) => {
                if (userRole !== 'admin' && c.agent !== currentUser.email) return;
                if (filter && c.status !== filter) return;
                
                // ×—×™×¤×•×© ×¢××•×§ ×•××ª×§×Ÿ
                const fullText = JSON.stringify(c).toLowerCase();
                if (search && !fullText.includes(search)) return;

                const tr = document.createElement('tr');
                if (c.status === '×—×¡×•×') tr.classList.add('blocked-row');

                let html = `<td><input type="checkbox" class="client-cb" value="${key}" onchange="updateSelection()"></td>`;
                
                cols.filter(x=>x!=='checkbox').forEach(col => {
                    let v = '-';
                    if(col==='name') v = `<b>${c.name}</b><br><small>${c.spouse||''}</small>`;
                    // ×¢×¨×™×›×” ××”×™×¨×” ×œ×¡×˜×˜×•×¡
                    else if(col==='status') {
                        v = `<select class="quick-select" onchange="quickStatus('${key}', this.value)" style="background:${stColor(c.status)}">
                                <option>${c.status}</option>
                                <option>×—×“×©</option><option>×‘×˜×™×¤×•×œ</option><option>××•"×</option><option>×—×•×–×”</option><option>×—×¡×•×</option>
                             </select>`;
                    }
                    else if(col==='agent') v = c.agent ? c.agent.split('@')[0] : '-';
                    else v = c[col] || (c.customData ? c.customData[col] : '') || '-';
                    html += `<td>${v}</td>`;
                });
                
                html += `<td><button class="btn-icon" onclick="editClient('${key}')"><i class="fa-solid fa-pen"></i></button></td>`;
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        };

        window.quickStatus = (id, newStat) => {
            update(ref(db, 'clients/'+id), { status: newStat, lastUpdate: Date.now() });
        };

        window.toggleSelectAll = (el) => {
            document.querySelectorAll('.client-cb').forEach(cb => cb.checked = el.checked);
            updateSelection();
        };

        window.updateSelection = () => {
            selectedClients.clear();
            document.querySelectorAll('.client-cb:checked').forEach(cb => selectedClients.add(cb.value));
            document.getElementById('bulkActions').style.display = selectedClients.size > 0 ? 'flex' : 'none';
            document.getElementById('selectedCount').innerText = selectedClients.size + ' × ×‘×—×¨×•';
        };

        window.deleteSelected = () => {
            if(confirm('×‘×˜×•×— ×œ××—×•×§?')) {
                selectedClients.forEach(id => remove(ref(db, 'clients/'+id)));
                selectedClients.clear();
                updateSelection();
            }
        };

        // --- ×¢×¨×™×›×” (×ª×™×§×•×Ÿ ×‘××’ ×”× ×ª×•× ×™× ×”×—×¡×¨×™×) ---
        window.editClient = (id) => {
            const c = clientsData[id];
            document.getElementById('editId').value = id;
            document.getElementById('inpName').value = c.name;
            document.getElementById('inpSpouse').value = c.spouse || '';
            document.getElementById('inpPhone').value = c.phone;
            document.getElementById('inpPhone2').value = c.phone2 || '';
            document.getElementById('inpEmail').value = c.email || '';
            document.getElementById('inpId').value = c.idNum || '';
            document.getElementById('inpStatus').value = c.status;
            document.getElementById('inpBudget').value = c.budget || '';
            document.getElementById('inpAgent').value = c.agent || '';
            document.getElementById('inpNotes').value = c.notes || '';
            
            document.getElementById('blockedAlert').style.display = (c.status === '×—×¡×•×') ? 'block' : 'none';

            // ×™×œ×“×™×
            document.getElementById('childrenList').innerHTML = '';
            if(c.children) c.children.forEach(k => window.addChildRow(k.name, k.id));
            
            // ×©×“×•×ª ××™×•×—×“×™× - ×ª×™×§×•×Ÿ ×§×¨×™×˜×™: ××¦×™×’ ××ª ×›×œ ×”×©×“×•×ª ×©× ×©××¨×• ×‘-CustomData
            const cfDiv = document.getElementById('customFields');
            cfDiv.innerHTML = '';
            
            // ××™×—×•×“ ×›×œ ×”×©×“×•×ª ×”××¤×©×¨×™×™× (×’× ××œ×• ×©×‘××¢×¨×›×ª ×•×’× ××œ×• ×©×‘×›×¨×˜×™×¡ ×”×¡×¤×¦×™×¤×™)
            const allKeys = new Set([...customHeaders, ...Object.keys(c.customData || {})]);
            
            allKeys.forEach(k => {
                const val = (c.customData && c.customData[k]) ? c.customData[k] : '';
                cfDiv.innerHTML += `<div><label style="font-size:11px;">${k}</label><input class="cf-inp" data-key="${k}" value="${val}"></div>`;
            });

            renderClientMeetings(id);
            document.getElementById('btnDelete').style.display = (userRole === 'admin') ? 'block' : 'none';
            document.getElementById('modal').style.display = 'flex';
        };

        window.saveData = () => {
            const id = document.getElementById('editId').value;
            const c = {
                name: document.getElementById('inpName').value,
                spouse: document.getElementById('inpSpouse').value,
                phone: document.getElementById('inpPhone').value,
                phone2: document.getElementById('inpPhone2').value,
                email: document.getElementById('inpEmail').value,
                idNum: document.getElementById('inpId').value,
                status: document.getElementById('inpStatus').value,
                budget: document.getElementById('inpBudget').value,
                notes: document.getElementById('inpNotes').value,
                lastUpdate: Date.now(),
                agent: id ? document.getElementById('inpAgent').value : currentUser.email,
                children: [],
                customData: {}
            };
            
            document.querySelectorAll('.cr-row').forEach(r => c.children.push({name: r.querySelector('.cn').value, id: r.querySelector('.ci').value}));
            document.querySelectorAll('.cf-inp').forEach(i => c.customData[i.dataset.key] = i.value);

            if(id) update(ref(db, 'clients/'+id), c);
            else push(ref(db, 'clients'), c);
            
            if(c.status === '×—×•×–×”') confetti();
            closeModal();
        };

        // --- ×“×©×‘×•×¨×“ ×•×’×¨×¤×™× (×—×“×© ×‘-V19) ---
        window.updateCharts = () => {
            const cities = {};
            const yeshivas = {};
            
            Object.values(clientsData).forEach(c => {
                // ×¢×¨×™×
                const city = c.city || '×œ× ×™×“×•×¢';
                cities[city] = (cities[city] || 0) + 1;

                // ×™×©×™×‘×•×ª (××—×¤×© ×‘×©×“×•×ª ×”××•×ª×××™×)
                const y = c.customData ? (c.customData['×™×©×™×‘×”'] || c.customData['×™×©×™×‘×” ×‘×” ×œ××“']) : null;
                if(y) yeshivas[y] = (yeshivas[y] || 0) + 1;
            });

            renderChart('cityChart', cities, '×¢×¨×™× ××•×‘×™×œ×•×ª');
            renderChart('yeshivaChart', yeshivas, '××•×¡×“×•×ª ×œ×™××•×“');
        };

        function renderChart(id, data, label) {
            const ctx = document.getElementById(id).getContext('2d');
            const labels = Object.keys(data).sort((a,b) => data[b]-data[a]).slice(0, 5); // ×˜×•×¤ 5
            const values = labels.map(k => data[k]);
            
            if(charts[id]) charts[id].destroy(); // × ×™×§×•×™ ×’×¨×£ ×™×©×Ÿ
            
            charts[id] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: values,
                        backgroundColor: '#3b82f6',
                        borderRadius: 5
                    }]
                },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ (×œ×œ× ×©×™× ×•×™ ××”×•×ª×™) ---
        window.openModal = () => {
            document.getElementById('editId').value = '';
            document.getElementById('inpName').value = '';
            document.getElementById('childrenList').innerHTML = '';
            document.getElementById('customFields').innerHTML = '';
            // ×˜×¢×™× ×ª ×©×“×•×ª ××•×ª×××™× ×¨×™×§×™× ×œ×œ×§×•×— ×—×“×©
            customHeaders.forEach(k => {
                 document.getElementById('customFields').innerHTML += `<div><label style="font-size:11px;">${k}</label><input class="cf-inp" data-key="${k}"></div>`;
            });
            document.getElementById('modal').style.display = 'flex';
        }

        window.closeModal = () => document.getElementById('modal').style.display = 'none';
        window.deleteClient = () => { if(confirm('×œ××—×•×§?')) { remove(ref(db, 'clients/'+document.getElementById('editId').value)); closeModal(); } };
        window.addGeneralTask = () => { push(ref(db, 'meetings'), { clientId: 'general', clientName: '××©×™××”', date: document.getElementById('genTaskDate').value, time: '09:00', note: document.getElementById('genTaskTitle').value, agent: currentUser.email }); document.getElementById('quickTaskArea').style.display='none'; };
        
        window.renderCalendar = () => {
            const container = document.getElementById('calendarView');
            if(!container) return;
            container.innerHTML = '';
            const sorted = Object.entries(meetingsData).sort((a,b) => (a[1].date+a[1].time).localeCompare(b[1].date+b[1].time));
            const grouped = {};
            sorted.forEach(([id, m]) => { if(!grouped[m.date]) grouped[m.date]=[]; grouped[m.date].push({id, ...m}); });
            Object.keys(grouped).forEach(date => {
                let html = `<div class="day-col"><div class="day-title">${new Date(date).toLocaleDateString('he-IL')}</div>`;
                grouped[date].forEach(evt => {
                    html += `<div class="cal-event" style="border-color:${evt.clientId==='general'?'#22c55e':'#3b82f6'}"><b>${evt.time}</b> ${evt.clientName}<br>${evt.note}</div>`;
                });
                html += `</div>`;
                container.innerHTML += html;
            });
        };

        window.nav = (p) => { document.querySelectorAll('.page').forEach(x => x.style.display='none'); document.getElementById(p).style.display='block'; if(p==='calendar') renderCalendar(); };
        window.toggleColsMenu = () => { const m = document.getElementById('colsMenu'); m.style.display = m.style.display==='block'?'none':'block'; m.innerHTML = ''; [...visibleCols, ...customHeaders].forEach(k => m.innerHTML += `<div><label><input type="checkbox" onchange="toggleCol('${k}')" ${visibleCols.includes(k)?'checked':''}> ${k}</label></div>`); };
        window.toggleCol = (k) => { const i = visibleCols.indexOf(k); if(i>-1) visibleCols.splice(i,1); else visibleCols.push(k); renderTable(); };
        window.stColor = (s) => ({'×—×“×©':'#e2e8f0','××•"×':'#fde047','×—×•×–×”':'#86efac','×—×¡×•×':'#fecaca'}[s]||'white');
        window.switchTab = (el, id) => { document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.tab-panel').forEach(x=>x.classList.remove('active')); el.classList.add('active'); document.getElementById(id).classList.add('active'); };
        window.addChildRow = (n='', i='') => document.getElementById('childrenList').insertAdjacentHTML('beforeend', `<div class="cr-row"><input class="cn" value="${n}" placeholder="×©×"><input class="ci" value="${i}" placeholder="×ª.×–"><button type="button" class="btn-icon" onclick="this.parentElement.remove()">-</button></div>`);
        window.addTimestamp = () => document.getElementById('inpNotes').value = `[${new Date().toLocaleString()} ${currentUser.email.split('@')[0]}] ` + document.getElementById('inpNotes').value;
        window.calcModal = () => { const p=Number(document.getElementById('mLoan').value), r=0.065/12, n=300; document.getElementById('mRes').innerText = Math.round(p*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1)).toLocaleString(); };
        window.updateStats = () => { const a = Object.values(clientsData); document.getElementById('stTotal').innerText = a.length; document.getElementById('stActive').innerText = a.filter(c=>['×‘×˜×™×¤×•×œ','××•"×'].includes(c.status)).length; document.getElementById('stDeals').innerText = a.filter(c=>c.status==='×—×•×–×”').length; };
        
        // ××©×ª××©×™× (× ×™×”×•×œ)
        window.addUser = () => { push(ref(db, 'users'), { email: document.getElementById('newUserEmail').value, role: document.getElementById('newUserRole').value }); renderUsersList(); };
        function renderUsersList() { const div = document.getElementById('usersList'); div.innerHTML = ''; Object.values(usersData).forEach(u => div.innerHTML += `<div>${u.email} - ${u.role}</div>`); }
    </script>
</body>
</html>
