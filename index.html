<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×“×œ"×Ÿ PRO 15.0 - ×”××¢×¨×›×ª ×”×¡×•×¤×™×ª</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- ×¢×™×¦×•×‘ ×’×œ×•×‘×œ×™ --- */
        :root {
            --primary: #0f172a; --primary-hover: #1e293b;
            --accent: #2563eb; --accent-hover: #1d4ed8;
            --bg: #f1f5f9; --surface: #ffffff; 
            --border: #cbd5e1; --text: #0f172a; --text-muted: #64748b;
            --danger: #ef4444; --success: #22c55e; --warning: #f59e0b;
            --radius: 10px; --shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --primary: #020617; --primary-hover: #1e293b;
            --accent: #60a5fa; --accent-hover: #3b82f6;
            --bg: #0f172a; --surface: #1e293b; --border: #334155;
            --text: #f8fafc; --text-muted: #94a3b8;
            --shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Rubik', sans-serif; outline: none; transition: background 0.2s, color 0.2s; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; margin: 0; }

        /* ××¡×š ×›× ×™×¡×” */
        #loginOverlay { position: fixed; inset: 0; background: linear-gradient(135deg, var(--primary) 0%, #000 100%); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .login-card { background: white; padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .login-card h1 { color: var(--primary); margin-bottom: 5px; }
        .login-input { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; background: #f8fafc; }
        .login-btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .login-btn:hover { background: var(--accent-hover); transform: translateY(-2px); }

        /* ××‘× ×” ×¨××©×™ */
        #mainApp { display: none; height: 100%; width: 100%; }
        .layout-container { display: flex; height: 100%; }

        /* ×¡×¨×’×œ ×¦×“ */
        aside { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; z-index: 50; box-shadow: 5px 0 25px rgba(0,0,0,0.15); }
        .brand { padding: 30px; text-align: center; background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .brand-title { font-size: 24px; font-weight: 900; letter-spacing: 1px; color: white; }
        .nav-list { flex: 1; padding: 20px; overflow-y: auto; }
        .nav-item { padding: 14px 15px; border-radius: var(--radius); cursor: pointer; display: flex; align-items: center; gap: 12px; color: #94a3b8; margin-bottom: 8px; font-weight: 500; transition: 0.2s; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; transform: translateX(5px); }
        .nav-item.active { background: var(--accent); color: white; font-weight: 700; box-shadow: 0 0 20px rgba(37, 99, 235, 0.4); }
        .user-panel { padding: 20px; background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }

        /* ×ª×•×›×Ÿ */
        main { flex: 1; padding: 30px; overflow-y: auto; position: relative; background: var(--bg); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 28px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 12px; }
        [data-theme="dark"] .page-title { color: var(--text); }

        /* ×’×¨×™×“ ×›×¨×˜×™×¡×™× */
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--surface); padding: 25px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); position: relative; overflow: hidden; transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .stat-val { font-size: 38px; font-weight: 800; margin-top: 5px; color: var(--text); }
        .stat-label { font-size: 14px; color: var(--text-muted); font-weight: 500; }
        
        .card { background: var(--surface); padding: 25px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); margin-bottom: 25px; }

        /* ×˜×‘×œ×” */
        .table-frame { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); display: flex; flex-direction: column; height: calc(100vh - 180px); overflow: hidden; position: relative; }
        .table-tools { padding: 15px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; background: var(--bg); flex-wrap: wrap; }
        .table-body-scroll { overflow: auto; flex: 1; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th { background: var(--surface); text-align: right; padding: 16px; font-weight: 700; color: var(--text-muted); font-size: 13px; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--border); white-space: nowrap; }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; color: var(--text); }
        tr:hover { background: rgba(59, 130, 246, 0.05); cursor: pointer; }

        /* ×›×¤×ª×•×¨×™× */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; font-size: 13px; transition: 0.2s; white-space: nowrap; }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-2px); }
        .btn-white { background: var(--surface); border: 1px solid var(--border); color: var(--text); }
        .btn-white:hover { border-color: var(--accent); color: var(--accent); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-icon { padding: 8px; border-radius: 6px; background: transparent; border: none; cursor: pointer; color: var(--text-muted); font-size: 16px; }
        .btn-icon:hover { background: rgba(0,0,0,0.05); color: var(--accent); }
        
        input, select, textarea { background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 8px; width: 100%; font-size: 14px; margin-bottom: 10px; transition: 0.2s; }
        input:focus { border-color: var(--accent); outline: 3px solid rgba(59, 130, 246, 0.1); }

        /* ××•×“××œ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--surface); width: 95%; max-width: 1100px; border-radius: 16px; max-height: 95vh; display: flex; flex-direction: column; box-shadow: 0 50px 100px -20px rgba(0,0,0,0.25); animation: slideUp 0.3s; }
        .modal-head { padding: 20px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-content { padding: 30px; overflow-y: auto; flex: 1; }
        .modal-foot { padding: 20px 30px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: var(--bg); border-radius: 0 0 16px 16px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* ×˜××‘×™× */
        .tabs { display: flex; gap: 25px; border-bottom: 1px solid var(--border); margin-bottom: 25px; }
        .tab { padding: 12px 0; cursor: pointer; color: var(--text-muted); font-weight: 500; border-bottom: 3px solid transparent; }
        .tab.active { color: var(--accent); border-color: var(--accent); font-weight: 700; }
        .tab-panel { display: none; animation: fadeIn 0.3s; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ×™×•××Ÿ */
        .meet-row { display: flex; justify-content: space-between; align-items: center; background: var(--bg); padding: 15px; margin-bottom: 10px; border-radius: 10px; border-right: 4px solid var(--accent); }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .cols-menu { position: absolute; top: 60px; left: 15px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 100; display: none; min-width: 240px; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card">
            <div style="font-size: 60px; margin-bottom: 10px;">ğŸ›¡ï¸</div>
            <h1>× ×“×œ"×Ÿ PRO <span style="font-size:16px; opacity:0.6; font-weight:400;">Cloud</span></h1>
            <p style="margin-bottom: 30px; color: #64748b;">×›× ×™×¡×” ×œ××¢×¨×›×ª (×•×•×“× ×©×™×¦×¨×ª ××©×ª××©)</p>
            <input type="email" id="txtEmail" class="login-input" placeholder="××™××™×™×œ">
            <input type="password" id="txtPass" class="login-input" placeholder="×¡×™×¡××”">
            <button class="login-btn" id="btnLogin">×”×ª×—×‘×¨</button>
            <div id="loginError" style="color:var(--danger); margin-top:15px; font-size:13px;"></div>
        </div>
    </div>

    <div id="mainApp">
        <div class="layout-container">
            <aside>
                <div class="brand">
                    <div class="brand-title">ğŸ¢ × ×“×œ"×Ÿ PRO</div>
                    <div style="font-size:11px; opacity:0.6; margin-top:5px;">V15.0 Enterprise</div>
                </div>
                <div class="nav-list">
                    <div class="nav-item active" onclick="nav('dashboard')"><i class="fa-solid fa-chart-line"></i> ×“×©×‘×•×¨×“ ×× ×”×œ×™×</div>
                    <div class="nav-item" onclick="nav('crm')"><i class="fa-solid fa-users"></i> ×××’×¨ ×œ×§×•×—×•×ª</div>
                    <div class="nav-item" onclick="nav('calendar')"><i class="fa-solid fa-calendar-days"></i> ×™×•××Ÿ ×•×¤×’×™×©×•×ª</div>
                    <div class="nav-item" onclick="nav('projects')"><i class="fa-solid fa-building"></i> ×¤×¨×•×™×§×˜×™×</div>
                    <div class="nav-item" onclick="nav('settings')"><i class="fa-solid fa-sliders"></i> ×”×’×“×¨×•×ª ××¢×¨×›×ª</div>
                </div>
                <div class="user-panel">
                    <div>
                        <div id="lblUser" style="font-weight:bold;">××•×¨×—</div>
                        <div style="font-size:11px; opacity:0.7;">××—×•×‘×¨ ×œ×¢× ×Ÿ</div>
                    </div>
                    <button class="btn-icon" onclick="doLogout()" style="color:white;" title="×”×ª× ×ª×§"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </aside>

            <main>
                <section id="dashboard" class="page">
                    <div class="header">
                        <div class="page-title"><i class="fa-solid fa-gauge-high"></i> ××¨×›×– ×©×œ×™×˜×”</div>
                        <div style="font-weight:bold; color:var(--accent);" id="dateDisplay"></div>
                    </div>

                    <div class="grid-3">
                        <div class="stat-card" onclick="nav('crm')">
                            <div class="stat-val" id="stTotal">0</div>
                            <div class="stat-label">×¡×”"×› ×œ×§×•×—×•×ª</div>
                            <i class="fa-solid fa-database" style="position:absolute; bottom:15px; left:15px; font-size:60px; opacity:0.05;"></i>
                        </div>
                        <div class="stat-card" style="border-bottom: 4px solid var(--warning);">
                            <div class="stat-val" id="stActive">0</div>
                            <div class="stat-label">×‘×˜×™×¤×•×œ / ××•"×</div>
                            <i class="fa-solid fa-fire" style="position:absolute; bottom:15px; left:15px; font-size:60px; opacity:0.05; color:var(--warning);"></i>
                        </div>
                        <div class="stat-card" style="border-bottom: 4px solid var(--success);">
                            <div class="stat-val" id="stDeals">0</div>
                            <div class="stat-label">×—×•×–×™× ×”×—×•×“×©</div>
                            <i class="fa-solid fa-handshake" style="position:absolute; bottom:15px; left:15px; font-size:60px; opacity:0.05; color:var(--success);"></i>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:25px;">
                        <div class="card">
                            <h3 style="margin-bottom:20px; color:var(--primary);">ğŸ“Š ×¢×“×›×•× ×™× ××—×¨×•× ×™× ×‘×–××Ÿ ×××ª</h3>
                            <div id="liveFeed" style="font-size:13px; line-height:2.2; color:var(--text-muted);">
                                <div>×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×¢× ×Ÿ...</div>
                            </div>
                        </div>
                        <div class="card" style="border:1px solid var(--accent);">
                            <h4 style="margin-bottom:15px; color:var(--accent);">ğŸ§® ××—×©×‘×•×Ÿ ××©×›× ×ª× ××”×™×¨</h4>
                            <input type="number" id="qLoan" placeholder="×¡×›×•× ×”×œ×•×•××”">
                            <div style="display:flex; gap:10px;">
                                <input type="number" id="qSpread" placeholder="××¨×•×•×— (0.5)" value="0.5">
                                <input type="number" id="qYears" placeholder="×©× ×™× (25)" value="25">
                            </div>
                            <button class="btn btn-primary" style="width:100%;" onclick="quickCalc()">×—×©×‘ ×”×—×–×¨</button>
                            <div style="text-align:center; font-size:24px; font-weight:800; margin-top:15px; color:var(--primary);" id="qRes">0 â‚ª</div>
                        </div>
                    </div>
                </section>

                <section id="crm" class="page" style="display:none;">
                    <div class="header">
                        <div class="page-title">×××’×¨ ×”×œ×§×•×—×•×ª</div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-white" onclick="document.getElementById('excelIn').click()"><i class="fa-solid fa-file-excel"></i> ×™×™×‘×•× ××§×¡×œ</button>
                            <input type="file" id="excelIn" hidden>
                            <button class="btn btn-primary" onclick="openModal()"><i class="fa-solid fa-plus"></i> ×œ×§×•×— ×—×“×©</button>
                        </div>
                    </div>

                    <div class="table-frame">
                        <div class="table-tools">
                            <div style="flex:1; position:relative;">
                                <i class="fa-solid fa-search" style="position:absolute; right:10px; top:12px; color:#94a3b8;"></i>
                                <input type="text" id="searchBox" placeholder="×—×™×¤×•×© ×—×›× (×©×, ×ª.×–, ×™×©×™×‘×”, ×¢×™×¡×•×§, ×˜×œ×¤×•×Ÿ...)" onkeyup="renderTable()" style="padding-right:35px; max-width:350px; margin:0;">
                            </div>
                            <div style="height:25px; width:1px; background:var(--border);"></div>
                            <select id="filterStat" onchange="renderTable()" style="width:150px; margin:0; font-weight:bold;">
                                <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                                <option>×—×“×©</option>
                                <option>×‘×˜×™×¤×•×œ</option>
                                <option>××•"×</option>
                                <option>×—×•×–×”</option>
                            </select>
                            <button class="btn btn-white" onclick="toggleColsMenu()"><i class="fa-solid fa-gear"></i></button>
                        </div>
                        
                        <div id="colsMenu" class="cols-menu"></div>

                        <div class="table-body-scroll">
                            <table id="mainTable">
                                <thead id="tableHead"></thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="calendar" class="page" style="display:none;">
                    <div class="header">
                        <div class="page-title">×™×•××Ÿ ×¤×’×™×©×•×ª</div>
                        <button class="btn btn-primary" onclick="nav('crm'); alert('×‘×—×¨ ×œ×§×•×— ××”×××’×¨ ×›×“×™ ×œ×§×‘×•×¢ ×¤×’×™×©×”');">+ ×¤×’×™×©×” ×—×“×©×”</button>
                    </div>
                    <div class="card">
                        <div id="calendarList"></div>
                    </div>
                </section>

                <section id="projects" class="page" style="display:none;">
                    <div class="header">
                        <div class="page-title">× ×™×”×•×œ ×¤×¨×•×™×§×˜×™×</div>
                    </div>
                    <div class="card">
                        <div style="text-align:center; padding:50px; color:var(--text-muted);">
                            <i class="fa-solid fa-person-digging" style="font-size:50px; margin-bottom:20px;"></i>
                            <h3>××•×“×•×œ ×¤×¨×•×™×§×˜×™× ×‘×‘× ×™×™×”</h3>
                            <p>×›××Ÿ ×ª×•×›×œ ×œ× ×”×œ ×©×™×•×•×§ ×©×œ ×‘× ×™×™× ×™× ×—×“×©×™× ×•×ª×"× 38.</p>
                            </div>
                    </div>
                </section>

                <section id="settings" class="page" style="display:none;">
                    <div class="header"><div class="page-title">×”×’×“×¨×•×ª</div></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                        <div class="card">
                            <h3>×›×œ×œ×™</h3>
                            <label>×¨×™×‘×™×ª ×¤×¨×™×™× (%)</label>
                            <input type="number" id="setPrime" value="6.0">
                            <button class="btn btn-primary" onclick="saveSettings()">×©××•×¨ ×”×’×“×¨×•×ª</button>
                        </div>
                        <div class="card">
                            <h3>×’×™×‘×•×™ × ×ª×•× ×™×</h3>
                            <p>×”××¢×¨×›×ª ××’×•×‘×” ×‘×¢× ×Ÿ ×©×œ ×’×•×’×œ. ×‘× ×•×¡×£, ××•××œ×¥ ×œ×”×•×¨×™×“ ×¢×•×ª×§ ×œ××—×©×‘.</p>
                            <button class="btn btn-white" onclick="exportExcel()">×”×•×¨×“ ××ª ×›×œ ×”×××’×¨ ×œ××§×¡×œ</button>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-box">
            <div class="modal-head">
                <h2 id="modalTitle">×›×¨×˜×™×¡ ×œ×§×•×—</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn-icon" onclick="printClient()"><i class="fa-solid fa-print"></i></button>
                    <button class="btn-icon" onclick="closeModal()"><i class="fa-solid fa-times"></i></button>
                </div>
            </div>
            <div class="modal-content">
                <input type="hidden" id="editId">
                
                <div class="tabs">
                    <div class="tab active" onclick="switchTab(this, 't1')">×¤×¨×˜×™× ××™×©×™×™×</div>
                    <div class="tab" onclick="switchTab(this, 't2')">××©×¤×—×” ×•×™×œ×“×™×</div>
                    <div class="tab" onclick="switchTab(this, 't3')">×˜×™×¤×•×œ ×•×¡×˜×˜×•×¡</div>
                    <div class="tab" onclick="switchTab(this, 't5')">ğŸ“… ×™×•××Ÿ</div>
                    <div class="tab" onclick="switchTab(this, 't4')">×›×œ×™×</div>
                </div>

                <div id="t1" class="tab-panel active">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                        <div><label>×©× ××œ×</label><input id="inpName"></div>
                        <div><label>×‘×Ÿ/×‘×ª ×–×•×’</label><input id="inpSpouse"></div>
                        <div><label>×˜×œ×¤×•×Ÿ ×¨××©×™</label><input id="inpPhone"></div>
                        <div><label>×˜×œ×¤×•×Ÿ × ×•×¡×£</label><input id="inpPhone2"></div>
                        <div><label>××™××™×™×œ</label><input id="inpEmail"></div>
                        <div><label>×ª.×–</label><input id="inpId"></div>
                        <div style="grid-column:span 2; background:#f8fafc; padding:20px; border-radius:12px; border:1px solid var(--border);">
                            <label style="color:var(--accent); font-weight:bold; margin-bottom:15px; display:block;">××™×“×¢ × ×•×¡×£ (×™×™×‘×•×)</label>
                            <div id="customFields" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px;"></div>
                        </div>
                    </div>
                </div>

                <div id="t2" class="tab-panel">
                    <div id="childrenList"></div>
                    <button class="btn btn-white" onclick="addChildRow()" style="margin-top:15px;">+ ×”×•×¡×£ ×™×œ×“ ×™×“× ×™×ª</button>
                </div>

                <div id="t3" class="tab-panel">
                    <div style="display:flex; gap:20px;">
                        <div style="flex:1"><label>×¡×˜×˜×•×¡</label><select id="inpStatus"><option>×—×“×©</option><option>×‘×˜×™×¤×•×œ</option><option>××•"×</option><option>×—×•×–×”</option><option>×œ× ×¨×œ×•×•× ×˜×™</option></select></div>
                        <div style="flex:1"><label>×ª×§×¦×™×‘</label><input type="number" id="inpBudget"></div>
                    </div>
                    <label>×”×¢×¨×•×ª ×•×”×™×¡×˜×•×¨×™×” (× ×©××¨ ×‘×¢× ×Ÿ)</label>
                    <textarea id="inpNotes" rows="8"></textarea>
                    <button class="btn btn-white btn-sm" onclick="addTimestamp()"><i class="fa-solid fa-clock"></i> ×”×•×¡×£ ×—×•×ª××ª ×–××Ÿ</button>
                </div>

                <div id="t5" class="tab-panel">
                    <div style="background:#eff6ff; padding:15px; border-radius:12px; margin-bottom:15px;">
                        <h4 style="color:var(--accent); margin-bottom:10px;">×§×‘×¢ ×¤×’×™×©×” ×—×“×©×”</h4>
                        <div style="display:flex; gap:10px;">
                            <input type="date" id="meetDate" style="margin:0;">
                            <input type="time" id="meetTime" style="margin:0;">
                            <input type="text" id="meetNote" placeholder="× ×•×©×" style="margin:0;">
                            <button class="btn btn-primary" onclick="addMeeting()">×©×‘×¥</button>
                        </div>
                    </div>
                    <div id="clientMeetingsList"></div>
                </div>

                <div id="t4" class="tab-panel">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                        <div class="card" style="margin:0;">
                            <h4>××—×©×‘×•×Ÿ ××©×›× ×ª×</h4>
                            <input type="number" id="mLoan" placeholder="×¡×›×•× ×”×œ×•×•××”">
                            <div style="font-weight:bold; margin-top:10px;">×”×—×–×¨: <span id="mRes">0</span> â‚ª</div>
                            <button class="btn btn-primary" onclick="calcModal()" style="width:100%; margin-top:10px;">×—×©×‘</button>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:10px; justify-content:center;">
                            <button class="btn btn-white" onclick="sendWhatsapp()"><i class="fa-brands fa-whatsapp" style="color:#25D366;"></i> ×©×œ×— ×•×•××˜×¡××¤</button>
                            <button class="btn btn-white" onclick="sendEmail()"><i class="fa-solid fa-envelope"></i> ×©×œ×— ××™×™×œ</button>
                            <button class="btn btn-white" onclick="genPDF()"><i class="fa-solid fa-file-pdf"></i> ×”×¤×§ ×”×¦×¢×ª ××—×™×¨</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-danger" id="btnDelete" onclick="deleteClient()" style="display:none;">××—×§</button>
                <div style="flex:1"></div>
                <button class="btn btn-white" onclick="closeModal()">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="saveData()">×©××•×¨ ×©×™× ×•×™×™× ×œ×¢× ×Ÿ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // *** ×”××¤×ª×— ×©×œ×š × ××¦× ×›××Ÿ ×‘×¤× ×™× ***
        // ×”×ª×¢×œ× ×××–×”×¨×•×ª ×©×œ GitHub ×œ×’×‘×™ ×©×•×¨×” ×–×•!
        const firebaseConfig = {
            apiKey: "AIzaSyCJvUDVuccEZSuTsUSs7o-hnpME2WaTWio", 
            authDomain: "nadlan-pro.firebaseapp.com",
            projectId: "nadlan-pro",
            storageBucket: "nadlan-pro.firebasestorage.app",
            messagingSenderId: "435010903224",
            appId: "1:435010903224:web:53cc66ba40fa3d4198e84d",
            measurementId: "G-VRX35WJ2PE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let clientsData = {};
        let meetingsData = {};
        let settingsData = { prime: 6.0 };
        let customHeaders = new Set();
        let visibleCols = ['name', 'phone', 'city', 'status', 'budget'];

        // --- ×”×ª×—×‘×¨×•×ª ---
        document.getElementById('btnLogin').addEventListener('click', () => {
            const e = document.getElementById('txtEmail').value;
            const p = document.getElementById('txtPass').value;
            document.getElementById('btnLogin').innerText = "××ª×—×‘×¨...";
            signInWithEmailAndPassword(auth, e, p).catch(err => {
                document.getElementById('btnLogin').innerText = "×”×ª×—×‘×¨";
                document.getElementById('loginError').innerText = "×©×’×™××”: " + err.message;
            });
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('lblUser').innerText = user.email.split('@')[0];
                initData();
                document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('he-IL', {weekday:'long', day:'numeric', month:'long'});
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        window.doLogout = () => signOut(auth);

        // --- ×¡× ×›×¨×•×Ÿ × ×ª×•× ×™× ---
        function initData() {
            onValue(ref(db, 'clients'), snap => {
                clientsData = snap.val() || {};
                Object.values(clientsData).forEach(c => {
                    if(c.customData) Object.keys(c.customData).forEach(k => customHeaders.add(k));
                });
                renderTable();
                updateStats();
                updateFeed();
            }, (error) => {
                console.error("Firebase Error:", error);
                document.getElementById('liveFeed').innerHTML = `<div style="color:red">×©×’×™××ª ×¨×©×ª. ×•×•×“× ×©×¢×“×›× ×ª Rules ×‘××¡×•×£ ×©×œ ×¤×™×™×¨×‘×™×™×¡.</div>`;
            });

            onValue(ref(db, 'meetings'), snap => {
                meetingsData = snap.val() || {};
                if(document.getElementById('calendar').style.display === 'block') renderCalendar();
            });

            onValue(ref(db, 'settings'), snap => {
                const val = snap.val();
                if(val) {
                    settingsData = val;
                    if(document.getElementById('setPrime')) document.getElementById('setPrime').value = settingsData.prime;
                }
            });
        }

        // --- ×™×™×‘×•× ××§×¡×œ ---
        document.getElementById('excelIn').addEventListener('change', (e) => {
            const r = new FileReader();
            r.onload = ex => {
                const w = XLSX.read(new Uint8Array(ex.target.result), {type:'array'});
                const d = XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]]);
                let count = 0;
                
                d.forEach(row => {
                    const c = {
                        name: (row['×©× ××©×¤×—×”']||'') + ' ' + (row['×©× ×¤×¨×˜×™ - ×‘×¢×œ']||row['×©× ×¤×¨×˜×™']||row['×©×']||''),
                        spouse: row['×©× ×¤×¨×˜×™ - ××©×”'] || row['×©× ×¤×¨×˜×™ - ××™×©×”'] || '',
                        phone: String(row['×¤×œ××¤×•×Ÿ - ×‘×¢×œ']||row['× ×™×™×“']||row['×˜×œ×¤×•×Ÿ']||'').replace(/\D/g,''),
                        phone2: String(row['×¤×œ××¤×•×Ÿ - ××©×”']||row['×˜×œ×¤×•×Ÿ 2']||'').replace(/\D/g,''),
                        email: row['××™×™×œ'] || row['×“×•×"×œ'] || '',
                        idNum: row['×ª.×–. - ×‘×¢×œ'] || row['×ª.×–'] || '',
                        city: row['×¢×™×¨'] || '',
                        status: '×—×“×©',
                        lastUpdate: Date.now(),
                        agent: currentUser.email,
                        children: [],
                        customData: {}
                    };

                    for(let [k,v] of Object.entries(row)) {
                        if(!v) continue;
                        if(k.includes('×™×œ×“') || k.includes('×©× ×”×™×œ×“')) {
                            let num = k.replace(/\D/g,'');
                            c.children.push({name:v, id: row[`×ª. ×–×”×•×ª${num||''}`]||''});
                        } else if(!['×©× ××©×¤×—×”','×©× ×¤×¨×˜×™','× ×™×™×“','×˜×œ×¤×•×Ÿ','×¤×œ××¤×•×Ÿ','××™×™×œ','×ª.×–','×¢×™×¨'].some(x=>k.includes(x))) {
                            c.customData[k] = v;
                        }
                    }

                    if(c.phone) {
                        push(ref(db, 'clients'), c);
                        count++;
                    }
                });
                alert('×”×•×¢×œ×• ×œ×¢× ×Ÿ ' + count + ' ×œ×§×•×—×•×ª!');
            };
            r.readAsArrayBuffer(e.target.files[0]);
        });

        // --- ×œ×•×’×™×§×” ×•×××©×§ ---
        
        window.nav = (p) => {
            const pageEl = document.getElementById(p);
            if (!pageEl) {
                alert("×”×¢××•×“ ×˜×¨× ×¤×•×ª×—");
                return;
            }
            document.querySelectorAll('.page').forEach(x => x.style.display='none');
            pageEl.style.display='block';
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            if (event && event.currentTarget) event.currentTarget.classList.add('active');
            if(p==='calendar') renderCalendar();
        }

        window.renderTable = () => {
            const tbody = document.getElementById('tableBody');
            const thead = document.getElementById('tableHead');
            const search = document.getElementById('searchBox').value.toLowerCase();
            const filter = document.getElementById('filterStat').value;
            
            let cols = ['name', 'phone', 'status', 'city'];
            visibleCols.forEach(c => { if(!cols.includes(c)) cols.push(c); });
            thead.innerHTML = `<tr>${cols.map(colName).map(x=>`<th>${x}</th>`).join('')}<th>×¤×¢×•×œ×•×ª</th></tr>`;
            tbody.innerHTML = '';

            Object.entries(clientsData).forEach(([key, c]) => {
                if (filter && c.status !== filter) return;
                const txt = (c.name + c.phone + c.idNum + Object.values(c.customData||{}).join(' ')).toLowerCase();
                if (search && !txt.includes(search)) return;

                const tr = document.createElement('tr');
                tr.onclick = (e) => { if(e.target.tagName!=='BUTTON') window.editClient(key); };
                
                let html = '';
                cols.forEach(col => {
                    let v = '-';
                    if(col==='name') v = `<b>${c.name}</b><br><small style="opacity:0.7">${c.spouse||''}</small>`;
                    else if(col==='phone') v = c.phone;
                    else if(col==='status') v = `<span class="badge" style="background:${stColor(c.status)}">${c.status}</span>`;
                    else if(c[col]) v = c[col];
                    else if(c.customData && c.customData[col]) v = c.customData[col];
                    html += `<td>${v}</td>`;
                });
                
                html += `<td><button class="btn-icon" onclick="editClient('${key}')"><i class="fa-solid fa-pen"></i></button></td>`;
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        };

        window.editClient = (id) => {
            const c = clientsData[id];
            document.getElementById('editId').value = id;
            document.getElementById('inpName').value = c.name;
            document.getElementById('inpSpouse').value = c.spouse || '';
            document.getElementById('inpPhone').value = c.phone;
            document.getElementById('inpPhone2').value = c.phone2 || '';
            document.getElementById('inpEmail').value = c.email || '';
            document.getElementById('inpId').value = c.idNum || '';
            document.getElementById('inpStatus').value = c.status;
            document.getElementById('inpBudget').value = c.budget || '';
            document.getElementById('inpNotes').value = c.notes || '';
            
            document.getElementById('childrenList').innerHTML = '';
            if(c.children) c.children.forEach(k => window.addChildRow(k.name, k.id));
            
            const cfDiv = document.getElementById('customFields');
            cfDiv.innerHTML = '';
            customHeaders.forEach(k => {
                const val = (c.customData && c.customData[k]) ? c.customData[k] : '';
                cfDiv.innerHTML += `<div><label style="font-size:11px;">${k}</label><input class="cf-inp" data-key="${k}" value="${val}"></div>`;
            });

            renderClientMeetings(id);
            document.getElementById('btnDelete').style.display = 'block';
            document.getElementById('modal').style.display = 'flex';
        };

        window.openModal = () => {
            document.getElementById('editId').value = '';
            document.getElementById('inpName').value = '';
            document.getElementById('inpSpouse').value = '';
            document.getElementById('inpPhone').value = '';
            document.getElementById('inpPhone2').value = '';
            document.getElementById('inpEmail').value = '';
            document.getElementById('inpId').value = '';
            document.getElementById('inpBudget').value = '';
            document.getElementById('inpNotes').value = '';
            
            document.getElementById('childrenList').innerHTML = '';
            document.getElementById('customFields').innerHTML = '';
            document.getElementById('clientMeetingsList').innerHTML = '';
            customHeaders.forEach(k => {
                document.getElementById('customFields').innerHTML += `<div><label style="font-size:11px;">${k}</label><input class="cf-inp" data-key="${k}"></div>`;
            });
            document.getElementById('btnDelete').style.display = 'none';
            document.getElementById('modal').style.display = 'flex';
        }

        window.closeModal = () => document.getElementById('modal').style.display = 'none';

        window.saveData = () => {
            const id = document.getElementById('editId').value;
            const c = {
                name: document.getElementById('inpName').value,
                spouse: document.getElementById('inpSpouse').value,
                phone: document.getElementById('inpPhone').value,
                phone2: document.getElementById('inpPhone2').value,
                email: document.getElementById('inpEmail').value,
                idNum: document.getElementById('inpId').value,
                status: document.getElementById('inpStatus').value,
                budget: document.getElementById('inpBudget').value,
                notes: document.getElementById('inpNotes').value,
                lastUpdate: Date.now(),
                agent: currentUser.email,
                children: [],
                customData: {}
            };

            document.querySelectorAll('.cr').forEach(r => {
                c.children.push({name: r.querySelector('.cn').value, id: r.querySelector('.ci').value});
            });
            
            document.querySelectorAll('.cf-inp').forEach(i => {
                c.customData[i.dataset.key] = i.value;
            });

            if(id) update(ref(db, 'clients/'+id), c);
            else push(ref(db, 'clients'), c);
            
            if(c.status === '×—×•×–×”') confetti();
            closeModal();
        };

        window.deleteClient = () => {
            const id = document.getElementById('editId').value;
            if(confirm('×œ××—×•×§ ×œ×¦××™×ª×•×ª ××”×¢× ×Ÿ?')) {
                remove(ref(db, 'clients/'+id));
                closeModal();
            }
        };

        // --- ×™×•××Ÿ ×¤×’×™×©×•×ª ---
        window.addMeeting = () => {
            const date = document.getElementById('meetDate').value;
            const time = document.getElementById('meetTime').value;
            const note = document.getElementById('meetNote').value;
            const cid = document.getElementById('editId').value;
            if(!date || !time) return;
            
            push(ref(db, 'meetings'), {
                clientId: cid,
                clientName: document.getElementById('inpName').value,
                date: date,
                time: time,
                note: note,
                agent: currentUser.email
            });
            alert('×”×¤×’×™×©×” × ×©××¨×” ×‘×¢× ×Ÿ!');
        };

        function renderClientMeetings(cid) {
            const div = document.getElementById('clientMeetingsList');
            div.innerHTML = '';
            Object.entries(meetingsData).forEach(([mid, m]) => {
                if(m.clientId === cid) {
                    div.innerHTML += `<div class="meet-row"><span>${m.date} ${m.time} - ${m.note}</span><button class="btn-icon" onclick="deleteMeeting('${mid}')">&times;</button></div>`;
                }
            });
        }

        window.renderCalendar = () => {
            const div = document.getElementById('calendarList');
            div.innerHTML = '';
            const sorted = Object.entries(meetingsData).sort((a,b) => (a[1].date+a[1].time).localeCompare(b[1].date+b[1].time));
            if(sorted.length === 0) div.innerHTML = '<p style="padding:20px; text-align:center;">××™×Ÿ ×¤×’×™×©×•×ª ×‘×™×•××Ÿ</p>';
            
            sorted.forEach(([mid, m]) => {
                div.innerHTML += `
                <div class="meet-row" style="background:var(--surface); border:1px solid var(--border);">
                    <div style="min-width:100px; font-weight:bold; color:var(--primary); text-align:center;">
                        ${new Date(m.date).toLocaleDateString()}<br>${m.time}
                    </div>
                    <div style="flex:1; padding:0 20px;">
                        <div style="font-weight:bold;">${m.clientName}</div>
                        <div style="color:var(--text-muted); font-size:13px;">${m.note}</div>
                        <div style="font-size:11px; color:var(--accent);">${m.agent}</div>
                    </div>
                    <button class="btn-white btn-sm" onclick="editClient('${m.clientId}')">×œ×ª×™×§</button>
                </div>`;
            });
        };

        window.deleteMeeting = (mid) => {
            if(confirm('×œ××—×•×§ ×¤×’×™×©×”?')) remove(ref(db, 'meetings/'+mid));
        };

        // --- ×¢×–×¨×™× ×•×©×•× ×•×ª ---
        
        window.saveSettings = () => {
            const prime = document.getElementById('setPrime').value;
            update(ref(db, 'settings'), { prime: prime })
                .then(() => alert('×”×’×“×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”!'))
                .catch(err => alert('×©×’×™××”: ' + err.message));
        };

        window.addChildRow = (n='', i='') => {
            document.getElementById('childrenList').innerHTML += `<div class="cr" style="display:flex; gap:5px; margin-bottom:5px;"><input class="cn" value="${n}" placeholder="×©×"><input class="ci" value="${i}" placeholder="×ª.×–"><button type="button" class="btn-icon" onclick="this.parentElement.remove()">&times;</button></div>`;
        }
        
        window.addTimestamp = () => {
            const t = document.getElementById('inpNotes');
            t.value = `[${new Date().toLocaleString()}] ` + t.value;
        }

        window.quickCalc = () => {
            const p = Number(document.getElementById('qLoan').value);
            const currentPrime = Number(settingsData.prime || 6.0);
            const spread = Number(document.getElementById('qSpread').value);
            const r = (currentPrime + spread)/100/12; 
            const n = Number(document.getElementById('qYears').value)*12;
            const res = p*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1);
            document.getElementById('qRes').innerText = Math.round(res).toLocaleString() + ' â‚ª';
        }

        window.toggleColsMenu = () => {
            const m = document.getElementById('colsMenu');
            if(m.style.display==='block') { m.style.display='none'; return; }
            m.innerHTML = '';
            ['city','email','status','phone','budget'].forEach(k => {
                m.innerHTML += `<label><input type="checkbox" onchange="toggleCol('${k}')" ${visibleCols.includes(k)?'checked':''}> ${colName(k)}</label>`;
            });
            customHeaders.forEach(k => {
                m.innerHTML += `<label><input type="checkbox" onchange="toggleCol('${k}')" ${visibleCols.includes(k)?'checked':''}> ${k}</label>`;
            });
            m.style.display='block';
        }

        window.toggleCol = (k) => {
            const i = visibleCols.indexOf(k);
            if(i>-1) visibleCols.splice(i,1); else visibleCols.push(k);
            renderTable();
        }

        function updateStats() {
            const arr = Object.values(clientsData);
            document.getElementById('stTotal').innerText = arr.length;
            document.getElementById('stActive').innerText = arr.filter(c => ['×‘×˜×™×¤×•×œ','××•"×'].includes(c.status)).length;
            document.getElementById('stDeals').innerText = arr.filter(c => c.status==='×—×•×–×”').length;
        }

        function updateFeed() {
            const arr = Object.values(clientsData).sort((a,b) => b.lastUpdate - a.lastUpdate).slice(0,5);
            document.getElementById('liveFeed').innerHTML = arr.map(c => `<div>â° <b>${c.name}</b> ×¢×•×“×›×Ÿ ×œ-${c.status} ×¢"×™ ${c.agent||'?'}</div>`).join('');
        }

        function colName(k) { const m={name:'×œ×§×•×—', phone:'×˜×œ×¤×•×Ÿ', status:'×¡×˜×˜×•×¡', city:'×¢×™×¨', email:'××™×™×œ', budget:'×ª×§×¦×™×‘'}; return m[k]||k; }
        function stColor(s) { if(s==='×—×“×©') return '#e2e8f0'; if(s==='××•"×') return '#fde047'; if(s==='×—×•×–×”') return '#86efac'; return 'white'; }
        
        window.switchTab = (el, id) => {
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(x=>x.classList.remove('active'));
            el.classList.add('active');
            document.getElementById(id).classList.add('active');
        }
        
        window.toggleTheme = () => {
            const t = document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
            document.documentElement.setAttribute('data-theme', t);
        }
        
        window.exportExcel = () => {
            const ws = XLSX.utils.json_to_sheet(Object.values(clientsData).map(c=>({...c, children:JSON.stringify(c.children)})));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Clients");
            XLSX.writeFile(wb, "Nadlan_Cloud_Backup.xlsx");
        }
        
        window.calcModal = () => {
             const p = Number(document.getElementById('mLoan').value);
             const r = 0.065/12;
             const n = 300;
             const res = p*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1);
             document.getElementById('mRes').innerText = Math.round(res).toLocaleString();
        }
        
        window.sendWhatsapp = () => window.open(`https://wa.me/972${document.getElementById('inpPhone').value.replace('0','')}`);
        window.sendEmail = () => window.location.href=`mailto:${document.getElementById('inpEmail').value}`;
        window.genPDF = () => {
            const el = document.createElement('div');
            el.innerHTML = `<h1>×”×¦×¢×ª ××—×™×¨</h1><h2>${document.getElementById('inpName').value}</h2><p>${document.getElementById('inpNotes').value}</p>`;
            html2pdf(el);
        }
    </script>
</body>
</html>
